<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>10.&nbsp;Spring AOP APIs</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Framework Reference Documentation"><link rel="up" href="spring-core.html" title="Part&nbsp;III.&nbsp;&#26680;&#24515;&#25216;&#26415;"><link rel="prev" href="aop.html" title="9.&nbsp;Aspect Oriented Programming with Spring"><link rel="next" href="spring-data-tier.html" title="Part&nbsp;IV.&nbsp;&#25968;&#25454;&#35775;&#38382;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.&nbsp;Spring AOP APIs</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="aop.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;III.&nbsp;&#26680;&#24515;&#25216;&#26415;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="spring-data-tier.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="aop-api" href="#aop-api"></a>10.&nbsp;Spring AOP APIs</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-introduction" href="#aop-api-introduction"></a>10.1&nbsp;Introduction</h2></div></div></div>

<p>The previous chapter described the Spring&#8217;s support for AOP using
@AspectJ and schema-based aspect definitions. In this chapter we discuss the lower-level
Spring AOP APIs and the AOP support used in Spring 1.2 applications. For new
applications, we recommend the use of the Spring 2.0 and later AOP support described in
the previous chapter, but when working with existing applications, or when reading books
and articles, you may come across Spring 1.2 style examples. Spring 4.0 is backwards
compatible with Spring 1.2 and everything described in this chapter is fully supported
in Spring 4.0.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-pointcuts" href="#aop-api-pointcuts"></a>10.2&nbsp;Pointcut API in Spring</h2></div></div></div>

<p>Let&#8217;s look at how Spring handles the crucial pointcut concept.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-concepts" href="#aop-api-concepts"></a>10.2.1&nbsp;Concepts</h3></div></div></div>

<p>Spring&#8217;s pointcut model enables pointcut reuse independent of advice types. It&#8217;s
possible to target different advice using the same pointcut.</p>
<p>The <code class="literal">org.springframework.aop.Pointcut</code> interface is the central interface, used to
target advices to particular classes and methods. The complete interface is shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Pointcut {

    ClassFilter getClassFilter();

    MethodMatcher getMethodMatcher();

}</pre>

<p>Splitting the <code class="literal">Pointcut</code> interface into two parts allows reuse of class and method
matching parts, and fine-grained composition operations (such as performing a "union"
with another method matcher).</p>
<p>The <code class="literal">ClassFilter</code> interface is used to restrict the pointcut to a given set of target
classes. If the <code class="literal">matches()</code> method always returns true, all target classes will be
matched:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ClassFilter {

    <span class="hl-keyword">boolean</span> matches(Class clazz);
}</pre>

<p>The <code class="literal">MethodMatcher</code> interface is normally more important. The complete interface is
shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodMatcher {

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass);

    <span class="hl-keyword">boolean</span> isRuntime();

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass, Object[] args);
}</pre>

<p>The <code class="literal">matches(Method, Class)</code> method is used to test whether this pointcut will ever
match a given method on a target class. This evaluation can be performed when an AOP
proxy is created, to avoid the need for a test on every method invocation. If the
2-argument matches method returns true for a given method, and the <code class="literal">isRuntime()</code> method
for the MethodMatcher returns true, the 3-argument matches method will be invoked on
every method invocation. This enables a pointcut to look at the arguments passed to the
method invocation immediately before the target advice is to execute.</p>
<p>Most MethodMatchers are static, meaning that their <code class="literal">isRuntime()</code> method returns false.
In this case, the 3-argument matches method will never be invoked.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If possible, try to make pointcuts static, allowing the AOP framework to cache the
results of pointcut evaluation when an AOP proxy is created.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcut-ops" href="#aop-api-pointcut-ops"></a>10.2.2&nbsp;Operations on pointcuts</h3></div></div></div>

<p>Spring supports operations on pointcuts: notably, <span class="emphasis"><em>union</em></span> and <span class="emphasis"><em>intersection</em></span>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Union means the methods that either pointcut matches.
</li><li class="listitem">
Intersection means the methods that both pointcuts match.
</li><li class="listitem">
Union is usually more useful.
</li><li class="listitem">
Pointcuts can be composed using the static methods in the
<span class="emphasis"><em>org.springframework.aop.support.Pointcuts</em></span> class, or using the
<span class="emphasis"><em>ComposablePointcut</em></span> class in the same package. However, using AspectJ pointcut
expressions is usually a simpler approach.
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-aspectj" href="#aop-api-pointcuts-aspectj"></a>10.2.3&nbsp;AspectJ expression pointcuts</h3></div></div></div>

<p>Since 2.0, the most important type of pointcut used by Spring is
<code class="literal">org.springframework.aop.aspectj.AspectJExpressionPointcut</code>. This is a pointcut that
uses an AspectJ supplied library to parse an AspectJ pointcut expression string.</p>
<p>See the previous chapter for a discussion of supported AspectJ pointcut primitives.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-impls" href="#aop-api-pointcuts-impls"></a>10.2.4&nbsp;Convenience pointcut implementations</h3></div></div></div>

<p>Spring provides several convenient pointcut implementations. Some can be used out of the
box; others are intended to be subclassed in application-specific pointcuts.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-pointcuts-static" href="#aop-api-pointcuts-static"></a>Static pointcuts</h4></div></div></div>

<p>Static pointcuts are based on method and target class, and cannot take into account the
method&#8217;s arguments. Static pointcuts are sufficient - <span class="emphasis"><em>and best</em></span> - for most usages.
It&#8217;s possible for Spring to evaluate a static pointcut only once, when a method is first
invoked: after that, there is no need to evaluate the pointcut again with each method
invocation.</p>
<p>Let&#8217;s consider some static pointcut implementations included with Spring.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-regex" href="#aop-api-pointcuts-regex"></a>Regular expression pointcuts</h5></div></div></div>

<p>One obvious way to specify static pointcuts is regular expressions. Several AOP
frameworks besides Spring make this possible.
<code class="literal">org.springframework.aop.support.JdkRegexpMethodPointcut</code> is a generic regular
expression pointcut, using the regular expression support in JDK 1.4+.</p>
<p>Using the <code class="literal">JdkRegexpMethodPointcut</code> class, you can provide a list of pattern Strings. If
any of these is a match, the pointcut will evaluate to true. (So the result is
effectively the union of these pointcuts.)</p>
<p>The usage is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulatePointcut"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.JdkRegexpMethodPointcut"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*set.*<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Spring provides a convenience class, <code class="literal">RegexpMethodPointcutAdvisor</code>, that allows us to
also reference an Advice (remember that an Advice can be an interceptor, before advice,
throws advice etc.). Behind the scenes, Spring will use a <code class="literal">JdkRegexpMethodPointcut</code>.
Using <code class="literal">RegexpMethodPointcutAdvisor</code> simplifies wiring, as the one bean encapsulates both
pointcut and advice, as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulateAdvisor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.RegexpMethodPointcutAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"advice"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"beanNameOfAopAllianceInterceptor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*set.*<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p><span class="emphasis"><em>RegexpMethodPointcutAdvisor</em></span> can be used with any Advice type.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-attribute-driven" href="#aop-api-pointcuts-attribute-driven"></a>Attribute-driven pointcuts</h5></div></div></div>

<p>An important type of static pointcut is a <span class="emphasis"><em>metadata-driven</em></span> pointcut. This uses the
values of metadata attributes: typically, source-level metadata.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-pointcuts-dynamic" href="#aop-api-pointcuts-dynamic"></a>Dynamic pointcuts</h4></div></div></div>

<p>Dynamic pointcuts are costlier to evaluate than static pointcuts. They take into account
method <span class="emphasis"><em>arguments</em></span>, as well as static information. This means that they must be
evaluated with every method invocation; the result cannot be cached, as arguments will
vary.</p>
<p>The main example is the <code class="literal">control flow</code> pointcut.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-cflow" href="#aop-api-pointcuts-cflow"></a>Control flow pointcuts</h5></div></div></div>

<p>Spring control flow pointcuts are conceptually similar to AspectJ <span class="emphasis"><em>cflow</em></span> pointcuts,
although less powerful. (There is currently no way to specify that a pointcut executes
below a join point matched by another pointcut.) A control flow pointcut matches the
current call stack. For example, it might fire if the join point was invoked by a method
in the <code class="literal">com.mycompany.web</code> package, or by the <code class="literal">SomeCaller</code> class. Control flow pointcuts
are specified using the <code class="literal">org.springframework.aop.support.ControlFlowPointcut</code> class.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Control flow pointcuts are significantly more expensive to evaluate at runtime than even
other dynamic pointcuts. In Java 1.4, the cost is about 5 times that of other dynamic
pointcuts.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-superclasses" href="#aop-api-pointcuts-superclasses"></a>10.2.5&nbsp;Pointcut superclasses</h3></div></div></div>

<p>Spring provides useful pointcut superclasses to help you to implement your own pointcuts.</p>
<p>Because static pointcuts are most useful, you&#8217;ll probably subclass
StaticMethodMatcherPointcut, as shown below. This requires implementing just one
abstract method (although it&#8217;s possible to override other methods to customize behavior):</p>
<pre class="programlisting"><span class="hl-keyword">class</span> TestStaticPointcut <span class="hl-keyword">extends</span> StaticMethodMatcherPointcut {

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass) {
        <span class="hl-comment">// return true if custom criteria match</span>
    }
}</pre>

<p>There are also superclasses for dynamic pointcuts.</p>
<p>You can use custom pointcuts with any advice type in Spring 1.0 RC2 and above.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-custom" href="#aop-api-pointcuts-custom"></a>10.2.6&nbsp;Custom pointcuts</h3></div></div></div>

<p>Because pointcuts in Spring AOP are Java classes, rather than language features (as in
AspectJ) it&#8217;s possible to declare custom pointcuts, whether static or dynamic. Custom
pointcuts in Spring can be arbitrarily complex. However, using the AspectJ pointcut
expression language is recommended if possible.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Later versions of Spring may offer support for "semantic pointcuts" as offered by JAC:
for example, "all methods that change instance variables in the target object."</p>
</td></tr></table></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advice" href="#aop-api-advice"></a>10.3&nbsp;Advice API in Spring</h2></div></div></div>

<p>Let&#8217;s now look at how Spring AOP handles advice.
&#35753;&#25105;&#20204;&#30475;&#30475; Spring AOP &#26159;&#24590;&#20040;&#22788;&#29702; advice&#30340;</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-advice-lifecycle" href="#aop-api-advice-lifecycle"></a>10.3.1&nbsp;Advice lifecycles Advice &#29983;&#21629;&#21608;&#26399;</h3></div></div></div>

<p>Each advice is a Spring bean. An advice instance can be shared across all advised
objects, or unique to each advised object. This corresponds to <span class="emphasis"><em>per-class</em></span> or
<span class="emphasis"><em>per-instance</em></span> advice.</p>
<p>&#27599;&#20010;Advice&#37117;&#26159;Spring&#37324;&#38754;&#30340; Bean&#12290;
Advice&#26377;2&#31181;&#65306; &#31532;&#19968;&#31181;&#21483; <span class="emphasis"><em>per-class</em></span> Advice &#27492; Advice&#30340;&#23454;&#20363;&#22312;&#25152;&#26377;&#30340;&#30446;&#26631;&#23545;&#35937;&#30340;&#23454;&#20363;&#20013;&#20849;&#20139;&#12290;
&#31532;&#20108;&#31181;&#21483;  <span class="emphasis"><em>per-instance</em></span> Advice  &#27492; Advice&#30340;&#23454;&#20363;&#22312;&#27599;&#20010;&#30446;&#26631;&#23545;&#35937;&#30340;&#23454;&#20363;&#20013;&#21807;&#19968;&#19981;&#33021;&#20849;&#20139;&#12290;</p>
<p>Per-class advice is used most often. It is appropriate for generic advice such as
transaction advisors. These do not depend on the state of the proxied object or add new
state; they merely act on the method and arguments.</p>
<p>Per-class Advice &#29992;&#30340;&#26368;&#22810;&#12290; &#23427;&#36866;&#21512;&#29992;&#26469;&#20570;&#36890;&#29992;&#30340;Advice&#20363;&#22914;&#20107;&#29289;&#31649;&#29702;&#30340;Advice&#65292;
&#23427;&#19981;&#20250;&#20026;&#20195;&#29702;&#30340;&#30446;&#26631;&#23545;&#35937;&#20445;&#23384;&#29366;&#24577;&#21644;&#28155;&#21152;&#29366;&#24577;&#65292;&#20182;&#20204;&#20165;&#20165;&#36866;&#29992;&#20110;&#26041;&#27861;&#21644;&#21442;&#25968;&#30340;&#25318;&#25130;&#12290;</p>
<p>Per-instance advice is appropriate for introductions, to support mixins. In this case,
the advice adds state to the proxied object.</p>
<p>Per-instance advice &#36866;&#21512;&#20570;&#20171;&#32461;&#65292;&#25903;&#25345;&#34701;&#21512;&#65288;&#28151;&#21512;&#65289;&#12290;&#22312;&#36825;&#31181;&#24773;&#20917;&#19979;&#65292;&#20182;&#20026;&#20195;&#29702;&#23545;&#35937;&#28155;&#21152;&#29366;&#24577;&#12290;</p>
<p>It&#8217;s possible to use a mix of shared and per-instance advice in the same AOP proxy.
&#22312;&#30456;&#21516;&#30340;AOP&#20195;&#29702;&#20013;&#21487;&#20197;&#28151;&#29992; per-class advice &#21644; per-instance advice</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-advice-types" href="#aop-api-advice-types"></a>10.3.2&nbsp;Advice types in Spring</h3></div></div></div>


<pre class="literallayout">Spring Advice&#30340;&#31867;&#22411;</pre>

<p>Spring provides several advice types out of the box, and is extensible to support
arbitrary advice types. Let us look at the basic concepts and standard advice types.</p>
<p>Spring &#25552;&#20379;&#20102;&#19968;&#20123;&#24320;&#31665;&#21363;&#29992;&#30340;advice&#31867;&#22411;&#65292;&#24182;&#19988;&#36890;&#36807;&#25193;&#23637;&#21487;&#20197;&#25903;&#25345;&#20219;&#24847;&#30340;advice&#31867;&#22411;&#12290;&#35753;&#25105;&#20204;&#30475;&#30475;&#22522;&#26412;&#27010;&#24565;&#21644;&#26631;&#20934;&#30340;advice&#31867;&#22411;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-around" href="#aop-api-advice-around"></a>Interception around advice  &#25318;&#25130; around Advice</h4></div></div></div>

<p>The most fundamental advice type in Spring is <span class="emphasis"><em>interception around advice</em></span>.
&#22312;Spring &#20013;&#26368;&#22522;&#26412;&#30340;advice &#31867;&#22411;&#26159; __&#25318;&#25130; around Advice</p>
<p>Spring is compliant with the AOP Alliance interface for around advice using method
interception. MethodInterceptors implementing around advice should implement the
following interface:</p>
<p>Spring &#29992; around Adivice &#26469;&#26381;&#20174; AOP&#32852;&#30431;&#30340;&#25509;&#21475;&#12290;&#26041;&#27861;&#25318;&#25130;&#22120; &#23454;&#29616; around advice &#38656;&#35201;&#23454;&#29616;&#20197;&#19979;&#25509;&#21475;&#65306;</p>
<p>7&#26376;3&#21495;&#24320;&#22987;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodInterceptor <span class="hl-keyword">extends</span> Interceptor {

    Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>The <code class="literal">MethodInvocation</code> argument to the <code class="literal">invoke()</code> method exposes the method being
invoked; the target join point; the AOP proxy; and the arguments to the method. The
<code class="literal">invoke()</code> method should return the invocation&#8217;s result: the return value of the join
point.
<code class="literal">invoke()</code> &#26041;&#27861;&#30340;&#21442;&#25968;  <code class="literal">MethodInvocation</code>  &#22312;&#34987;&#35843;&#29992;&#30340;&#26102;&#20505;&#26292;&#28431; &#26041;&#27861;&#65307;&#30446;&#26631;&#20999;&#20837;&#28857;&#65307;AOP&#20195;&#29702;&#65307;&#21644;&#21442;&#25968;&#32473;&#36825;&#20010;&#26041;&#27861;&#12290;
<code class="literal">invoke()</code>&#26041;&#27861;&#38656;&#35201;&#36820;&#22238;&#35843;&#29992;&#32773;&#30340;&#32467;&#26524;&#65306;&#36820;&#22238;&#20999;&#20837;&#28857;&#30340;&#20540;</p>
<p>A simple <code class="literal">MethodInterceptor</code> implementation looks as follows:
&#19979;&#38754;&#26159;&#19968;&#20010;&#31616;&#21333;&#30340;<code class="literal">MethodInterceptor</code>&#30340;&#23454;&#29616;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DebugInterceptor <span class="hl-keyword">implements</span> MethodInterceptor {

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        System.out.println(<span class="hl-string">"Before: invocation=["</span> + invocation + <span class="hl-string">"]"</span>);
        Object rval = invocation.proceed();
        System.out.println(<span class="hl-string">"Invocation returned"</span>);
        <span class="hl-keyword">return</span> rval;
    }
}</pre>

<p>Note the call to the MethodInvocation&#8217;s <code class="literal">proceed()</code> method. This proceeds down the
interceptor chain towards the join point. Most interceptors will invoke this method, and
return its return value. However, a MethodInterceptor, like any around advice, can
return a different value or throw an exception rather than invoke the proceed method.
However, you don&#8217;t want to do this without good reason!</p>
<p>&#27880;&#24847;MethodInvocation&#35843;&#29992;&#30340;<code class="literal">proceed()</code> &#26041;&#27861;&#12290;&#36825;&#20123;procee&#26041;&#27861;&#22312;&#36825;&#20010;&#21152;&#20837;&#28857;&#19978;&#20987;&#36133;&#25318;&#25130;&#22120;&#38142;&#65288; &#36825;&#20123;procee&#26041;&#27861;&#22312;&#21152;&#20837;&#28857;&#19978;&#35201;&#27604;&#25318;&#25130;&#22120;&#38142;&#35201;&#22909;&#65289;&#12290;
&#22823;&#37096;&#20998;&#25318;&#25130;&#22120;&#20250;&#35843;&#29992;&#36825;&#20010;&#26041;&#27861;&#65292;&#21644;&#36820;&#22238;&#20182;&#30340;&#20540;&#12290;&#28982;&#32780;&#65292;&#20687;&#20219;&#20309;&#30340;around Advice&#19968;&#26679;&#33021;&#22815;&#36820;&#22238;&#19981;&#21516;&#30340;&#20540;&#21644;&#25243;&#20986;&#24322;&#24120;&#32988;&#20110;&#35843;&#29992;&#36825;&#20010; procce&#26041;&#27861;&#12290;
&#28982;&#32780;&#65292;&#38500;&#38750;&#26377;&#26356;&#22909;&#30340;&#29702;&#30001;&#20320;&#24212;&#35813;&#19981;&#24819;&#36825;&#20040;&#20570;&#12290;</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>MethodInterceptors offer interoperability with other AOP Alliance-compliant AOP
implementations. The other advice types discussed in the remainder of this section
implement common AOP concepts, but in a Spring-specific way.
While there is an advantage in using the most specific advice type, stick with MethodInterceptor around advice if
you are likely to want to run the aspect in another AOP framework. Note that pointcuts
are not currently interoperable between frameworks, and the AOP Alliance does not
currently define pointcut interfaces.</p>
<p>&#26041;&#27861;&#25318;&#25130;&#22120;&#25552;&#20379;&#19982;&#20854;&#20182;AOP&#32852;&#30431;&#26631;&#20934;&#30340;AOP&#30340;&#20114;&#25805;&#20316;&#24615;&#23454;&#29616;&#12290;&#26412;&#31456;&#33410;&#30340;&#20854;&#20313;&#37096;&#20998;&#35752;&#35770;&#20854;&#20313;&#30340;advice&#31867;&#22411;&#23454;&#29616;&#20849;&#21516;&#30340;AOP&#27010;&#24565;&#65292;&#20294;&#26159;&#26159;spring&#30340;&#23454;&#29616;&#26041;&#24335;&#12290;</p>
<p>&#34429;&#28982;&#29992;&#26368;&#20855;&#20307;&#30340;advice&#31867;&#22411;&#26377;&#20248;&#21183;&#65292;&#20294;&#26159;&#22914;&#26524;&#20320;&#24819;&#22312;&#21478;&#22806;&#30340;AOP&#26694;&#26550;&#20013;&#36816;&#34892;&#22362;&#25345;&#20351;&#29992; around advice &#26041;&#27861;&#25318;&#25130;&#22120;&#12290;</p>
<p>&#35831;&#27880;&#24847;&#36825;&#20010;&#20999;&#20837;&#28857;&#30446;&#21069;&#22312;&#19981;&#21516;&#26694;&#26550;&#38388;&#19981;&#33021;&#30456;&#20114;&#25805;&#20316;&#65292;AOP&#32852;&#30431;&#30446;&#21069;&#20063;&#19981;&#33021;&#23450;&#20041;&#20999;&#20837;&#28857;&#25509;&#21475;&#12290;</p>
</td></tr></table></div>

<p>7&#26376;4&#21495;&#24320;&#22987;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-before" href="#aop-api-advice-before"></a>Before advice</h4></div></div></div>


<pre class="literallayout"> &#21069;&#32622; Advice
A simpler advice type is a __before advice__. This does not need a `MethodInvocation`
object, since it will only be called before entering the method.
__&#21069;&#32622; Advice &#26159;&#26356;&#31616;&#21333;&#30340; Advice&#12290;&#22240;&#20026;&#23427;&#21482;&#22312;&#36827;&#20837;&#26041;&#27861;&#20043;&#21069;&#35843;&#29992;&#65292;&#25152;&#20197;&#23427;&#19981;&#38656;&#35201;`MethodInvocation` &#23545;&#35937;</pre>

<p>The main advantage of a before advice is that there is no need to invoke the <code class="literal">proceed()</code>
method, and therefore no possibility of inadvertently failing to proceed down the
interceptor chain.</p>
<p>&#21069;&#32622;advice&#30340;&#19968;&#20010;&#20027;&#35201;&#20248;&#21183;&#26159;&#19981;&#38656;&#35201;&#35843;&#29992; <code class="literal">proceed()</code> &#26041;&#27861;&#65292; &#22240;&#27492;&#23427;&#19981;&#21487;&#33021;&#35843;&#29992;&#22833;&#36133; proceed&#26041;&#27861;&#65292;&#22312;&#36825;&#19968;&#28857;&#19978;&#20987;&#36133;&#20102; &#25318;&#25130;&#22120;&#38142;&#12290;</p>
<p>The <code class="literal">MethodBeforeAdvice</code> interface is shown below. (Spring&#8217;s API design would allow for
field before advice, although the usual objects apply to field interception and it&#8217;s
unlikely that Spring will ever implement it).
&#19979;&#38754;&#23637;&#31034;<code class="literal">MethodBeforeAdvice</code> &#25509;&#21475;&#65288;&#23545;&#20110;&#23383;&#27573;&#19978;&#30340;advice&#25318;&#25130;&#22120;&#27604;&#36739;&#24120;&#29992;&#65292;&#34429;&#28982;spring&#22312;&#35774;&#35745;&#19978;&#20063;&#25903;&#25345;&#65292;&#20294;&#26159;spring&#24212;&#35813;&#19981;&#22826;&#21487;&#33021;&#23454;&#29616;&#23427;&#65289;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodBeforeAdvice <span class="hl-keyword">extends</span> BeforeAdvice {

    <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>Note the return type is <code class="literal">void</code>. Before advice can insert custom behavior before the join
point executes, but cannot change the return value.
If a before advice throws an exception, this will abort further execution of the interceptor chain.
The exception will propagate back up the interceptor chain.
If it is unchecked, or on the signature of the invoked method, it will be passed directly to the client;
otherwise it will be wrapped in an unchecked exception by the AOP proxy.
&#27880;&#24847;&#36820;&#22238;&#31867;&#22411;&#26159;<code class="literal">void</code>&#12290;&#21069;&#32622; advice &#21487;&#20197;&#22312;&#21152;&#20837;&#28857;&#20043;&#21069;&#25191;&#34892;&#29992;&#25143;&#30340;&#34892;&#20026;&#65292;&#20294;&#26159;&#19981;&#33021;&#25913;&#21464;&#36820;&#22238;&#20540;&#12290;
&#22914;&#26524;&#19968;&#20010;&#21069;&#32622;advice&#25243;&#20986;&#20102;&#19968;&#20010;&#24322;&#24120;&#65292;&#25318;&#25130;&#22120;&#38142;&#23558;&#19981;&#20250;&#32487;&#32493;&#25191;&#34892;&#12290;&#36825;&#20010;&#24322;&#24120;&#23558;&#20250;&#20256;&#25773;&#22238;&#25318;&#25130;&#22120;&#38142;&#12290;
&#22914;&#26524;&#36825;&#20010;&#24322;&#24120;&#27809;&#26377;&#34987;&#26816;&#26597;&#65292;&#25110;&#32773;&#26631;&#35760;&#30340;&#26041;&#27861;&#34987;&#35843;&#29992;&#26102;&#65292;&#23427;&#23558;&#30452;&#25509;&#20256;&#36882;&#32473;&#23458;&#25143;&#31471;,&#21542;&#21017;&#36825;&#20010;&#24322;&#24120;&#23558;&#20250;&#34987;AOP&#20195;&#29702;&#21253;&#35013;&#25104;&#19968;&#20010;&#26410;&#26816;&#26597;&#24322;&#24120;</p>
<p>An example of a before advice in Spring, which counts all method invocations:
&#19979;&#38754;&#26159;spring&#37324;&#38754;&#30340;&#19968;&#20010;&#21069;&#32622;advice&#20363;&#23376;&#65292;&#23427;&#23558;&#32479;&#35745;&#25152;&#26377;&#30340;&#26041;&#27861;&#35843;&#29992;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingBeforeAdvice <span class="hl-keyword">implements</span> MethodBeforeAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<p>7&#26376;5&#21495;&#24320;&#22987;</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Before advice can be used with any pointcut.
&#21069;&#32622;Advice &#33021;&#22815;&#20351;&#29992;&#22312;&#20219;&#20309;&#30340;&#20999;&#20837;&#28857;</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-throws" href="#aop-api-advice-throws"></a>Throws advice &#25243;&#20986;Advice</h4></div></div></div>

<p><span class="emphasis"><em>Throws advice</em></span> is invoked after the return of the join point if the join point threw
an exception. Spring offers typed throws advice. Note that this means that the
<code class="literal">org.springframework.aop.ThrowsAdvice</code> interface does not contain any methods: It is a
tag interface identifying that the given object implements one or more typed throws
advice methods. These should be in the form of:</p>
<p>&#22914;&#26524;&#19968;&#20010;&#36830;&#25509;&#28857;&#25243;&#20986;&#19968;&#20010;&#24322;&#24120;&#65292;<span class="emphasis"><em>Throws advice</em></span> &#23558;&#20250;&#22312;&#36830;&#25509;&#28857;&#36820;&#22238;&#20043;&#21518;&#35843;&#29992;&#12290;Spring&#25552;&#20379; throws advice &#31867;&#22411;&#12290;
&#35831;&#27880;&#24847;&#36825;&#23601;&#24847;&#21619;&#30528; <code class="literal">org.springframework.aop.ThrowsAdvice</code>&#25509;&#21475;&#19981;&#20250;&#21253;&#21547;&#20219;&#20309;&#26041;&#27861;&#65306;&#23427;&#26159;&#19968;&#20010;&#26631;&#31614;&#65292;&#32473;&#23454;&#29616;&#23427;&#30340;&#23545;&#35937;&#19968;&#20010;&#25110;&#32773;&#22810;&#20010;throws
advice &#26041;&#27861;&#12290;&#36825;&#20123;&#24212;&#35813;&#26159;&#20197;&#19979;&#30340;&#24418;&#24335;</p>
<pre class="programlisting">afterThrowing([Method, args, target], subclassOfThrowable)</pre>

<p>Only the last argument is required. The method signatures may have either one or four
arguments, depending on whether the advice method is interested in the method and
arguments. The following classes are examples of throws advice.
&#21482;&#26377;&#26368;&#21518;&#19968;&#20010;&#21442;&#25968;&#26159;&#24517;&#39035;&#30340;&#12290;&#36825;&#20010;&#26041;&#27861;&#31614;&#21517;&#20250;&#26377;1&#20010;&#25110;&#32773;4&#20010;&#21442;&#25968;&#65292;&#20381;&#36182;&#20110; &#26159;&#21542; &#24314;&#35758;&#30340;&#26041;&#27861; &#22312;&#26041;&#27861;&#25110;&#32773;&#21442;&#25968;&#19978;&#24863;&#20852;&#36259;&#12290;
&#19979;&#38754;&#30340;&#31867;&#26159; throws advice&#30340;&#20363;&#23376;&#65306;</p>
<p>The advice below is invoked if a <code class="literal">RemoteException</code> is thrown (including subclasses):
&#22914;&#26524;<code class="literal">RemoteException</code> &#65288;&#21253;&#25324;&#23376;&#31867;&#65289;&#34987;&#25243;&#20986;&#65292; &#19979;&#38754;&#30340;advice&#23558;&#20250;&#34987;&#35843;&#29992;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RemoteThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }
}</pre>

<p>The following advice is invoked if a <code class="literal">ServletException</code> is thrown. Unlike the above
advice, it declares 4 arguments, so that it has access to the invoked method, method
arguments and target object:
&#22914;&#26524;<code class="literal">ServletException</code>&#34987;&#25243;&#20986; &#21017;&#19979;&#38754;&#30340;advice&#23558;&#20250;&#34987;&#35843;&#29992;&#12290;&#19982;&#19978;&#36848; advice&#19981;&#21516;&#30340;&#26159; &#65292;&#23427;&#23450;&#20041;&#20102;4&#20010;&#21442;&#25968;&#65292;&#22240;&#27492;&#23427;&#21487;&#20197;&#35775;&#38382;&#35843;&#29992;
&#30340;&#26041;&#27861;&#65292;&#26041;&#27861;&#21442;&#25968;&#21644;&#30446;&#26631;&#23545;&#35937;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServletThrowsAdviceWithArguments <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<p>7&#26376;6&#21495;&#24320;&#22987;</p>
<p>The final example illustrates how these two methods could be used in a single class,
which handles both <code class="literal">RemoteException</code> and <code class="literal">ServletException</code>. Any number of throws advice
methods can be combined in a single class.
&#26368;&#21518;&#30340;&#20363;&#23376;&#35828;&#26126;&#20102;2&#20010;&#26041;&#27861;&#21487;&#20197;&#29992;&#21040;&#19968;&#20010;&#31867;&#20013;&#65292;&#22788;&#29702;<code class="literal">RemoteException</code> &#21644; <code class="literal">ServletException</code>&#12290;
&#20219;&#20309;&#25968;&#30446;&#30340; throws advice&#26041;&#27861;&#33021;&#22815;&#22312;&#19968;&#20010;&#31867;&#20013;&#32467;&#21512;&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> CombinedThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a throws-advice method throws an exception itself, it will override the
original exception (i.e. change the exception thrown to the user). The overriding
exception will typically be a RuntimeException; this is compatible with any method
signature.
However, if a throws-advice method throws a checked exception, it will have
to match the declared exceptions of the target method and is hence to some degree
coupled to specific target method signatures. <span class="emphasis"><em>Do not throw an undeclared checked
exception that is incompatible with the target method&#8217;s signature!</em></span></p>
<p>&#22914;&#26524;throws-advice&#26041;&#27861;&#33258;&#24049;&#25243;&#20986;&#24322;&#24120;&#65292;&#23427;&#23558;&#20250;&#37325;&#36733;&#21407;&#22987;&#24322;&#24120;&#65288;&#25913;&#21464;&#24322;&#24120;&#25243;&#32473;&#29992;&#25143;&#65289;&#12290;&#36825;&#37325;&#36733;&#30340;&#24322;&#24120;&#26159;&#19968;&#20010;&#20856;&#22411;&#30340;&#36816;&#34892;&#26102;&#24322;&#24120;&#65307;&#36825;&#23558;&#20860;&#23481;&#20219;&#20309;&#30340;&#26041;&#27861;&#31614;&#21517;&#12290;
&#28982;&#32780;&#65292;&#22914;&#26524;throws-advice&#26041;&#27861;&#25243;&#20986;&#19968;&#20010;&#21463;&#26816;&#26597;&#24322;&#24120;&#65292;  &#23427;&#24517;&#39035;&#21305;&#37197;&#30446;&#26631;&#26041;&#27861;&#22768;&#26126;&#30340;&#24322;&#24120;&#65292;&#20182;&#20170;&#21518;&#19968;&#23450;&#31243;&#24230;&#19978;&#32806;&#21512;&#22312;&#29305;&#23450;&#30340;&#26041;&#27861;&#31614;&#21517;&#19978;&#12290;
&#19981;&#35201;&#25243;&#20986;&#26410;&#26816;&#26597;&#24322;&#24120;&#65292;&#23427;&#21644;&#30446;&#26631;&#26041;&#27861;&#30340;&#31614;&#21517;&#19981;&#20860;&#23481;&#12290;</p>
</td></tr></table></div>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Throws advice can be used with any pointcut.
Throws advice &#33021;&#22815;&#34987;&#29992;&#22312;&#20219;&#20309;&#30340;&#20999;&#20837;&#28857;</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-after-returning" href="#aop-api-advice-after-returning"></a>After Returning advice &#21518;&#32622;advice</h4></div></div></div>

<p>An after returning advice in Spring must implement the
<span class="emphasis"><em>org.springframework.aop.AfterReturningAdvice</em></span> interface, shown below:
&#21518;&#32622;advice &#24517;&#39035;&#23454;&#29616; <span class="emphasis"><em>org.springframework.aop.AfterReturningAdvice</em></span> &#25509;&#21475;&#65292;&#35831;&#30475;&#19979;&#38754;&#31034;&#20363;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AfterReturningAdvice <span class="hl-keyword">extends</span> Advice {

    <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args, Object target)
            <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>7&#26376;7&#21495;&#24320;&#22987;</p>
<p>An after returning advice has access to the return value (which it cannot modify),
invoked method, methods arguments and target.
&#21518;&#32622;advice&#21487;&#20197;&#35775;&#38382;&#35843;&#29992;&#30340;&#26041;&#27861;&#65292;&#26041;&#27861;&#21442;&#25968;&#65292;&#21644;&#30446;&#26631;&#30340;&#36820;&#22238;&#20540;&#65288;&#19981;&#33021;&#20462;&#25913;&#65289;</p>
<p>The following after returning advice counts all successful method invocations that have
not thrown exceptions:
&#19979;&#38754;&#30340;&#21518;&#32622;advice&#20250;&#32479;&#35745;&#25152;&#26377;&#27809;&#26377;&#25243;&#20986;&#24322;&#24120;&#30340;&#25104;&#21151;&#26041;&#27861;&#35843;&#29992;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingAfterReturningAdvice <span class="hl-keyword">implements</span> AfterReturningAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args, Object target)
            <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<p>This advice doesn&#8217;t change the execution path. If it throws an exception, this will be
thrown up the interceptor chain instead of the return value.
&#19978;&#36848;advice&#19981;&#20250;&#25913;&#21464;&#25191;&#34892;&#36335;&#24452;&#12290;&#22914;&#26524;&#23427;&#25243;&#20986;&#24322;&#24120;&#65292;&#23427;&#23558;&#20250;&#21521;&#19978;&#25243;&#32473;&#25318;&#25130;&#22120;&#38142;&#26469;&#20195;&#29702;&#36820;&#22238;&#20540;</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>After returning advice can be used with any pointcut.
&#21518;&#32622;advice &#21487;&#20197;&#34987;&#29992;&#22312;&#20219;&#20309;&#30340;&#20999;&#20837;&#28857;&#19978;</p>
</td></tr></table></div>

<p>7&#26376;8&#21495;&#24320;&#22987;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-introduction" href="#aop-api-advice-introduction"></a>Introduction advice &#20171;&#32461;&#30340;Advice</h4></div></div></div>

<p>Spring treats introduction advice as a special kind of interception advice.
Spring &#25226; introduction advice &#24403;&#25104;&#19968;&#31181;&#29305;&#27530;&#30340;&#25318;&#25130;&#22120;advice</p>
<p>Introduction requires an <code class="literal">IntroductionAdvisor</code>, and an <code class="literal">IntroductionInterceptor</code>,
implementing the following interface:
&#20171;&#32461;&#38656;&#35201;<code class="literal">IntroductionAdvisor</code>&#21644; <code class="literal">IntroductionInterceptor</code>,&#38656;&#35201;&#23454;&#29616;&#20197;&#19979;&#25509;&#21475;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInterceptor <span class="hl-keyword">extends</span> MethodInterceptor {

    <span class="hl-keyword">boolean</span> implementsInterface(Class intf);
}</pre>

<p>The <code class="literal">invoke()</code> method inherited from the AOP Alliance <code class="literal">MethodInterceptor</code> interface must
implement the introduction: that is, if the invoked method is on an introduced
interface, the introduction interceptor is responsible for handling the method call - it
cannot invoke <code class="literal">proceed()</code>.
<code class="literal">invoke()</code>&#26041;&#27861;&#32487;&#25215;&#33258;AOP&#32852;&#30431;&#30340;<code class="literal">MethodInterceptor</code>&#25509;&#21475;&#65292;&#23427;&#24517;&#39035;&#23454;&#29616;&#36825;&#20010;introduction: &#22914;&#19979;&#23601;&#26159;,
&#22914;&#26524;&#35843;&#29992;&#30340;&#26041;&#27861;&#22312;&#34987;&#20171;&#32461;&#30340;&#25509;&#21475;&#65292;&#36825;&#20010;&#20171;&#32461;&#30340;&#25318;&#25130;&#22120;&#36127;&#36131;&#22788;&#29702;&#26041;&#27861;&#35843;&#29992;&#65292;&#20182;&#33021;&#22815;&#35843;&#29992;<code class="literal">proceed()</code>&#26041;&#27861;&#12290;</p>
<p>Introduction advice cannot be used with any pointcut, as it applies only at class,
rather than method, level. You can only use introduction advice with the
<code class="literal">IntroductionAdvisor</code>, which has the following methods:
Introduction advice &#19981;&#33021;&#34987;&#29992;&#22312;&#20219;&#20309;&#30340;&#21152;&#20837;&#28857;&#65292;&#21482;&#33021;&#34987;&#29992;&#22312;&#31867;&#32780;&#19981;&#26159;&#26041;&#27861;&#32423;&#21035;&#12290;introduction advice&#21482;&#33021;&#21644;<code class="literal">IntroductionAdvisor</code>&#22312;&#19968;&#36215;&#29992;&#65292;
&#20363;&#22914;&#19979;&#38754;&#30340;&#26041;&#27861;&#65306;</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionAdvisor <span class="hl-keyword">extends</span> Advisor, IntroductionInfo {

    ClassFilter getClassFilter();

    <span class="hl-keyword">void</span> validateInterfaces() <span class="hl-keyword">throws</span> IllegalArgumentException;
}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInfo {

    Class[] getInterfaces();
}</pre>

<p>There is no <code class="literal">MethodMatcher</code>, and hence no <code class="literal">Pointcut</code>, associated with introduction
advice. Only class filtering is logical.</p>
<p>&#36825;&#37324;&#27809;&#26377;<code class="literal">MethodMatcher</code>&#65292;&#22240;&#27492;&#27809;&#26377;<code class="literal">Pointcut</code>&#65292;&#21644;introduction advice&#36830;&#25509;&#12290;&#21482;&#26377;&#31867;&#30340;&#36807;&#28388;&#26159;&#21512;&#20046;&#36923;&#36753;&#30340;&#12290;</p>
<p>The <code class="literal">getInterfaces()</code> method returns the interfaces introduced by this advisor.
<code class="literal">getInterfaces()</code>
<code class="literal">getInterfaces()</code>&#26041;&#27861;&#36820;&#22238;</p>
<p>The <code class="literal">validateInterfaces()</code> method is used internally to see whether or not the
introduced interfaces can be implemented by the configured <code class="literal">IntroductionInterceptor</code>.</p>
<p>Let&#8217;s look at a simple example from the Spring test suite. Let&#8217;s suppose we want to
introduce the following interface to one or more objects:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Lockable {
    <span class="hl-keyword">void</span> lock();
    <span class="hl-keyword">void</span> unlock();
    <span class="hl-keyword">boolean</span> locked();
}</pre>

<p>7&#26376;9&#21495;&#24320;&#22987;</p>
<p>This illustrates a <span class="emphasis"><em>mixin</em></span>. We want to be able to cast advised objects to Lockable,
whatever their type, and call lock and unlock methods. If we call the lock() method, we
want all setter methods to throw a <code class="literal">LockedException</code>. Thus we can add an aspect that
provides the ability to make objects immutable, without them having any knowledge of it:
a good example of AOP.</p>
<p>Firstly, we&#8217;ll need an <code class="literal">IntroductionInterceptor</code> that does the heavy lifting. In this
case, we extend the <code class="literal">org.springframework.aop.support.DelegatingIntroductionInterceptor</code>
convenience class. We could implement IntroductionInterceptor directly, but using
<code class="literal">DelegatingIntroductionInterceptor</code> is best for most cases.</p>
<p>The <code class="literal">DelegatingIntroductionInterceptor</code> is designed to delegate an introduction to an
actual implementation of the introduced interface(s), concealing the use of interception
to do so. The delegate can be set to any object using a constructor argument; the
default delegate (when the no-arg constructor is used) is this. Thus in the example
below, the delegate is the <code class="literal">LockMixin</code> subclass of <code class="literal">DelegatingIntroductionInterceptor</code>.
Given a delegate (by default itself), a <code class="literal">DelegatingIntroductionInterceptor</code> instance
looks for all interfaces implemented by the delegate (other than
IntroductionInterceptor), and will support introductions against any of them. It&#8217;s
possible for subclasses such as <code class="literal">LockMixin</code> to call the <code class="literal">suppressInterface(Class intf)</code>
method to suppress interfaces that should not be exposed. However, no matter how many
interfaces an <code class="literal">IntroductionInterceptor</code> is prepared to support, the
<code class="literal">IntroductionAdvisor</code> used will control which interfaces are actually exposed. An
introduced interface will conceal any implementation of the same interface by the target.</p>
<p>Thus <code class="literal">LockMixin</code> extends <code class="literal">DelegatingIntroductionInterceptor</code> and implements <code class="literal">Lockable</code>
itself. The superclass automatically picks up that Lockable can be supported for
introduction, so we don&#8217;t need to specify that. We could introduce any number of
interfaces in this way.</p>
<p>Note the use of the <code class="literal">locked</code> instance variable. This effectively adds additional state
to that held in the target object.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixin <span class="hl-keyword">extends</span> DelegatingIntroductionInterceptor <span class="hl-keyword">implements</span> Lockable {

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> locked;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> lock() {
        <span class="hl-keyword">this</span>.locked = true;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> unlock() {
        <span class="hl-keyword">this</span>.locked = false;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> locked() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.locked;
    }

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-keyword">if</span> (locked() &amp;&amp; invocation.getMethod().getName().indexOf(<span class="hl-string">"set"</span>) == <span class="hl-number">0</span>) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LockedException();
        }
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.invoke(invocation);
    }

}</pre>

<p>7&#26376;10&#21495;&#24320;&#22987;</p>
<p>Often it isn&#8217;t necessary to override the <code class="literal">invoke()</code> method: the
<code class="literal">DelegatingIntroductionInterceptor</code> implementation - which calls the delegate method if
the method is introduced, otherwise proceeds towards the join point - is usually
sufficient. In the present case, we need to add a check: no setter method can be invoked
if in locked mode.</p>
<p>The introduction advisor required is simple. All it needs to do is hold a distinct
<code class="literal">LockMixin</code> instance, and specify the introduced interfaces - in this case, just
<code class="literal">Lockable</code>. A more complex example might take a reference to the introduction
interceptor (which would be defined as a prototype): in this case, there&#8217;s no
configuration relevant for a <code class="literal">LockMixin</code>, so we simply create it using <code class="literal">new</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixinAdvisor <span class="hl-keyword">extends</span> DefaultIntroductionAdvisor {

    <span class="hl-keyword">public</span> LockMixinAdvisor() {
        <span class="hl-keyword">super</span>(<span class="hl-keyword">new</span> LockMixin(), Lockable.<span class="hl-keyword">class</span>);
    }
}</pre>

<p>We can apply this advisor very simply: it requires no configuration. (However, it <span class="emphasis"><em>is</em></span>
necessary: It&#8217;s impossible to use an <code class="literal">IntroductionInterceptor</code> without an
<span class="emphasis"><em>IntroductionAdvisor</em></span>.) As usual with introductions, the advisor must be per-instance,
as it is stateful. We need a different instance of <code class="literal">LockMixinAdvisor</code>, and hence
<code class="literal">LockMixin</code>, for each advised object. The advisor comprises part of the advised object&#8217;s
state.</p>
<p>We can apply this advisor programmatically, using the <code class="literal">Advised.addAdvisor()</code> method, or
(the recommended way) in XML configuration, like any other advisor. All proxy creation
choices discussed below, including "auto proxy creators," correctly handle introductions
and stateful mixins.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advisor" href="#aop-api-advisor"></a>10.4&nbsp;Advisor API in Spring</h2></div></div></div>

<p>&#22312;Spring&#20013;, &#19968;&#20010;&#36890;&#30693;&#22120;&#23601;&#26159;&#19968;&#20010;&#21253;&#21547;&#36890;&#30693;&#21644;&#20999;&#20837;&#28857;&#34920;&#36798;&#24335;&#30340;&#20999;&#38754;.</p>
<p>&#38500;&#20102;&#19968;&#20123;&#29305;&#27530;&#30340;&#24773;&#20917;, &#20219;&#24847;&#30340;&#36890;&#30693;&#21487;&#20197;&#24212;&#29992;&#20110;&#20219;&#20309;&#30340;&#36890;&#30693;&#22120;.
<code class="literal">org.springframework.aop.support.DefaultPointcutAdvisor</code> &#26159;&#26368;&#24120;&#29992;&#30340;&#36890;&#30693;&#22120;&#31867;.
&#20363;&#22914;, &#23427;&#21487;&#20197;&#34987;&#29992;&#20110; <code class="literal">MethodInterceptor</code>, <code class="literal">BeforeAdvice</code> or
<code class="literal">ThrowsAdvice</code>.</p>
<p>&#22312;Spring&#30340;&#30456;&#21516;&#30340;AOP&#20195;&#29702;&#20013;&#65292;&#36890;&#30693;&#21644;&#36890;&#30693;&#22120;&#28151;&#29992;&#26159;&#21487;&#34892;. &#20363;&#22914;, &#22312;&#19968;&#20010;&#20195;&#29702;&#37197;&#32622;&#20013;&#20320;
&#21487;&#20197;&#20351;&#29992;&#29615;&#32469;&#36890;&#30693;&#65292;&#24322;&#24120;&#36890;&#30693;&#21644;&#21069;&#32622;&#36890;&#30693;: Spring&#23558;&#20250;&#33258;&#21160;&#21019;&#24314;&#25318;&#25130;&#22120;&#38142;.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-pfb" href="#aop-pfb"></a>10.5&nbsp;Using the ProxyFactoryBean to create AOP proxies</h2></div></div></div>

<p>&#22914;&#26524;&#20320;&#27491;&#22312;&#20351;&#29992; Spring IoC &#23481;&#22120;(ApplicationContext&#25110;&#32773;BeanFactory) &#31649;&#29702;&#20320;&#30340;&#19994;&#21153;&#23545;&#35937;
- &#20320;&#20250;&#24819;&#35201;&#20351;&#29992;Spring&#30340;AOP FactoryBeans. (&#35831;&#35760;&#20303;&#19968;&#20010;factory bean&#26159;&#20026;&#20102;&#24341;&#36827;&#19968;&#31181;&#20998;&#23618;&#30340;
&#26426;&#21046;&#65292;&#21487;&#20197;&#21019;&#24314;&#19981;&#21516;&#31867;&#22411;&#30340;&#23545;&#35937;.)</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Spring AOP&#25903;&#25345;&#20351;&#29992;factory beans&#36991;&#20813;&#34987;&#35206;&#30422;.</p>
</td></tr></table></div>

<p>&#22312;Spring&#24403;&#20013;&#21019;&#24314;&#20195;&#29702;&#30340;&#26368;&#22909;&#30340;&#26041;&#24335;&#26159;&#20351;&#29992;<span class="emphasis"><em>org.springframework.aop.framework.ProxyFactoryBean</em></span>.
&#23545;&#20110;&#20999;&#20837;&#28857;&#21644;&#36890;&#30693;&#30340;&#24212;&#29992;&#21644;&#39034;&#24207;&#65292;&#23427;&#25552;&#20379;&#20102;&#23436;&#25104;&#30340;&#25511;&#21046;. &#28982;&#21518;, &#24403;&#20320;&#38656;&#35201;&#22826;&#22810;&#30340;&#25511;&#21046;&#26102;&#65292;&#26356;&#22909;&#30340;&#26041;&#24335;&#26159;&#36890;&#36807;&#20351;&#29992;&#31616;&#21333;&#30340;&#36873;&#39033;.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-1" href="#aop-pfb-1"></a>10.5.1&nbsp;Basics</h3></div></div></div>

<p><code class="literal">ProxyFactoryBean</code>&#30340;&#23454;&#29616;&#23601;&#20687;&#20854;&#20182;&#30340;Spring&#30340;<code class="literal">FactoryBean</code>, &#36215;&#21040;&#20102;&#20998;&#23618;&#30340;&#20316;&#29992;.
&#22914;&#26524;&#20320;&#23450;&#20041;&#20102;&#19968;&#20010;&#21517;&#20026;<code class="literal">foo</code>&#30340;<code class="literal">ProxyFactoryBean</code>, &#24403;&#24341;&#29992;&#20102;<code class="literal">foo</code>&#30475;&#21040;&#19981;&#20250;&#26159;<code class="literal">ProxyFactoryBean</code>&#30340;&#23454;&#20363;,
&#32780;&#26159;&#36890;&#36807;<code class="literal">ProxyFactoryBean</code>&#23454;&#29616;&#30340;<code class="literal">getObject()</code>&#26041;&#27861;&#21019;&#24314;&#30340;&#23545;&#35937;.&#36825;&#20010;&#26041;&#27861;&#23558;&#20250;&#19968;&#20010;AOP&#30340;&#20195;&#29702;&#21253;&#35013;&#22312;&#30446;&#26631;&#31867;&#19978;.</p>
<p>&#20351;&#29992;<code class="literal">ProxyFactoryBean</code>&#25110;&#32773;&#20854;&#20182;IoC-aware&#31867;&#26469;&#21019;&#24314;AOP&#20195;&#29702;,&#20854;&#20013;&#19968;&#20010;&#24456;&#22823;&#30340;&#22909;&#22788;&#23601;&#26159;&#36890;&#30693;&#21644;&#20999;&#20837;&#28857;&#23558;&#20250;
&#34987;IoC&#23481;&#22120;&#31649;&#29702;. &#36825;&#26159;&#19968;&#20010;&#24456;&#26377;&#29992;&#29305;&#24615;&#65292;&#24403;&#23427;&#24320;&#21551;&#26102;&#21487;&#20197;&#24456;&#22909;&#30340;&#30830;&#20445;&#19981;&#34987;&#20854;&#20182;&#30340;AOP&#26694;&#26550;&#25152;&#33719;&#24471;.
&#20363;&#22914;, &#19968;&#20010;&#36890;&#30693;&#21487;&#33021;&#24341;&#29992;&#21040;&#24212;&#29992;&#20869;&#30340;&#23545;&#35937; (&#38500;&#20102;&#30446;&#26631;&#31867;&#20043;&#22806;, &#36825;&#20123;&#37117;&#26159;&#21487;&#20197;&#22312;&#20219;&#20309;AOP&#26694;&#26550;&#20869;&#33719;&#24471;&#30340;),
&#26377;&#21033;&#30340;&#26159;&#36890;&#36807;&#20381;&#36182;&#27880;&#20837;&#65292;&#36825;&#20123;&#37117;&#26159;&#21487;&#25554;&#25300;&#30340;.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-2" href="#aop-pfb-2"></a>10.5.2&nbsp;JavaBean properties</h3></div></div></div>

<p>&#36890;&#24120;&#24773;&#20917;&#19979;&#65292;Spring&#25552;&#20379;&#30340;<code class="literal">FactoryBean</code>&#23454;&#29616;, <code class="literal">ProxyFactoryBean</code>&#26412;&#36523;&#23601;&#26159;&#19968;&#20010;JavaBean. &#26377;&#20197;&#19979;&#23646;&#24615;&#21487;&#20197;&#34987;&#35774;&#32622;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#25351;&#23450;&#20195;&#29702;&#30340;&#30446;&#26631;&#31867;.
</li><li class="listitem">
&#25351;&#23450;&#21738;&#19968;&#20010;&#29992;&#20110;CGLIB&#20195;&#29702; (&#35265;&#25991; <a class="xref" href="aop-api.html#aop-pfb-proxy-types" title="10.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;10.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li></ul></div>

<p>&#19968;&#20123;&#20851;&#38190;&#30340;&#23646;&#24615;&#32487;&#25215;&#20110;<code class="literal">org.springframework.aop.framework.ProxyConfig</code>
(&#22312;Spring&#20013;&#65292;&#36825;&#20010;&#25152;&#26377;Aop&#20195;&#29702;&#24037;&#21378;&#30340;&#36229;&#31867;). &#36825;&#20123;&#20851;&#38190;&#30340;&#23646;&#24615;&#21253;&#25324;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">proxyTargetClass</code>: <code class="literal">true</code>&#30340;&#24773;&#20917;&#19979;&#23558;&#20351;&#29992;&#31867;&#30340;&#20195;&#29702;, &#32780;&#19981;&#26159;&#22522;&#20110;&#25509;&#21475;&#30340;&#20195;&#29702;.
&#24403;&#23646;&#24615;&#35774;&#32622;&#20026;true&#30340;&#24773;&#20917;&#19979;&#65292;CGLIB&#20195;&#29702;&#23558;&#20250;&#34987;&#21019;&#24314;&#12290;(&#35265;&#25991; &lt;aop-pfb-proxy-types&gt;&gt;).
</li><li class="listitem">
<code class="literal">optimize</code>: controls whether or not aggressive optimizations are applied to proxies
<span class="emphasis"><em>created via CGLIB</em></span>. One should not blithely use this setting unless one fully
understands how the relevant AOP proxy handles optimization.
&#21482;&#33021;&#20351;&#29992; CGLIB &#30340;&#20195;&#29702;; JDK &#21160;&#24577;&#20195;&#29702;&#27492;&#39033;&#37197;&#32622;&#26159;&#26080;&#25928;&#30340;.
</li><li class="listitem">
<code class="literal">frozen</code>: if a proxy configuration is <code class="literal">frozen</code>, then changes to the configuration are
no longer allowed. This is useful both as a slight optimization and for those cases
when you don&#8217;t want callers to be able to manipulate the proxy (via the <code class="literal">Advised</code>
interface) after the proxy has been created. The default value of this property is
<code class="literal">false</code>, so changes such as adding additional advice are allowed.
</li><li class="listitem">
<code class="literal">exposeProxy</code>: determines whether or not the current proxy should be exposed in a
<code class="literal">ThreadLocal</code> so that it can be accessed by the target. If a target needs to obtain
the proxy and the <code class="literal">exposeProxy</code> property is set to <code class="literal">true</code>, the target can use the
<code class="literal">AopContext.currentProxy()</code> method.
</li></ul></div>

<p>&#20854;&#20182;&#21487;&#20197;&#25351;&#23450;&#30340;&#23646;&#24615;&#23545;&#20110;<code class="literal">ProxyFactoryBean</code>&#21253;&#25324;:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">proxyInterfaces</code>: String&#25968;&#32452;&#30340;&#25509;&#21475;&#21517;&#31216;. &#22914;&#26524;&#27809;&#26377;&#25214;&#21040;&#36825;&#20010;&#25509;&#21475;, CGLIB&#30340;&#20195;&#29702;&#23558;&#20250;&#34987;&#21019;&#24314;
(&#21487;&#20197;&#35265;&#25991; <a class="xref" href="aop-api.html#aop-pfb-proxy-types" title="10.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;10.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<p class="simpara"><code class="literal">interceptorNames</code>: String&#25968;&#32452;&#30340;<code class="literal">Advisor</code>, &#25318;&#25130;&#22120;&#25110;&#32773;&#20854;&#23427;&#30340;&#36890;&#30693;&#21517;&#31216;&#23558;&#20250;&#34987;&#24212;&#29992;&#12290;
&#25968;&#32452;&#39034;&#24207;&#30340;&#26159;&#26377;&#37325;&#22823;&#24847;&#20041;&#30340;, &#36825;&#20123;&#25318;&#25130;&#22120;&#21644;&#36890;&#30693;&#23558;&#20250;&#34987;&#39034;&#24207;&#30340;&#24212;&#29992;.</p>

<pre class="literallayout">&#36825;&#20123;&#21517;&#31216;&#26159;bean&#30340;&#21517;&#31216;&#23384;&#22312;&#20110;&#24403;&#21069;&#30340;&#24037;&#21378;&#20013;, &#21253;&#25324;&#23427;&#29238;&#31867;&#30340;&#24037;&#21378;&#20013;&#12290;
&#20320;&#23558;&#19981;&#33021;&#24341;&#29992;&#21040;bean&#65292;&#24403;`ProxyFactoryBean`&#20013;&#30340;&#36890;&#30693;&#19981;&#26159;&#20351;&#29992;&#21333;&#20363;.</pre>

</li></ul></div>

<p>&#24403;&#20320;&#38656;&#35201;&#28155;&#21152;&#19968;&#20010;&#25318;&#25130;&#22120;&#26102;&#65292;&#20320;&#21487;&#20197;&#28155;&#21152;&#19968;&#20010;&#26143;&#21495; ( <code class="literal">*</code>). &#25972;&#20010;&#24212;&#29992;&#20013;&#30340;&#25318;&#25130;&#22120;&#30340;&#21517;&#31216;&#21305;&#37197;&#26143;&#21495;&#21069;&#38754;&#30340;&#20869;&#23481;&#30340;&#25318;&#25130;&#22120;&#23558;&#20250;&#34987;&#24212;&#29992;.
&#19968;&#20010;&#26679;&#20363;&#21487;&#20197;&#22312;&#36825;&#37324;&#25214;&#21040; <a class="xref" href="aop-api.html#aop-global-advisors" title="10.5.6&nbsp;Using global advisors">Section&nbsp;10.5.6, &#8220;Using <span class="emphasis"><em>global</em></span> advisors&#8221;</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
singleton: &#40664;&#35748;&#20351;&#29992;&#30340;&#21333;&#20363;&#27169;&#24335;, &#19981;&#31649;&#35843;&#29992;<code class="literal">getObject()</code>&#30340;&#26041;&#27861;&#26377;&#22810;&#39057;&#32321;&#12290;&#40664;&#35748;&#20540;&#26159;<code class="literal">true</code>.
&#20320;&#24819;&#35201;&#20351;&#29992;&#26222;&#36890;&#29366;&#24577;&#30340;&#23545;&#35937;&#65292;&#21487;&#20197;&#37197;&#32622;&#25104;<code class="literal">false</code>.
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-proxy-types" href="#aop-pfb-proxy-types"></a>10.5.3&nbsp;JDK- and CGLIB-based proxies</h3></div></div></div>

<p>&#36825;&#20010;&#31456;&#33410;&#26159;&#20851;&#20110; <code class="literal">ProxyFactoryBean</code> &#26368;&#21518;&#30340;&#25991;&#26723;&#65292;&#25552;&#20379;&#20102;&#35828;&#26126;&#23545;&#20110;&#29305;&#21035;&#31867;&#26159;&#35201;&#26159;&#35201;&#20351;&#29992;&#22522;&#20110;&#31867;&#30340;&#20195;&#29702;&#36824;&#26159;JDK&#21160;&#24577;&#20195;&#29702;.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">ProxyFactoryBean</code>&#21019;&#24314;&#22522;&#20110;CGLIB&#30340;&#20195;&#29702;&#36824;&#26159;JDK&#21160;&#24577;&#20195;&#29702;&#30340;&#34892;&#20026;&#24050;&#32463;&#21457;&#29983;&#25913;&#21464;
&#23545;&#20110;Spring&#30340; 1.2.x &#21644;Spring 2.0 &#29256;&#26412;. The <code class="literal">ProxyFactoryBean</code> now
exhibits similar semantics with regard to auto-detecting interfaces as those of the
<code class="literal">TransactionProxyFactoryBean</code> class.</p>
</td></tr></table></div>

<p>If the class of a target object that is to be proxied (hereafter simply referred to as
the target class) doesn&#8217;t implement any interfaces, then a CGLIB-based proxy will be
created. This is the easiest scenario, because JDK proxies are interface based, and no
interfaces means JDK proxying isn&#8217;t even possible. One simply plugs in the target bean,
and specifies the list of interceptors via the <code class="literal">interceptorNames</code> property. Note that a
CGLIB-based proxy will be created even if the <code class="literal">proxyTargetClass</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">false</code>. (Obviously this makes no sense, and is best
removed from the bean definition because it is at best redundant, and at worst
confusing.)</p>
<p>If the target class implements one (or more) interfaces, then the type of proxy that is
created depends on the configuration of the <code class="literal">ProxyFactoryBean</code>.</p>
<p>If the <code class="literal">proxyTargetClass</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">true</code>,
then a CGLIB-based proxy will be created. This makes sense, and is in keeping with the
principle of least surprise. Even if the <code class="literal">proxyInterfaces</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to one or more fully qualified interface names, the fact
that the <code class="literal">proxyTargetClass</code> property is set to <code class="literal">true</code> <span class="emphasis"><em>will</em></span> cause CGLIB-based
proxying to be in effect.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to one or more
fully qualified interface names, then a JDK-based proxy will be created. The created
proxy will implement all of the interfaces that were specified in the <code class="literal">proxyInterfaces</code>
property; if the target class happens to implement a whole lot more interfaces than
those specified in the <code class="literal">proxyInterfaces</code> property, that is all well and good but those
additional interfaces will not be implemented by the returned proxy.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has <span class="emphasis"><em>not</em></span> been set, but
the target class <span class="emphasis"><em>does implement one (or more)</em></span> interfaces, then the
<code class="literal">ProxyFactoryBean</code> will auto-detect the fact that the target class does actually
implement at least one interface, and a JDK-based proxy will be created. The interfaces
that are actually proxied will be <span class="emphasis"><em>all</em></span> of the interfaces that the target class
implements; in effect, this is the same as simply supplying a list of each and every
interface that the target class implements to the <code class="literal">proxyInterfaces</code> property. However,
it is significantly less work, and less prone to typos.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-proxying-intf" href="#aop-api-proxying-intf"></a>10.5.4&nbsp;Proxying interfaces</h3></div></div></div>

<p>Let&#8217;s look at a simple example of <code class="literal">ProxyFactoryBean</code> in action. This example involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <span class="emphasis"><em>target bean</em></span> that will be proxied. This is the "personTarget" bean definition in
the example below.
</li><li class="listitem">
An Advisor and an Interceptor used to provide advice.
</li><li class="listitem">
An AOP proxy bean definition specifying the target object (the personTarget bean) and
the interfaces to proxy, along with the advices to apply.
</li></ul></div>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Tony"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"51"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Custom string property value"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycompany.Person"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"personTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the <code class="literal">interceptorNames</code> property takes a list of String: the bean names of the
interceptor or advisors in the current factory. Advisors, interceptors, before, after
returning and throws advice objects can be used. The ordering of advisors is significant.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You might be wondering why the list doesn&#8217;t hold bean references. The reason for this is
that if the ProxyFactoryBean&#8217;s singleton property is set to false, it must be able to
return independent proxy instances. If any of the advisors is itself a prototype, an
independent instance would need to be returned, so it&#8217;s necessary to be able to obtain
an instance of the prototype from the factory; holding a reference isn&#8217;t sufficient.</p>
</td></tr></table></div>

<p>The "person" bean definition above can be used in place of a Person implementation, as
follows:</p>
<pre class="programlisting">Person person = (Person) factory.getBean(<span class="hl-string">"person"</span>);</pre>

<p>Other beans in the same IoC context can express a strongly typed dependency on it, as
with an ordinary Java object:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personUser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonUser"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"person"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"person"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">PersonUser</code> class in this example would expose a property of type Person. As far as
it&#8217;s concerned, the AOP proxy can be used transparently in place of a "real" person
implementation. However, its class would be a dynamic proxy class. It would be possible
to cast it to the <code class="literal">Advised</code> interface (discussed below).</p>
<p>It&#8217;s possible to conceal the distinction between target and proxy using an anonymous
<span class="emphasis"><em>inner bean</em></span>, as follows. Only the <code class="literal">ProxyFactoryBean</code> definition is different; the
advice is included only for completeness:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Custom string property value"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycompany.Person"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- Use inner bean, not local reference to target --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Tony"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"51"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This has the advantage that there&#8217;s only one object of type <code class="literal">Person</code>: useful if we want
to prevent users of the application context from obtaining a reference to the un-advised
object, or need to avoid any ambiguity with Spring IoC <span class="emphasis"><em>autowiring</em></span>. There&#8217;s also
arguably an advantage in that the ProxyFactoryBean definition is self-contained.
However, there are times when being able to obtain the un-advised target from the
factory might actually be an <span class="emphasis"><em>advantage</em></span>: for example, in certain test scenarios.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-proxying-class" href="#aop-api-proxying-class"></a>10.5.5&nbsp;Proxying classes</h3></div></div></div>

<p>What if you need to proxy a class, rather than one or more interfaces?</p>
<p>Imagine that in our example above, there was no <code class="literal">Person</code> interface: we needed to advise
a class called <code class="literal">Person</code> that didn&#8217;t implement any business interface. In this case, you
can configure Spring to use CGLIB proxying, rather than dynamic proxies. Simply set the
<code class="literal">proxyTargetClass</code> property on the ProxyFactoryBean above to true. While it&#8217;s best to
program to interfaces, rather than classes, the ability to advise classes that don&#8217;t
implement interfaces can be useful when working with legacy code. (In general, Spring
isn&#8217;t prescriptive. While it makes it easy to apply good practices, it avoids forcing a
particular approach.)</p>
<p>If you want to, you can force the use of CGLIB in any case, even if you do have
interfaces.</p>
<p>CGLIB proxying works by generating a subclass of the target class at runtime. Spring
configures this generated subclass to delegate method calls to the original target: the
subclass is used to implement the <span class="emphasis"><em>Decorator</em></span> pattern, weaving in the advice.</p>
<p>CGLIB proxying should generally be transparent to users. However, there are some issues
to consider:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Final</code> methods can&#8217;t be advised, as they can&#8217;t be overridden.
</li><li class="listitem">
There is no need to add CGLIB to your classpath. As of Spring 3.2, CGLIB is repackaged
and included in the spring-core JAR. In other words, CGLIB-based AOP will work "out of
the box" just as do JDK dynamic proxies.
</li></ul></div>

<p>There&#8217;s little performance difference between CGLIB proxying and dynamic proxies. As of
Spring 1.0, dynamic proxies are slightly faster. However, this may change in the future.
Performance should not be a decisive consideration in this case.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-global-advisors" href="#aop-global-advisors"></a>10.5.6&nbsp;Using <span class="emphasis"><em>global</em></span> advisors</h3></div></div></div>

<p>By appending an asterisk to an interceptor name, all advisors with bean names matching
the part before the asterisk, will be added to the advisor chain. This can come in handy
if you need to add a standard set of <span class="emphasis"><em>global</em></span> advisors:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>global*<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_debug"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_performance"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.PerformanceMonitorInterceptor"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-concise-proxy" href="#aop-concise-proxy"></a>10.6&nbsp;&#31616;&#27905;&#30340;&#20195;&#29702;&#23450;&#20041;</h2></div></div></div>

<p>&#29305;&#21035;&#26159;&#22312;&#23450;&#20041;&#20107;&#21153;&#20195;&#29702;&#30340;&#26102;&#20505;, &#20320;&#26377;&#21487;&#33021;&#26368;&#21518;&#37117;&#20250;&#26377;&#35768;&#22810;&#30456;&#20284;&#30340;&#20195;&#29702;&#23450;&#20041;. &#20351;&#29992;&#29238;&#23376;bean&#23450;&#20041;, &#20197;&#21450;&#20869;&#37096;bean&#23450;&#20041;,
&#21487;&#20197;&#21019;&#20316;&#20986;&#26356;&#21152;&#24178;&#20928;&#21644;&#31616;&#27905;&#30340;&#20195;&#29702;&#23450;&#20041;.</p>
<p>&#39318;&#20808;, &#20026;&#20195;&#29702;&#23450;&#20041;&#19968;&#20010;&#29238;<span class="emphasis"><em>&#27169;&#26495;</em></span>bean&#23450;&#20041;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txProxyTemplate"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>&#36825;&#24182;&#19981;&#33021;&#35753;&#23427;&#34987;&#23454;&#20363;&#21270;, &#25152;&#20197;&#20854;&#23454;&#24212;&#35813;&#26159;&#26410;&#23436;&#25104;&#30340;. &#28982;&#21518;&#27599;&#19968;&#20010;&#38656;&#35201;&#21019;&#24314;&#30340;&#20195;&#29702;&#37117;&#26159;&#23427;&#30340;&#23376;bean&#23450;&#20041;, &#36825;&#20123;bean&#37117;
&#21253;&#21547;&#19968;&#20010;target&#30340;&#20869;&#37096;bean&#23450;&#20041;, &#26223;&#35266;target&#27704;&#36828;&#19981;&#20250;&#20197;&#23427;&#33258;&#24049;&#30340;&#26041;&#24335;&#20351;&#29992;.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>&#24403;&#28982;&#21487;&#20197;&#35206;&#30422;&#29238;&#27169;&#26495;&#37324;&#38754;&#30340;&#23646;&#24615;, &#23601;&#20687;&#36825;&#20010;&#20363;&#23376;&#19968;&#26679;, &#35206;&#30422;&#20107;&#21153;&#30340;&#20256;&#25773;&#23646;&#24615;&#35774;&#32622;:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySpecialService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MySpecialServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"get*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"find*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"load*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"store*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>&#35760;&#20303;, &#22312;&#19978;&#38754;&#30340;&#20363;&#23376;&#20013;, &#25105;&#20204;&#23454;&#38469;&#19978;&#26159;&#20351;&#29992;&#20102;<a class="link" href="beans.html#beans-child-bean-definitions" title="5.7&nbsp;Bean&#23450;&#20041;&#30340;&#32487;&#25215;">&#21069;&#38754;</a>&#20171;&#32461;&#30340;<span class="emphasis"><em>abstract</em></span>
&#23646;&#24615;&#26469;&#25226;bean&#26631;&#35760;&#20026;<span class="emphasis"><em>abstract</em></span>, &#20174;&#32780;&#20351;&#24471;&#23427;&#19981;&#33021;&#34987;&#23454;&#20363;&#21270;&#30340;. &#24212;&#29992;&#19978;&#19979;&#25991;(&#19981;&#26159;&#31616;&#21333;&#30340;bean&#24037;&#21378;)&#40664;&#35748;&#23558;&#20250;
&#39044;&#20808;&#23454;&#20363;&#21270;&#25152;&#26377;&#30340;&#21333;&#20363;. &#25152;&#20197;&#36825;&#26159;&#24456;&#37325;&#35201;&#30340;(&#33267;&#23569;&#23545;&#21333;&#20363;bean&#26469;&#35828;), &#22914;&#26524;&#20320;&#26377;&#19968;&#20010;(&#29238;)bean&#23450;&#20041;&#24819;&#29992;&#26469;&#20165;&#20165;&#20316;&#20026;
&#27169;&#26495;, &#24182;&#19988;&#36825;&#20010;&#23450;&#20041;&#25351;&#26126;&#20102;&#19968;&#20010;&#31867;, &#20320;&#24517;&#39035;&#30830;&#20445;&#35774;&#32622;&#20102;<span class="emphasis"><em>abstract</em></span>&#23646;&#24615;&#20026;<span class="emphasis"><em>true</em></span>, &#21542;&#21017;&#24212;&#29992;&#19978;&#19979;&#25991;&#23558;&#20250;&#23581;&#35797;
&#39044;&#20808;&#23454;&#20363;&#21270;&#23427;.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-prog" href="#aop-prog"></a>10.7&nbsp;&#20351;&#29992;&#32534;&#31243;&#26041;&#24335;&#36890;&#36807;ProxyFactory&#21019;&#24314;AOP&#20195;&#29702;</h2></div></div></div>

<p>&#22312;Spring&#20013;&#29992;&#32534;&#31243;&#30340;&#26041;&#24335;&#21019;&#24314;AOP&#20195;&#29702;&#26159;&#24456;&#31616;&#21333;&#30340;. &#36825;&#26679;&#23601;&#20351;&#24471;&#20320;&#21487;&#20197;&#20351;&#29992;Spring AOP&#32780;&#19981;&#38656;&#35201;&#20381;&#36182;&#20110;Spring IoC.</p>
<p>&#19979;&#38754;&#21015;&#20030;&#30340;&#23601;&#26159;&#20026;&#30446;&#26631;&#23545;&#35937;&#21019;&#24314;&#20195;&#29702;, &#20197;&#21450;&#35774;&#32622;&#25318;&#25130;&#22120;&#21644;&#36890;&#30693;&#22120;. &#34987;&#30446;&#26631;&#23545;&#35937;&#23454;&#29616;&#30340;&#25509;&#21475;&#23558;&#20250;&#34987;&#33258;&#21160;&#20195;&#29702;:</p>
<pre class="programlisting">ProxyFactory factory = <span class="hl-keyword">new</span> ProxyFactory(myBusinessInterfaceImpl);
factory.addAdvice(myMethodInterceptor);
factory.addAdvisor(myAdvisor);
MyBusinessInterface tb = (MyBusinessInterface) factory.getProxy();</pre>

<p>&#31532;&#19968;&#27493;&#26159;&#26500;&#36896;&#19968;&#20010;&#31867;&#22411;&#20026;<code class="literal">org.springframework.aop.framework.ProxyFactory</code>&#30340;&#23545;&#35937;. &#20320;&#21487;&#20197;&#20687;&#19978;&#38754;&#20363;&#23376;
&#37027;&#26679;&#21019;&#24314;&#30340;&#26102;&#20505;&#25351;&#23450;&#30446;&#26631;&#23545;&#35937;, &#25110;&#32773;&#20351;&#29992;&#20854;&#20182;&#30340;&#26367;&#20195;&#30340;&#26500;&#36896;&#20989;&#25968;&#26469;&#25351;&#23450;&#38656;&#35201;&#20195;&#29702;&#30340;&#25509;&#21475;.</p>
<p>&#20320;&#21487;&#20197;&#28155;&#21152;advice(&#25226;&#25318;&#25130;&#22120;&#20316;&#20026;&#19968;&#31181;&#29305;&#27530;&#30340;advice)&#21644;/&#25110;&#32773;&#36890;&#30693;&#22120;, &#24182;&#19988;&#25805;&#25511;&#23427;&#20204;&#26469;&#20026;ProxyFactory&#30340;&#29983;&#21629;&#21608;&#26399;
&#26381;&#21153;. &#22914;&#26524;&#20320;&#28155;&#21152;&#20102;&#19968;&#20010;IntroductionInterceptionAroundAdvisor, &#20320;&#23601;&#21487;&#20197;&#35753;&#20195;&#29702;&#25903;&#25345;&#23454;&#29616;&#38468;&#21152;&#30340;&#25509;&#21475;.</p>
<p>&#22312;ProxyFactory&#20013;&#20063;&#26377;&#35768;&#22810;&#26041;&#20415;&#30340;&#26041;&#27861;(&#32487;&#25215;&#33258;<code class="literal">AdvisedSupport</code>), &#20182;&#20204;&#20801;&#35768;&#20320;&#28155;&#21152;&#20854;&#20182;&#31867;&#22411;&#30340;advice, &#27604;&#22914;
&#21069;&#32622;&#25110;&#32773;&#25243;&#20986;&#24322;&#24120;. AdvisedSupport&#26159;ProxyFactory&#21644;ProxyFactoryBean&#30340;&#29238;&#31867;.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>&#22312;IoC&#26694;&#26550;&#20013;&#38598;&#25104;AOP&#20195;&#29702;&#30340;&#21019;&#24314;&#22312;&#22823;&#22810;&#25968;&#24212;&#29992;&#20013;&#26159;&#26368;&#22909;&#30340;&#36873;&#25321;. &#25105;&#20204;&#24314;&#35758;&#20320;&#22312;&#19968;&#33324;&#24773;&#20917;&#19979;&#20351;&#29992;AOP&#30340;Java&#20195;&#30721;&#26469;
&#23436;&#25104;&#20855;&#20307;&#30340;&#37197;&#32622;.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advised" href="#aop-api-advised"></a>10.8&nbsp;&#25805;&#20316;&#36890;&#30693;&#23545;&#35937;</h2></div></div></div>

<p>&#24403;&#20320;&#21019;&#24314;&#20102;AOP&#20195;&#29702;, &#20320;&#21487;&#20197;&#36890;&#36807;<code class="literal">org.springframework.aop.framework.Advised</code>&#25509;&#21475;&#26469;&#25805;&#20316;&#23427;&#20204;. &#25152;&#26377;&#30340;
AOP&#20195;&#29702;&#37117;&#21487;&#20197;&#31867;&#22411;&#36716;&#25442;&#21040;&#36825;&#20010;&#25509;&#21475;, &#19981;&#31649;&#23427;&#23454;&#29616;&#30340;&#20854;&#20182;&#25509;&#21475;. &#35813;&#25509;&#21475;&#21253;&#21547;&#20102;&#22914;&#19979;&#30340;&#26041;&#27861;:</p>
<pre class="programlisting">Advisor[] getAdvisors();

<span class="hl-keyword">void</span> addAdvice(Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvice(<span class="hl-keyword">int</span> pos, Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(<span class="hl-keyword">int</span> pos, Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">int</span> indexOf(Advisor advisor);

<span class="hl-keyword">boolean</span> removeAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> removeAdvisor(<span class="hl-keyword">int</span> index) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> replaceAdvisor(Advisor a, Advisor b) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> isFrozen();</pre>

<p>&#26041;&#27861;<code class="literal">getAdvisors()</code>&#23558;&#20250;&#36820;&#22238;&#19968;&#20010;&#21253;&#21547;&#20102;&#25152;&#26377;&#36890;&#30693;&#22120;&#30340;Advisor&#12289;&#25318;&#25130;&#22120;&#25110;&#32773;&#20854;&#20182;&#30340;&#28155;&#21152;&#21040;&#24037;&#21378;&#30340;&#36890;&#30693;&#31867;&#22411;. &#22914;&#26524;
&#20320;&#28155;&#21152;&#20102;&#19968;&#20010;Advisor, &#37027;&#20040;&#22312;&#36820;&#22238;&#30340;&#36890;&#30693;&#22120;&#20013;&#20854;&#32034;&#24341;&#23545;&#24212;&#30340;&#23545;&#35937;&#23558;&#20250;&#23545;&#24212;&#20320;&#25152;&#28155;&#21152;&#30340;. &#22914;&#26524;&#20320;&#28155;&#21152;&#30340;&#26159;&#25318;&#25130;&#22120;&#25110;&#32773;
&#20854;&#20182;&#30340;&#36890;&#30693;&#31867;&#22411;, Spring&#23558;&#20250;&#23558;&#20854;&#21253;&#35013;&#22312;&#19968;&#20010;&#25317;&#26377;&#22987;&#32456;&#36820;&#22238;true&#30340;&#20999;&#20837;&#28857;&#30340;&#36890;&#30693;&#22120;&#20013;. &#20063;&#23601;&#26159;&#35828;, &#22914;&#26524;&#20320;&#28155;&#21152;&#20102;
&#19968;&#20010;<code class="literal">MethodInterceptor</code>, &#37027;&#20040;&#36890;&#30693;&#22120;&#20013;&#22312;&#23545;&#24212;&#32034;&#24341;&#22788;&#23558;&#20250;&#26159;&#19968;&#20010;<code class="literal">DefaultPointcutAdvisor</code>&#26469;&#34920;&#31034;&#20320;&#30340;
<code class="literal">MethodInterceptor</code>&#20197;&#21450;&#19968;&#20010;&#21305;&#37197;&#25152;&#26377;&#31867;&#21644;&#26041;&#27861;&#30340;&#20999;&#20837;&#28857;.</p>
<p><code class="literal">addAdvisor()</code>&#26041;&#27861;&#21487;&#20197;&#29992;&#26469;&#28155;&#21152;&#20219;&#20309;&#30340;Advisor. &#36890;&#24120;&#29992;&#20110;&#25345;&#26377;&#20999;&#20837;&#28857;&#21644;&#36890;&#30693;&#22120;&#30340;advisor&#26159;&#36890;&#29992;&#30340;
<code class="literal">DefaultPointcutAdvisor</code>, &#23427;&#21487;&#20197;&#29992;&#20110;&#20219;&#20309;&#30340;&#36890;&#30693;&#22120;&#25110;&#32773;&#20999;&#20837;&#28857;(&#20294;&#19981;&#29992;&#20110;&#20171;&#32461;).</p>
<p>&#40664;&#35748;&#24773;&#20917;&#19979;, &#28155;&#21152;&#25110;&#32773;&#21024;&#38500;advisor&#25110;&#32773;&#25318;&#25130;&#22120;&#22312;&#20195;&#29702;&#21019;&#24314;&#22909;&#20043;&#21518;&#26159;&#21487;&#34892;&#30340;. &#21807;&#19968;&#30340;&#38480;&#21046;&#26159;&#26377;&#21487;&#33021;&#24403;&#20320;&#28155;&#21152;&#25110;&#32773;&#31227;&#38500;
&#20102;&#19968;&#20010;&#20171;&#32461;&#22411;advisor&#21518;, &#20174;&#24037;&#21378;&#31867;&#21019;&#24314;&#30340;&#24050;&#32463;&#23384;&#22312;&#20102;&#30340;&#20195;&#29702;&#19981;&#20250;&#34920;&#29616;&#20986;&#25509;&#21475;&#30340;&#20462;&#25913;&#26469;. (&#20320;&#21487;&#20197;&#36890;&#36807;&#20174;&#24037;&#21378;&#37325;&#26032;&#33719;&#21462;
&#19968;&#20010;&#26032;&#30340;&#20195;&#29702;&#26469;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;.)</p>
<p>&#19979;&#38754;&#26159;&#19968;&#20010;&#36716;&#25442;&#38754;&#21521;&#20999;&#38754;&#20195;&#29702;(AOP proxy)&#20026;&#19968;&#20010;<code class="literal">Advised</code>&#25509;&#21475;&#24182;&#19988;&#26816;&#26597;&#21644;&#25805;&#20316;&#20182;&#30340;&#36890;&#30693;&#22120;&#30340;&#31616;&#21333;&#20363;&#23376;:</p>
<pre class="programlisting">Advised advised = (Advised) myObject;
Advisor[] advisors = advised.getAdvisors();
<span class="hl-keyword">int</span> oldAdvisorCount = advisors.length;
System.out.println(oldAdvisorCount + <span class="hl-string">" advisors"</span>);

<span class="hl-comment">// &#28155;&#21152;&#36890;&#30693;&#22120;&#20363;&#22914;&#19981;&#24102;&#20999;&#20837;&#28857;&#30340;&#25318;&#25130;&#22120;</span>
<span class="hl-comment">// &#23558;&#20250;&#21305;&#37197;&#25152;&#26377;&#30340;&#20195;&#29702;&#26041;&#27861;</span>
<span class="hl-comment">// &#21487;&#29992;&#20110;&#25318;&#25130;&#22120;&#12289;&#22312;&#36820;&#22238;&#25110;&#32773;&#25243;&#20986;&#24322;&#24120;&#20043;&#21069;&#12289;&#20043;&#21518;</span>
advised.addAdvice(<span class="hl-keyword">new</span> DebugInterceptor());

<span class="hl-comment">// &#20351;&#29992;&#20999;&#20837;&#28857;&#28155;&#21152;&#36873;&#25321;&#30340;&#36890;&#30693;&#22120;</span>
advised.addAdvisor(<span class="hl-keyword">new</span> DefaultPointcutAdvisor(mySpecialPointcut, myAdvice));

assertEquals(<span class="hl-string">"Added two advisors"</span>, oldAdvisorCount + <span class="hl-number">2</span>, advised.getAdvisors().length);</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#23545;&#19994;&#21153;&#23545;&#35937;&#20462;&#25913;&#36890;&#30693;&#22120;&#26159;&#21542;&#26159;&#26126;&#26234;&#30340;(&#27809;&#26377;&#21452;&#20851;&#35821;&#24847;), &#21363;&#20351;&#37027;&#26159;&#27809;&#26377;&#30097;&#38382;&#30340;&#21512;&#27861;&#20351;&#29992;, &#36825;&#26159;&#23500;&#26377;&#20105;&#35758;&#30340;. &#28982;&#32780;, &#23427;&#22312;
&#24320;&#21457;&#20013;&#26159;&#24456;&#26377;&#29992;&#30340;: &#20363;&#22914;, &#22312;&#27979;&#35797;&#20013;. &#25105;&#26377;&#26102;&#20505;&#21457;&#35273;&#23427;&#26159;&#24456;&#26377;&#29992;&#30340;&#29992;&#26469;&#21521;&#25318;&#25130;&#22120;&#30340;&#34920;&#21333;&#37324;&#38754;&#28155;&#21152;&#20195;&#30721;&#25110;&#32773;&#20854;&#20182;&#36890;&#30693;&#22120;,
&#20351;&#24471;&#36827;&#20837;&#25105;&#24819;&#27979;&#35797;&#30340;&#26041;&#27861;&#35843;&#29992;. (&#20363;&#22914;, &#36890;&#30693;&#22120;&#21487;&#20197;&#36827;&#20837;&#19968;&#20010;&#26041;&#27861;&#21019;&#24314;&#22909;&#30340;&#20107;&#21153;&#20013;: &#20363;&#22914;, &#22312;&#26631;&#35760;&#20107;&#21153;&#22238;&#28378;&#20043;&#21069;, &#36816;&#34892;
&#19968;&#20010;SQL&#26469;&#26816;&#26597;&#25968;&#25454;&#24211;&#24050;&#32463;&#34987;&#27491;&#30830;&#30340;&#26356;&#26032;&#20102;.)</p>
</td></tr></table></div>

<p>&#21462;&#20915;&#20110;&#20320;&#26159;&#24590;&#26679;&#21019;&#24314;&#30340;&#20195;&#29702;, &#20320;&#36890;&#24120;&#37117;&#21487;&#20197;&#35774;&#32622;&#19968;&#20010;<code class="literal">frozen</code>&#26631;&#24535;&#20301;, &#36825;&#26679;<code class="literal">Advised</code> <code class="literal">isFrozen()</code>&#26041;&#27861;&#37117;&#23558;
&#36820;&#22238;true, &#24182;&#19988;&#20219;&#20309;&#35797;&#22270;&#36890;&#36807;&#28155;&#21152;&#25110;&#32773;&#31227;&#38500;&#20462;&#25913;&#36890;&#30693;&#22120;&#37117;&#23558;&#20135;&#29983;<code class="literal">AopConfigException</code>. &#19968;&#20010;advised&#23545;&#35937;&#30340;&#23553;&#20923;
&#29366;&#24577;&#30340;&#33021;&#21147;&#22312;&#26576;&#20123;&#24773;&#20917;&#19979;&#26159;&#24456;&#26377;&#29992;&#30340;, &#20363;&#22914;, &#38459;&#27490;&#35843;&#29992;&#20195;&#30721;&#26469;&#31227;&#38500;&#23433;&#20840;&#25318;&#25130;&#22120;. &#23427;&#20063;&#21487;&#20197;&#34987;&#29992;&#20110;Spring 1.1&#20013;&#26469;&#20801;&#35768;
&#31215;&#26497;&#30340;&#20248;&#21270;&#22914;&#26524;&#36816;&#34892;&#26102;&#30340;&#36890;&#30693;&#22120;&#20462;&#25913;&#26159;&#24050;&#30693;&#30340;&#19981;&#38656;&#35201;&#30340;.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-autoproxy" href="#aop-autoproxy"></a>10.9&nbsp;Using the "auto-proxy" facility</h2></div></div></div>

<p>So far we&#8217;ve considered explicit creation of AOP proxies using a <code class="literal">ProxyFactoryBean</code> or
similar factory bean.</p>
<p>Spring also allows us to use "auto-proxy" bean definitions, which can automatically
proxy selected bean definitions. This is built on Spring "bean post processor"
infrastructure, which enables modification of any bean definition as the container loads.</p>
<p>In this model, you set up some special bean definitions in your XML bean definition file
to configure the auto proxy infrastructure. This allows you just to declare the targets
eligible for auto-proxying: you don&#8217;t need to use <code class="literal">ProxyFactoryBean</code>.</p>
<p>There are two ways to do this:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Using an auto-proxy creator that refers to specific beans in the current context.
</li><li class="listitem">
A special case of auto-proxy creation that deserves to be considered separately;
auto-proxy creation driven by source-level metadata attributes.
</li></ul></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-autoproxy-choices" href="#aop-autoproxy-choices"></a>10.9.1&nbsp;Autoproxy bean definitions</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.framework.autoproxy</code> package provides the following
standard auto-proxy creators.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy" href="#aop-api-autoproxy"></a>BeanNameAutoProxyCreator</h4></div></div></div>

<p>The <code class="literal">BeanNameAutoProxyCreator</code> class is a <code class="literal">BeanPostProcessor</code> that automatically creates
AOP proxies for beans with names matching literal values or wildcards.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beanNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdk*,onlyJdk"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As with <code class="literal">ProxyFactoryBean</code>, there is an <code class="literal">interceptorNames</code> property rather than a list
of interceptors, to allow correct behavior for prototype advisors. Named "interceptors"
can be advisors or any advice type.</p>
<p>As with auto proxying in general, the main point of using <code class="literal">BeanNameAutoProxyCreator</code> is
to apply the same configuration consistently to multiple objects, with minimal volume of
configuration. It is a popular choice for applying declarative transactions to multiple
objects.</p>
<p>Bean definitions whose names match, such as "jdkMyBean" and "onlyJdk" in the above
example, are plain old bean definitions with the target class. An AOP proxy will be
created automatically by the <code class="literal">BeanNameAutoProxyCreator</code>. The same advice will be applied
to all matching beans. Note that if advisors are used (rather than the interceptor in
the above example), the pointcuts may apply differently to different beans.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy-default" href="#aop-api-autoproxy-default"></a>DefaultAdvisorAutoProxyCreator</h4></div></div></div>

<p>A more general and extremely powerful auto proxy creator is
<code class="literal">DefaultAdvisorAutoProxyCreator</code>. This will automagically apply eligible advisors in the
current context, without the need to include specific bean names in the auto-proxy
advisor&#8217;s bean definition. It offers the same merit of consistent configuration and
avoidance of duplication as <code class="literal">BeanNameAutoProxyCreator</code>.</p>
<p>Using this mechanism involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Specifying a <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition.
</li><li class="listitem">
Specifying any number of Advisors in the same or related contexts. Note that these
<span class="emphasis"><em>must</em></span> be Advisors, not just interceptors or other advices. This is necessary
because there must be a pointcut to evaluate, to check the eligibility of each advice
to candidate bean definitions.
</li></ul></div>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> will automatically evaluate the pointcut contained
in each advisor, to see what (if any) advice it should apply to each business object
(such as "businessObject1" and "businessObject2" in the example).</p>
<p>This means that any number of advisors can be applied automatically to each business
object. If no pointcut in any of the advisors matches any method in a business object,
the object will not be proxied. As bean definitions are added for new business objects,
they will automatically be proxied if necessary.</p>
<p>Autoproxying in general has the advantage of making it impossible for callers or
dependencies to obtain an un-advised object. Calling getBean("businessObject1") on this
ApplicationContext will return an AOP proxy, not the target business object. (The "inner
bean" idiom shown earlier also offers this benefit.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- Properties omitted --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject2"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> is very useful if you want to apply the same advice
consistently to many business objects. Once the infrastructure definitions are in place,
you can simply add new business objects without including specific proxy configuration.
You can also drop in additional aspects very easily - for example, tracing or
performance monitoring aspects - with minimal change to configuration.</p>
<p>The DefaultAdvisorAutoProxyCreator offers support for filtering (using a naming
convention so that only certain advisors are evaluated, allowing use of multiple,
differently configured, AdvisorAutoProxyCreators in the same factory) and ordering.
Advisors can implement the <code class="literal">org.springframework.core.Ordered</code> interface to ensure
correct ordering if this is an issue. The TransactionAttributeSourceAdvisor used in the
above example has a configurable order value; the default setting is unordered.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy-abstract" href="#aop-api-autoproxy-abstract"></a>AbstractAdvisorAutoProxyCreator</h4></div></div></div>

<p>This is the superclass of DefaultAdvisorAutoProxyCreator. You can create your own
auto-proxy creators by subclassing this class, in the unlikely event that advisor
definitions offer insufficient customization to the behavior of the framework
<code class="literal">DefaultAdvisorAutoProxyCreator</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-autoproxy-metadata" href="#aop-autoproxy-metadata"></a>10.9.2&nbsp;Using metadata-driven auto-proxying</h3></div></div></div>

<p>A particularly important type of auto-proxying is driven by metadata. This produces a
similar programming model to .NET <code class="literal">ServicedComponents</code>. Instead of defining metadata in
XML descriptors, configuration for transaction management and other enterprise services
is held in source-level attributes.</p>
<p>In this case, you use the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, in combination with Advisors
that understand metadata attributes. The metadata specifics are held in the pointcut
part of the candidate advisors, rather than in the auto-proxy creation class itself.</p>
<p>This is really a special case of the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, but deserves
consideration on its own. (The metadata-aware code is in the pointcuts contained in the
advisors, not the AOP framework itself.)</p>
<p>The <code class="literal">/attributes</code> directory of the JPetStore sample application shows the use of
attribute-driven auto-proxying. In this case, there&#8217;s no need to use the
<code class="literal">TransactionProxyFactoryBean</code>. Simply defining transactional attributes on business
objects is sufficient, because of the use of metadata-aware pointcuts. The bean
definitions include the following code, in <code class="literal">/WEB-INF/declarativeServices.xml</code>. Note that
this is generic, and can be used outside the JPetStore:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.AttributesTransactionAttributeSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"attributes"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.metadata.commons.CommonsAttributes"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition (the name is not significant, hence
it can even be omitted) will pick up all eligible pointcuts in the current application
context. In this case, the "transactionAdvisor" bean definition, of type
<code class="literal">TransactionAttributeSourceAdvisor</code>, will apply to classes or methods carrying a
transaction attribute. The TransactionAttributeSourceAdvisor depends on a
TransactionInterceptor, via constructor dependency. The example resolves this via
autowiring. The <code class="literal">AttributesTransactionAttributeSource</code> depends on an implementation of
the <code class="literal">org.springframework.metadata.Attributes</code> interface. In this fragment, the
"attributes" bean satisfies this, using the Jakarta Commons Attributes API to obtain
attribute information. (The application code must have been compiled using the Commons
Attributes compilation task.)</p>
<p>The <code class="literal">/annotation</code> directory of the JPetStore sample application contains an analogous
example for auto-proxying driven by JDK 1.5+ annotations. The following configuration
enables automatic detection of Spring&#8217;s <code class="literal">Transactional</code> annotation, leading to implicit
proxies for beans containing that annotation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">TransactionInterceptor</code> defined here depends on a <code class="literal">PlatformTransactionManager</code>
definition, which is not included in this generic file (although it could be) because it
will be specific to the application&#8217;s transaction requirements (typically JTA, as in
this example, or Hibernate, JDO or JDBC):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you require only declarative transaction management, using these generic XML
definitions will result in Spring automatically proxying all classes or methods with
transaction attributes. You won&#8217;t need to work directly with AOP, and the programming
model is similar to that of .NET ServicedComponents.</p>
</td></tr></table></div>

<p>This mechanism is extensible. It&#8217;s possible to do auto-proxying based on custom
attributes. You need to:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Define your custom attribute.
</li><li class="listitem">
Specify an Advisor with the necessary advice, including a pointcut that is triggered
by the presence of the custom attribute on a class or method. You may be able to use
an existing advice, merely implementing a static pointcut that picks up the custom
attribute.
</li></ul></div>

<p>It&#8217;s possible for such advisors to be unique to each advised class (for example, mixins):
they simply need to be defined as prototype, rather than singleton, bean definitions.
For example, the <code class="literal">LockMixin</code> introduction interceptor from the Spring test suite,
shown above, could be used in conjunction with a generic <code class="literal">DefaultIntroductionAdvisor</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockMixin"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"test.mixin.LockMixin"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockableAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.DefaultIntroductionAdvisor"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"lockMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that both <code class="literal">lockMixin</code> and <code class="literal">lockableAdvisor</code> are defined as prototypes.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-targetsource" href="#aop-targetsource"></a>10.10&nbsp;Using TargetSources</h2></div></div></div>

<p>Spring offers the concept of a <span class="emphasis"><em>TargetSource</em></span>, expressed in the
<code class="literal">org.springframework.aop.TargetSource</code> interface. This interface is responsible for
returning the "target object" implementing the join point. The <code class="literal">TargetSource</code>
implementation is asked for a target instance each time the AOP proxy handles a method
invocation.</p>
<p>Developers using Spring AOP don&#8217;t normally need to work directly with TargetSources, but
this provides a powerful means of supporting pooling, hot swappable and other
sophisticated targets. For example, a pooling TargetSource can return a different target
instance for each invocation, using a pool to manage instances.</p>
<p>If you do not specify a TargetSource, a default implementation is used that wraps a
local object. The same target is returned for each invocation (as you would expect).</p>
<p>Let&#8217;s look at the standard target sources provided with Spring, and how you can use them.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When using a custom target source, your target will usually need to be a prototype
rather than a singleton bean definition. This allows Spring to create a new target
instance when required.</p>
</td></tr></table></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-swap" href="#aop-ts-swap"></a>10.10.1&nbsp;Hot swappable target sources</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.target.HotSwappableTargetSource</code> exists to allow the target
of an AOP proxy to be switched while allowing callers to keep their references to it.</p>
<p>Changing the target source&#8217;s target takes effect immediately. The
<code class="literal">HotSwappableTargetSource</code> is threadsafe.</p>
<p>You can change the target via the <code class="literal">swap()</code> method on HotSwappableTargetSource as follows:</p>
<pre class="programlisting">HotSwappableTargetSource swapper = (HotSwappableTargetSource) beanFactory.getBean(<span class="hl-string">"swapper"</span>);
Object oldTarget = swapper.swap(newTarget);</pre>

<p>The XML definitions required look as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"initialTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"mycompany.OldTarget"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.HotSwappableTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"initialTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swappable"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"swapper"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above <code class="literal">swap()</code> call changes the target of the swappable bean. Clients who hold a
reference to that bean will be unaware of the change, but will immediately start hitting
the new target.</p>
<p>Although this example doesn&#8217;t add any advice - and it&#8217;s not necessary to add advice to
use a <code class="literal">TargetSource</code> - of course any <code class="literal">TargetSource</code> can be used in conjunction with
arbitrary advice.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-pool" href="#aop-ts-pool"></a>10.10.2&nbsp;Pooling target sources</h3></div></div></div>

<p>Using a pooling target source provides a similar programming model to stateless session
EJBs, in which a pool of identical instances is maintained, with method invocations
going to free objects in the pool.</p>
<p>A crucial difference between Spring pooling and SLSB pooling is that Spring pooling can
be applied to any POJO. As with Spring in general, this service can be applied in a
non-invasive way.</p>
<p>Spring provides out-of-the-box support for Jakarta Commons Pool 1.3, which provides a
fairly efficient pooling implementation. You&#8217;ll need the commons-pool Jar on your
application&#8217;s classpath to use this feature. It&#8217;s also possible to subclass
<code class="literal">org.springframework.aop.target.AbstractPoolingTargetSource</code> to support any other
pooling API.</p>
<p>Sample configuration is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObjectTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyBusinessObject"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    ... properties omitted
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.CommonsPoolTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the target object - "businessObjectTarget" in the example - <span class="emphasis"><em>must</em></span> be a
prototype. This allows the <code class="literal">PoolingTargetSource</code> implementation to create new instances
of the target to grow the pool as necessary. See the javadocs of
<code class="literal">AbstractPoolingTargetSource</code> and the concrete subclass you wish to use for information
about its properties: "maxSize" is the most basic, and always guaranteed to be present.</p>
<p>In this case, "myInterceptor" is the name of an interceptor that would need to be
defined in the same IoC context. However, it isn&#8217;t necessary to specify interceptors to
use pooling. If you want only pooling, and no other advice, don&#8217;t set the
interceptorNames property at all.</p>
<p>It&#8217;s possible to configure Spring so as to be able to cast any pooled object to the
<code class="literal">org.springframework.aop.target.PoolingConfig</code> interface, which exposes information
about the configuration and current size of the pool through an introduction. You&#8217;ll
need to define an advisor like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolConfigAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.MethodInvokingFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"getPoolingConfigMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This advisor is obtained by calling a convenience method on the
<code class="literal">AbstractPoolingTargetSource</code> class, hence the use of MethodInvokingFactoryBean. This
advisor&#8217;s name ("poolConfigAdvisor" here) must be in the list of interceptors names in
the ProxyFactoryBean exposing the pooled object.</p>
<p>The cast will look as follows:</p>
<pre class="programlisting">PoolingConfig conf = (PoolingConfig) beanFactory.getBean(<span class="hl-string">"businessObject"</span>);
System.out.println(<span class="hl-string">"Max pool size is "</span> + conf.getMaxSize());</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Pooling stateless service objects is not usually necessary. We don&#8217;t believe it should
be the default choice, as most stateless objects are naturally thread safe, and instance
pooling is problematic if resources are cached.</p>
</td></tr></table></div>

<p>Simpler pooling is available using auto-proxying. It&#8217;s possible to set the TargetSources
used by any auto-proxy creator.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-prototype" href="#aop-ts-prototype"></a>10.10.3&nbsp;Prototype target sources</h3></div></div></div>

<p>Setting up a "prototype" target source is similar to a pooling TargetSource. In this
case, a new instance of the target will be created on every method invocation. Although
the cost of creating a new object isn&#8217;t high in a modern JVM, the cost of wiring up the
new object (satisfying its IoC dependencies) may be more expensive. Thus you shouldn&#8217;t
use this approach without very good reason.</p>
<p>To do this, you could modify the <code class="literal">poolTargetSource</code> definition shown above as follows.
(I&#8217;ve also changed the name, for clarity.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"prototypeTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.PrototypeTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There&#8217;s only one property: the name of the target bean. Inheritance is used in the
TargetSource implementations to ensure consistent naming. As with the pooling target
source, the target bean must be a prototype bean definition.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-threadlocal" href="#aop-ts-threadlocal"></a>10.10.4&nbsp;ThreadLocal target sources</h3></div></div></div>

<p><code class="literal">ThreadLocal</code> target sources are useful if you need an object to be created for each
incoming request (per thread that is). The concept of a <code class="literal">ThreadLocal</code> provide a JDK-wide
facility to transparently store resource alongside a thread. Setting up a
<code class="literal">ThreadLocalTargetSource</code> is pretty much the same as was explained for the other types
of target source:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadlocalTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.ThreadLocalTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>ThreadLocals come with serious issues (potentially resulting in memory leaks) when
incorrectly using them in a multi-threaded and multi-classloader environments. One
should always consider wrapping a threadlocal in some other class and never directly use
the <code class="literal">ThreadLocal</code> itself (except of course in the wrapper class). Also, one should
always remember to correctly set and unset (where the latter simply involved a call to
<code class="literal">ThreadLocal.set(null)</code>) the resource local to the thread. Unsetting should be done in
any case since not unsetting it might result in problematic behavior. Spring&#8217;s
ThreadLocal support does this for you and should always be considered in favor of using
ThreadLocals without other proper handling code.</p>
</td></tr></table></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-extensibility" href="#aop-extensibility"></a>10.11&nbsp;&#23450;&#20041;&#26032;&#30340;&#36890;&#30693;&#31867;&#22411;</h2></div></div></div>

<p>Spring AOP &#26159;&#35774;&#35745;&#20026;&#21487;&#25193;&#23637;&#30340;&#12290;&#34429;&#28982;&#25318;&#25130;&#23454;&#29616;&#31574;&#30053;&#30446;&#21069;&#22312;&#20869;&#37096;&#20351;&#29992;&#65292;&#20294;&#26159;&#23427;&#21487;&#20197;&#25903;&#25345;&#38500;&#24320;&#31665;&#21363;&#29992;&#30340;&#29615;&#32469;&#36890;&#30693;&#12289;&#21069;&#32622;&#36890;&#30693;&#12289;&#24322;&#24120;&#36890;&#30693;&#21644;&#21518;&#32622;&#36890;&#30693;&#22806;&#30340;&#20219;&#24847;&#36890;&#30693;&#31867;&#22411;&#12290;</p>
<p><code class="literal">org.springframework.aop.framework.adapter</code>&#21253;&#26159;&#19968;&#20010;SPI&#21253;&#65292;&#23427;&#25903;&#25345;&#20801;&#35768;&#22312;&#19981;&#25913;&#21464;&#26680;&#24515;&#26694;&#26550;&#30340;&#24773;&#20917;&#19979;&#28155;&#21152;&#26032;&#30340;&#36890;&#30693;&#31867;&#22411;&#12290;&#23450;&#20041;<code class="literal">Advice</code>&#31867;&#22411;&#30340;&#21807;&#19968;&#38480;&#21046;&#26159;&#24517;&#39035;&#32487;&#25215;<code class="literal">org.aopalliance.aop.Advice</code>&#26631;&#35760;&#25509;&#21475;&#12290;</p>
<p>&#35831;&#21442;&#32771;<code class="literal">org.springframework.aop.framework.adapter</code>&#25991;&#26723;&#20102;&#35299;&#26356;&#22810;&#20449;&#24687;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-resources" href="#aop-api-resources"></a>10.12&nbsp;&#26356;&#22810;&#36164;&#28304;</h2></div></div></div>

<p>&#35831;&#21442;&#32771;Spring&#31034;&#20363;&#24212;&#29992;&#20013;&#26356;&#22810;&#20851;&#20110;Spring AOP&#30340;&#20363;&#23376;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
JPetStore&#30340;&#40664;&#35748;&#37197;&#32622;&#35828;&#26126;&#20102;&#22914;&#20309;&#20351;&#29992;<code class="literal">TransactionProxyFactoryBean</code>&#29992;&#20110;&#22768;&#26126;&#24335;&#20107;&#21153;&#31649;&#29702;&#12290;
</li><li class="listitem">
JPetStore&#30340;<code class="literal">/attributes</code>&#30446;&#24405;&#35828;&#26126;&#20102;&#22914;&#20309;&#20351;&#29992;&#23646;&#24615;&#39537;&#21160;&#30340;&#22768;&#26126;&#24335;&#20107;&#21153;&#31649;&#29702;&#12290;
== &#27979;&#35797;
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-introduction" href="#testing-introduction"></a>10.13&nbsp;Spring &#27979;&#35797;&#26694;&#26550;&#20171;&#32461;</h2></div></div></div>

<p>&#27979;&#35797;&#26159;&#20225;&#19994;&#32423;&#36719;&#20214;&#24320;&#21457;&#20013;&#19981;&#21487;&#25110;&#32570;&#30340;&#19968;&#37096;&#20998;&#12290; &#26412;&#31456;&#32858;&#28966;&#20110;Ioc&#21407;&#21017;&#22312;<a class="link" href="aop-api.html#unit-testing" title="10.14&nbsp;&#21333;&#20803;&#27979;&#35797;">&#21333;&#20803;&#27979;&#35797;</a>&#20013;&#30340;
&#38468;&#21152;&#20215;&#20540;&#20197;&#21450;Spring&#26694;&#26550;&#20026;<a class="link" href="aop-api.html#integration-testing" title="10.15&nbsp;&#38598;&#25104;&#27979;&#35797;">&#38598;&#25104;&#27979;&#35797;</a>&#24102;&#26469;&#30340;&#30410;&#22788;&#12290;
<span class="emphasis"><em>(&#20225;&#19994;&#20013;&#23545;&#27979;&#35797;&#30340;&#23436;&#25972;&#22788;&#29702;&#36229;&#20986;&#20102;&#26412;&#21442;&#32771;&#25163;&#20876;&#30340;&#33539;&#22260;&#12290;)</em></span></p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="unit-testing" href="#unit-testing"></a>10.14&nbsp;&#21333;&#20803;&#27979;&#35797;</h2></div></div></div>

<p>&#30456;&#27604;&#22312;&#20256;&#32479;Java EE&#19979;&#24320;&#21457;&#65292;&#20381;&#36182;&#27880;&#20837;&#20351;&#20320;&#30340;&#20195;&#30721;&#26356;&#23569;&#30340;&#20381;&#36182;&#23481;&#22120;&#12290;&#36890;&#36807;&#31616;&#21333;&#30340;<code class="literal">new</code>&#25805;&#20316;&#65292;&#26500;&#25104;&#20320;&#24212;&#29992;
&#30340;POJOs&#23545;&#35937;&#21363;&#21487;&#22312;JUnit&#25110;TestNG&#19979;&#27979;&#35797;&#12290; <span class="emphasis"><em>&#21363;&#20351;&#26159;&#27809;&#26377;Spring&#25110;&#32773;&#20854;&#20182;&#23481;&#22120;</em></span>,&#20320;&#21487;&#20197;&#20351;&#29992; <a class="link" href="aop-api.html#mock-objects" title="10.14.1&nbsp;&#27169;&#25311;&#23545;&#35937;">&#27169;&#25311;&#23545;&#35937;</a>
(&#32852;&#21512;&#20854;&#20182;&#26377;&#20215;&#20540;&#30340;&#27979;&#35797;&#25216;&#26415;) &#29420;&#31435;&#27979;&#35797;&#20320;&#30340;&#20195;&#30721;&#12290; &#22914;&#26524;&#20320;&#36981;&#24490;&#20102;Spring&#30340;&#26550;&#26500;&#24314;&#35758;, &#28165;&#26224;&#30340;&#20998;&#23618;&#21644;&#32452;&#20214;&#21270;&#30340;&#20195;&#30721;&#23558;&#20250;&#20419;&#36827;
&#21333;&#20803;&#27979;&#35797;&#30340;&#31616;&#21270;&#12290;&#20363;&#22914;&#65292;&#24403;&#36816;&#34892;&#21333;&#20803;&#27979;&#35797;&#30340;&#26102;&#20505;&#65292;&#20320;&#21487;&#20197;&#36890;&#36807;&#23384;&#26681;&#20195;&#30721;&#12289;&#27169;&#25311;DAO&#25110;&#32773;&#26159;&#36164;&#28304;&#24211;&#25509;&#21475;&#27979;&#35797;&#26381;&#21153;&#23618;&#23545;&#35937;&#32780;&#19981;&#29992;&#35775;&#38382;
&#25345;&#20037;&#23618;&#25968;&#25454;&#12290;</p>
<p>&#21363;&#20351;&#27809;&#26377;&#36816;&#34892;&#26102;&#22522;&#30784;&#35774;&#26045;&#35774;&#32622;&#65292;&#30495;&#27491;&#30340;&#21333;&#20803;&#27979;&#35797;&#20856;&#22411;&#30340;&#35201;&#27714;&#26159;&#24555;&#36895;&#22320;&#36816;&#34892;&#12290;&#24378;&#35843;&#30495;&#27491;&#30340;&#21333;&#20803;&#27979;&#35797;&#26159;&#20320;&#24320;&#21457;&#26041;&#27861;&#35770;
&#20013;&#30340;&#19968;&#37096;&#20998;&#23558;&#20250;&#25552;&#39640;&#29983;&#20135;&#29575;&#12290;&#23545;&#20320;&#30340;Ioc-based&#24212;&#29992;&#65292;&#20320;&#21487;&#33021;&#19981;&#38656;&#35201;&#27979;&#35797;&#31456;&#33410;&#26469;&#24110;&#20320;&#20889;&#20986;&#39640;&#25928;&#30340;&#21333;&#20803;&#27979;&#35797;&#12290;
&#23613;&#31649;&#22914;&#27492;&#65292;Spring&#26694;&#26550;&#20026;&#21333;&#20803;&#27979;&#35797;&#22330;&#26223;&#25552;&#20379;&#20102;&#19979;&#21015;&#27169;&#25311;&#23545;&#35937;&#21644;&#27979;&#35797;&#25903;&#25345;&#31867;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mock-objects" href="#mock-objects"></a>10.14.1&nbsp;&#27169;&#25311;&#23545;&#35937;</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-env" href="#mock-objects-env"></a>Environment</h4></div></div></div>

<p><code class="literal">org.springframework.mock.env</code> &#21253;&#21253;&#21547;&#20102;<code class="literal">Environment</code> &#21644; <code class="literal">PropertySource</code>(&#26597;&#30475; <a class="xref" href="beans.html#beans-definition-profiles" title="5.13.1&nbsp;Bean&#23450;&#20041;&#37197;&#32622;&#25991;&#20214;">Section&nbsp;5.13.1, &#8220;Bean&#23450;&#20041;&#37197;&#32622;&#25991;&#20214;&#8221;</a>
&#21644; <a class="xref" href="beans.html#beans-property-source-abstraction" title="5.13.3&nbsp;PropertySource&#30340;&#25277;&#35937;">Section&nbsp;5.13.3, &#8220;PropertySource&#30340;&#25277;&#35937;&#8221;</a>)&#25277;&#35937;&#30340;&#27169;&#25311;&#23454;&#29616;&#12290; <code class="literal">MockEnvironment</code> &#21644;<code class="literal">MockPropertySource</code>
&#23545;<span class="emphasis"><em>out-of-container</em></span>&#20195;&#30721;&#24320;&#21457;&#30340;&#27979;&#35797;&#26159;&#38750;&#24120;&#26377;&#29992;&#30340;&#65292;&#22240;&#20026;&#36825;&#20123;&#20195;&#30721;&#24448;&#24448;&#20381;&#36182;&#20110;&#29305;&#23450;&#29615;&#22659;&#30340;&#23646;&#24615;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-jndi" href="#mock-objects-jndi"></a>JNDI</h4></div></div></div>

<p><code class="literal">org.springframework.mock.jndi</code> &#21253;&#21253;&#21547;&#20102;JNDI SPI&#30340;&#27169;&#25311;&#23454;&#29616;, &#20320;&#21487;&#20197;&#20351;&#29992;&#23427;&#20026;&#27979;&#35797;&#22871;&#20214;&#25110;&#32773;&#29420;&#31435;&#30340;&#24212;&#29992;&#35774;&#32622;&#19968;&#20010;
&#31616;&#21333;&#30340;JNDI&#29615;&#22659;&#12290;&#27604;&#22914;,&#22312;&#27979;&#35797;&#20195;&#30721;&#21644;&#22312;Java EE&#23481;&#22120;&#20013;&#19968;&#26679;&#23545;JDBC <code class="literal">DataSource</code>s &#32465;&#23450;&#30456;&#21516;&#21517;&#23383;&#30340;JNDI&#65292;&#36825;&#26679;&#65292;&#20320;&#23601;
&#21487;&#20197;&#22312;&#27979;&#35797;&#22330;&#26223;&#20013;&#22797;&#29992;&#24212;&#29992;&#37197;&#32622;&#32780;&#19981;&#29992;&#20462;&#25913;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-servlet" href="#mock-objects-servlet"></a>Servlet API</h4></div></div></div>

<p><code class="literal">org.springframework.mock.web</code> &#21253;&#21253;&#21547;&#20102;Servlet API&#27169;&#25311;&#23545;&#35937;&#30340;&#32508;&#21512;&#35774;&#32622;&#65292;&#23450;&#20301;&#26159;&#22312;Spring MVC&#26694;&#26550;&#20013;&#23545;Web&#19978;&#19979;&#25991;
&#21644;&#25511;&#21046;&#22120;&#36827;&#34892;&#27979;&#35797;&#12290;&#36825;&#20123;&#27169;&#25311;&#23545;&#35937;&#30340;&#20351;&#29992;&#27604;&#31867;&#20284; <a class="ulink" href="http://www.easymock.org" target="_top">EasyMock</a>&#25110;&#29616;&#23384;&#30340;Servlet API&#27169;&#25311;&#23545;&#35937;&#22914;
<a class="ulink" href="http://www.mockobjects.com" target="_top">MockObjects</a>&#21160;&#24577;&#30340;&#27169;&#25311;&#23545;&#35937;&#26356;&#26041;&#20415;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-portlet" href="#mock-objects-portlet"></a>Portlet API</h4></div></div></div>

<p><code class="literal">org.springframework.mock.web.portlet</code> &#21253;&#21253;&#21547;&#20102; Portlet API &#27169;&#25311;&#23545;&#35937;&#38598;&#21644;,&#23450;&#20301;ie&#26159;Spring&#30340;Portlet MVC
&#26694;&#26550;&#30340;&#20351;&#29992;&#12290;</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="unit-testing-support-classes" href="#unit-testing-support-classes"></a>10.14.2&nbsp;&#21333;&#20803;&#27979;&#35797;&#25903;&#25345;&#31867;</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="unit-testing-utilities" href="#unit-testing-utilities"></a>&#36890;&#29992;&#32452;&#20214;</h4></div></div></div>

<p><code class="literal">org.springframework.test.util</code> &#21253;&#21253;&#21547; <code class="literal">ReflectionTestUtils</code>&#31867;, &#36825;&#20010;&#31867;&#25552;&#20379;&#20102;&#19968;&#22871;&#22522;&#20110;&#21453;&#23556;&#30340;&#24037;&#20855;&#26041;&#27861;&#12290;
&#24403;&#27979;&#35797;&#24212;&#29992;&#20195;&#30721;&#26102;&#24320;&#21457;&#20154;&#21592;&#22312;&#21333;&#20803;&#25110;&#32773;&#26159;&#38598;&#25104;&#27979;&#35797;&#22330;&#26223;&#20013;&#20351;&#29992;&#36825;&#20123;&#26041;&#27861;&#35774;&#32622;&#19968;&#20010;&#38750;<code class="literal">public</code>&#30340;&#23376;&#27573;&#25110;&#35843;&#29992;&#19968;&#20010;&#38750;<code class="literal">public</code>&#30340;&#35774;&#20540;&#26041;&#27861;
&#20363;&#22914;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#21644;&#39046;&#22495;&#23454;&#20307;&#23545;&#35937;&#20013;&#23646;&#24615;&#30340;<code class="literal">public`setter&#26041;&#27861;&#19981;&#21516;&#65292;&#31867;&#20284;JPA&#21644;Hibernate&#30340;ORM&#26694;&#26550;&#25918;&#20219;&#23545;`private</code>&#25110;<code class="literal">protected</code>&#23376;&#27573;
&#30340;&#35775;&#38382;&#12290;
</li><li class="listitem">
Spring&#23545;&#27880;&#35299;&#30340;&#25903;&#25345;&#65292;&#20363;&#22914;<code class="literal">@Autowired</code>, <code class="literal">@Inject</code>, and <code class="literal">@Resource,</code>
&#23427;&#20026; <code class="literal">private</code> or <code class="literal">protected</code> &#23376;&#27573;&#25552;&#20379;&#20102;&#20381;&#36182;&#27880;&#20837;, setter&#26041;&#27861;&#21644;configuration&#26041;&#27861;&#12290;
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="unit-testing-spring-mvc" href="#unit-testing-spring-mvc"></a>Spring MVC</h4></div></div></div>

<p><code class="literal">org.springframework.test.web</code> &#21253;&#21253;&#21547;<code class="literal">ModelAndViewAssert</code>&#23545;&#35937;, &#20351;&#29992;&#23427;&#20320;&#21487;&#20197;&#32452;&#21512;JUnit,TestNG&#25110;&#32773;&#20219;&#24847;&#20854;&#20182;&#30340;
&#21333;&#20803;&#27979;&#35797;&#26694;&#26550;&#20026;&#20320;&#30340;Spring MVC`ModelAndView`&#23545;&#35937;&#36827;&#34892;&#21333;&#20803;&#27979;&#35797;&#12290;</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Spring MVC Controllers &#21333;&#20803;&#27979;&#35797;"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Spring MVC Controllers &#21333;&#20803;&#27979;&#35797;</th></tr><tr><td align="left" valign="top">

<p>&#20026;&#20102;&#27979;&#35797;&#20320;&#30340; Spring MVC <code class="literal">Controller</code>s, &#21487;&#20197;&#20351;&#29992; <code class="literal">ModelAndViewAssert</code> &#32452;&#21512;<code class="literal">MockHttpServletRequest</code>, <code class="literal">MockHttpSession</code>,
 &#25110;&#32773;&#20854;&#20182;&#26469;&#33258; <a class="link" href="aop-api.html#mock-objects-servlet" title="Servlet API"><code class="literal">org.springframework.mock.web</code></a> &#21253;&#30340;&#23545;&#35937;&#12290;</p>
<p>&#27880;&#24847;: &#30446;&#21069;&#65292;&#22312; Spring 4.0&#20013;, &#21253;<code class="literal">org.springframework.mock.web</code> &#20013;&#30340;&#27169;&#25311;&#23545;&#35937;&#26159;&#22522;&#20110;Servlet 3.0 API &#12290;</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integration-testing" href="#integration-testing"></a>10.15&nbsp;&#38598;&#25104;&#27979;&#35797;</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-overview" href="#integration-testing-overview"></a>10.15.1&nbsp;&#27010;&#35272;</h3></div></div></div>

<p>&#19981;&#38656;&#35201;&#21457;&#24067;&#65288;&#31243;&#24207;&#65289;&#21040;&#20320;&#30340;&#24212;&#29992;&#26381;&#21153;&#22120;&#25110;&#32773;&#36830;&#25509;&#21040;&#20854;&#20182;&#20225;&#19994;&#35774;&#26045;&#30340;&#24773;&#20917;&#19979;&#33021;&#22815;&#25191;&#34892;&#19968;&#20123;&#38598;&#25104;&#27979;&#35797;&#26159;&#38750;&#24120;&#37325;&#35201;&#30340;&#12290;
&#36825;&#33021;&#20351;&#20320;&#27979;&#35797;&#19979;&#36848;&#24773;&#20917;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Spring Ioc&#23481;&#22120;&#19978;&#19979;&#25991;&#30340;&#27491;&#30830;&#20889;&#20837;
</li><li class="listitem">
&#20351;&#29992;JDBC&#25110;&#32773;ORM&#24037;&#20855;&#36827;&#34892;&#25968;&#25454;&#35775;&#38382;&#12290;&#36825;&#21253;&#25324;SQL&#35821;&#21477;&#12289;Hibernate&#26597;&#35810;&#20197;&#21450;JPA&#23454;&#20307;&#26144;&#23556;&#30340;&#27491;&#30830;&#24615;&#65292;&#31867;&#20284;&#31561;&#31561;&#12290;
</li></ul></div>

<p>&#22312;<code class="literal">spring-test</code>&#27169;&#22359;&#20013;&#65292;Spring&#26694;&#26550;&#20026;&#38598;&#25104;&#27979;&#35797;&#25552;&#20379;&#20102;&#31532;&#19968;&#31561;&#32423;&#30340;&#25903;&#25345;&#12290;&#23454;&#38469;&#30340;Jar&#21253;&#30340;&#21517;&#31216;&#21253;&#25324;&#21457;&#24067;&#29256;&#26412;&#30340;
&#21517;&#31216;&#65292;&#20063;&#21487;&#33021;&#21253;&#25324;&#38271;&#21253;&#21517;<code class="literal">org.springframework.test</code>&#30340;&#24418;&#24335;&#12290;&#36825;&#20381;&#36182;&#20320;&#33719;&#21462;&#30340;&#26469;&#28304;&#65288;&#21442;&#38405;<a class="link" href="overview.html#dependency-management" title="2.3.1&nbsp;Dependency Management and Naming Conventions">&#20381;&#36182;&#31649;&#29702;&#31456;&#33410;</a>&#35299;&#37322; &#65289;&#12290;&#36825;&#20010;&#24211;&#21253;&#25324;<code class="literal">org.springframework.test</code>&#21253;&#65292;&#23427;&#20026;&#22312;Sring&#23481;&#22120;&#20013;&#36827;&#34892;&#38598;&#25104;&#27979;&#35797;&#25552;&#20379;
&#19968;&#20123;&#26377;&#20215;&#20540;&#30340;&#31867;&#12290;&#36825;&#20123;&#27979;&#35797;&#19981;&#20381;&#36182;&#24212;&#29992;&#26381;&#21153;&#22120;&#25110;&#32773;&#20854;&#20182;&#21457;&#24067;&#29615;&#22659;&#12290;&#36825;&#20123;&#27979;&#35797;&#27604;&#21333;&#20803;&#27979;&#35797;&#35201;&#24930;&#65292;&#20294;&#26159;&#35201;&#27604;&#31561;&#20215;&#30340;&#20998;&#26512;&#27979;&#35797;
&#25110;&#32773;&#26159;&#20381;&#36182;&#24212;&#29992;&#26381;&#21153;&#22120;&#21457;&#24067;&#30340;&#36828;&#31243;&#27979;&#35797;&#35201;&#24555;&#12290;</p>
<p>&#22312;Spring 2.5&#21450;&#20197;&#21518;&#30340;&#29256;&#26412;&#20013;&#24050;&#32463;&#25552;&#20379;&#20102;&#27880;&#35299;&#39537;&#21160;<a class="link" href="aop-api.html#testcontext-framework" title="10.15.5&nbsp;Spring TestContext Framework">Spring &#27979;&#35797;&#19978;&#19979;&#25991;&#26694;&#26550;</a>&#30340;
&#21333;&#20803;&#27979;&#35797;&#21644;&#38598;&#25104;&#27979;&#35797;&#12290;&#30001;&#20110;Spring &#27979;&#35797;&#19978;&#19979;&#25991;&#26694;&#26550;&#23545;&#23454;&#38469;&#20351;&#29992;&#30340;&#27979;&#35797;&#26694;&#26550;&#26159;&#19981;&#21487;&#30693;&#30340;&#65292;&#25152;&#20197;&#20801;&#35768;&#20351;&#29992;&#21508;&#31181;&#27979;&#35797;&#35774;&#26045;&#65292;
&#22914;JUnit&#65292;TestNG&#31561;&#31561;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-goals" href="#integration-testing-goals"></a>10.15.2&nbsp;&#38598;&#25104;&#27979;&#35797;&#30340;&#30446;&#26631;</h3></div></div></div>

<p>Srping&#30340;&#38598;&#25104;&#27979;&#35797;&#25903;&#25345;&#26377;&#22914;&#19979;&#30340;&#20027;&#35201;&#30446;&#26631;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#22312;&#27979;&#35797;&#26399;&#38388;&#31649;&#29702; <a class="link" href="aop-api.html#testing-ctx-management" title="&#19978;&#19979;&#25991;&#31649;&#29702;&#21644;&#32531;&#23384;">Spring Ioc&#23481;&#22120;&#32531;&#23384;</a> &#12290;
</li><li class="listitem">
&#25552;&#20379; <a class="link" href="aop-api.html#testing-fixture-di" title="&#27979;&#35797;&#22841;&#20855;&#30340;&#20381;&#36182;&#27880;&#20837;">&#27979;&#35797;&#22841;&#20855;&#23454;&#20363;&#30340;&#20381;&#36182;&#27880;&#20837;</a> &#12290;
</li><li class="listitem">
&#22312;&#38598;&#25104;&#27979;&#35797;&#20013;&#25552;&#20379; <a class="link" href="aop-api.html#testing-tx" title="&#20107;&#21153;&#31649;&#29702;">&#20107;&#21153;&#31649;&#29702;</a> &#26041;&#27861;&#12290;
</li><li class="listitem">
&#25552;&#20379; <a class="link" href="aop-api.html#testing-support-classes" title="&#38598;&#25104;&#27979;&#35797;&#25903;&#25345;&#31867;">Spirng&#29305;&#23450;&#30340;&#22522;&#30784;&#31867;</a> &#65292;&#21327;&#21161;&#24320;&#21457;&#20154;&#21592;&#32534;&#20889;&#38598;&#25104;&#27979;&#35797;&#12290;
</li></ul></div>

<p>&#21518;&#32493;&#30340;&#31456;&#33410;&#25551;&#36848;&#27599;&#19968;&#20010;&#30446;&#26631;&#24182;&#25552;&#20379;&#23454;&#29616;&#21644;&#37197;&#32622;&#35814;&#24773;&#30340;&#38142;&#25509;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-ctx-management" href="#testing-ctx-management"></a>&#19978;&#19979;&#25991;&#31649;&#29702;&#21644;&#32531;&#23384;</h4></div></div></div>

<p>Spring TestContext &#26694;&#26550;&#23545;<code class="literal">ApplicationContext</code>s &#21644;<code class="literal">WebApplicationContext</code>s&#20197;&#21450;&#36825;&#20123;
&#19978;&#19979;&#25991;&#30340;&#32531;&#23384;&#25552;&#20379;&#20102;&#19968;&#33268;&#30340;&#21152;&#36733;&#12290;&#23545;&#21152;&#36733;&#30340;&#19978;&#19979;&#25991;&#36827;&#34892;&#32531;&#23384;&#26159;&#37325;&#35201;&#30340;&#65292;&#22240;&#20026;&#21551;&#21160;&#26102;&#38388;&#21487;&#33021;&#20250;&#25104;&#20026;&#19968;&#20010;&#38382;&#39064;&#65292;&#8212;&#8212; &#24182;&#38750;
&#22240;&#20026;Spring&#26412;&#36523;&#30340;&#38382;&#39064;&#65292;&#32780;&#26159;&#22240;&#20026;&#34987;Spring&#23481;&#22120;&#31649;&#29702;&#30340;&#23545;&#35937;&#38656;&#35201;&#33457;&#26102;&#38388;&#36827;&#34892;&#23454;&#20363;&#21270;&#12290;&#20363;&#22914;&#65292;&#19968;&#20010;&#25317;&#26377;50&#21040;100&#20010;
Hibernate&#26144;&#23556;&#25991;&#20214;&#30340;&#39033;&#30446;&#21487;&#33021;&#38656;&#35201;&#29992;&#25481;10&#21040;20&#22937;&#26469;&#21152;&#36733;&#36825;&#20123;&#25991;&#20214;&#65292;&#22312;&#36816;&#34892;&#27599;&#19968;&#20010;&#27979;&#35797;&#22841;&#20855;&#20043;&#21069;&#37117;&#20250;&#20135;&#29983;&#36825;&#31508;
&#24320;&#38144;&#65292;&#36825;&#23558;&#30452;&#25509;&#23548;&#33268;&#24320;&#21457;&#20154;&#21592;&#30340;&#29983;&#20135;&#29575;&#19979;&#38477;&#12290;</p>
<p>&#36825;&#20123;&#31867;&#26377;&#20004;&#31181;&#20856;&#22411;&#30340;&#22768;&#26126;&#26041;&#24335;&#65292;&#19968;&#31181;&#26159;&#22312;XML&#37197;&#32622;&#20803;&#25968;&#25454;&#20013;&#26377;&#19968;&#20010; <span class="emphasis"><em>&#36164;&#28304;&#36335;&#24452;</em></span> &#30340;&#21015;&#34920; &#8212;&#8212;&#36890;&#24120;&#26159;&#22312;&#31867;&#36335;&#24452;&#19979;&#65292;
&#25110;&#32773;&#26159;&#19968;&#20010;&#37197;&#32622;&#24212;&#29992;&#30340; <span class="emphasis"><em>&#27880;&#35299;&#31867;</em></span> &#30340;&#21015;&#34920;&#12290;&#23427;&#20204;&#19982;&#22312;<code class="literal">web.xml</code>&#21457;&#24067;&#25551;&#36848;&#25991;&#20214;&#20013;&#22768;&#26126;&#30340;&#25110;&#32773;&#20854;&#20182;&#30340;&#21457;&#24067;&#37197;&#32622;
&#25991;&#20214;&#26159;&#30456;&#21516;&#25110;&#30456;&#20284;&#30340;&#12290;</p>
<p>&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#19968;&#26086;&#21152;&#36733;&#65292;&#37197;&#32622;&#30340; <code class="literal">ApplicationContext</code> &#23545;&#27599;&#19968;&#20010;&#27979;&#35797;&#37117;&#26159;&#22797;&#29992;&#30340;&#12290;&#22240;&#27492; setup &#30340;&#24320;&#38144;&#22312;&#27599;&#19968;&#20010;
&#27979;&#35797;&#22871;&#20214;&#20013;&#20165;&#20165;&#19968;&#27425;&#65292;&#21518;&#32493;&#30340;&#27979;&#35797;&#25191;&#34892;&#20250;&#26356;&#24555;&#12290;&#36825;&#31181;&#24773;&#20917;&#19979;&#25351;&#30340; <span class="emphasis"><em>&#27979;&#35797;&#22871;&#20214;</em></span> &#24847;&#24605;&#26159;&#36816;&#34892;&#22312;&#21516;&#19968;&#20010;JVM&#20013;&#30340;&#25152;&#26377;&#30340;&#27979;&#35797;&#8212;&#8212;
&#20363;&#22914;&#65292;&#23545;&#25351;&#23450;&#30340;&#39033;&#30446;&#25110;&#27169;&#22359;&#65292;&#26080;&#35770;&#26159;Ant&#12289;Maven&#25110;&#26159;Gradle&#26500;&#24314;&#30340;&#25152;&#26377;&#30340;&#27979;&#35797;&#12290;&#19968;&#20010;&#26497;&#19981;&#21487;&#33021;&#21457;&#29983;&#30340;&#24773;&#20917;&#26159;&#27979;&#35797;&#23849;&#28291;
&#23548;&#33268;&#24212;&#29992;&#19978;&#19979;&#25991;&#30340;&#37325;&#26032;&#21152;&#36733;&#8212;&#8212;&#20363;&#22914;&#65292;&#20462;&#25913;Bean&#23450;&#20041;&#25110;&#32773;&#24212;&#29992;&#23545;&#35937;&#30340;&#29366;&#24577;&#65292;&#36825;&#26102;&#22312;&#25191;&#34892;&#27979;&#35797;&#20043;&#21069;TestContext&#26694;&#26550;&#21487;&#20197;
&#34987;&#37197;&#32622;&#20026;&#37325;&#26032;&#21152;&#36733;&#37197;&#32622;&#21644;&#37325;&#26032;&#26500;&#24314;&#24212;&#29992;&#19978;&#19979;&#25991;&#12290;</p>
<p>&#21442;&#38405;TestContext &#26694;&#26550;&#20013;<a class="xref" href="aop-api.html#testcontext-ctx-management" title="&#19978;&#19979;&#25991;&#31649;&#29702;">the section called &#8220;&#19978;&#19979;&#25991;&#31649;&#29702;&#8221;</a> &#21644; <a class="xref" href="aop-api.html#testcontext-ctx-management-caching" title="Context caching">the section called &#8220;Context caching&#8221;</a>&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-fixture-di" href="#testing-fixture-di"></a>&#27979;&#35797;&#22841;&#20855;&#30340;&#20381;&#36182;&#27880;&#20837;</h4></div></div></div>

<p>&#24403;TestContext &#26694;&#26550;&#21152;&#36733;&#24212;&#29992;&#19978;&#19979;&#25991;&#30340;&#26102;&#20505;&#65292;&#21487;&#36873;&#22320;&#65292;&#20320;&#21487;&#20197;&#20351;&#29992;&#20381;&#36182;&#27880;&#20837;&#30340;&#26041;&#24335;&#37197;&#32622;&#27979;&#35797;&#31867;&#30340;&#23454;&#20363;&#12290;&#23427;&#20026;&#20351;&#29992;&#39044;&#20808;&#37197;&#32622;
&#30340;Bean&#35774;&#32622;&#27979;&#35797;&#22841;&#20855;&#25552;&#20379;&#20102;&#19968;&#20010;&#20415;&#21033;&#30340;&#26426;&#21046;&#12290;&#19968;&#20010;&#24456;&#22823;&#30340;&#22909;&#22788;&#26159;&#20320;&#21487;&#20197;&#36328;&#36234;&#21508;&#31181;&#27979;&#35797;&#22330;&#26223;&#22797;&#29992;&#24212;&#29992;&#19978;&#19979;&#25991;&#12290;&#65288;&#20363;&#22914;&#65292;&#37197;&#32622;
Spring&#31649;&#29702;&#30340;&#23545;&#35937;&#22270;&#65292;&#20107;&#21153;&#20195;&#29702;&#65292; <code class="literal">DataSource</code>s,&#31561;&#65289;&#65292;&#22240;&#27492;&#21487;&#20197;&#36991;&#20813;&#20026;&#29420;&#31435;&#30340;&#27979;&#35797;&#29992;&#20363;&#37325;&#22797;&#22320;&#35774;&#32622;&#22797;&#26434;&#30340;&#27979;&#35797;
&#22841;&#20855;&#12290;</p>
<p>&#20316;&#20026;&#19968;&#20010;&#31034;&#20363;&#65292;&#32771;&#34385;&#22914;&#19979;&#22330;&#26223;&#65306;&#25105;&#20204;&#26377;&#19968;&#20010;&#31867;, <code class="literal">HibernateTitleRepository</code> &#20026;&#39046;&#22495;&#23454;&#20307; <code class="literal">Title</code> &#23454;&#29616;&#20102;&#25968;&#25454;&#35775;&#38382;
&#36923;&#36753;&#12290;&#25105;&#20204;&#24819;&#20889;&#19968;&#20010;&#38598;&#25104;&#27979;&#35797;&#65292;&#27979;&#35797;&#22914;&#19979;&#24773;&#20917;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Spring&#37197;&#32622;&#65306;&#19982; <code class="literal">HibernateTitleRepository</code> bean&#37197;&#32622;&#30456;&#20851;&#25152;&#26377;&#19996;&#35199;&#30340;&#27491;&#30830;&#24615; &#65311;
</li><li class="listitem">
Hibernate &#26144;&#23556;&#25991;&#20214;&#37197;&#32622;&#65306;&#26144;&#23556;&#30340;&#27491;&#30830;&#24615;&#65292;lazy-loading&#35774;&#32622;&#27491;&#30830;&#24615;&#65311;
</li><li class="listitem">
<code class="literal">HibernateTitleRepository</code>&#23545;&#35937;&#30340;&#36923;&#36753;&#65306;&#37197;&#32622;&#30340;&#36825;&#20010;&#31867;&#30340;&#23454;&#20363;&#26159;&#21542;&#36798;&#21040;&#20102;&#39044;&#26399;&#65311;
</li></ul></div>

<p>&#21442;&#38405;&#22312;<a class="link" href="aop-api.html#testcontext-fixture-di" title="Dependency injection of test fixtures">TestContext framework</a>&#20013;&#20351;&#29992;&#27979;&#35797;&#22841;&#20855;&#30340;&#20381;&#36182;&#27880;&#20837;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-tx" href="#testing-tx"></a>&#20107;&#21153;&#31649;&#29702;</h4></div></div></div>

<p>&#27979;&#35797;&#20013;&#19968;&#20010;&#36890;&#24120;&#30340;&#38382;&#39064;&#26159;&#35775;&#38382;&#30495;&#23454;&#30340;&#25968;&#25454;&#24211;&#23545;&#25345;&#20037;&#21270;&#23384;&#20648;&#29366;&#24577;&#30340;&#24433;&#21709;&#12290;&#29978;&#33267;&#20320;&#20351;&#29992;&#24320;&#21457;&#25968;&#25454;&#24211;&#65292;&#29366;&#24577;&#30340;&#21464;&#21270;&#21487;&#33021;&#24433;&#21709;&#23558;&#26469;&#30340;&#27979;&#35797;&#12290;
&#21478;&#22806;&#65292;&#35768;&#22810;&#25805;&#20316;&#65292;&#22914;&#25554;&#20837;&#25110;&#20462;&#25913;&#25345;&#20037;&#21270;&#25968;&#25454;&#8212;&#8212;&#19981;&#33021;&#22312;&#20107;&#21153;&#22806;&#25191;&#34892;&#65288;&#25110;&#39564;&#35777;&#65289;&#12290;</p>
<p>TestContext &#26694;&#26550;&#23450;&#20301;&#20102;&#36825;&#20010;&#38382;&#39064;&#12290;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#26694;&#26550;&#23558;&#23545;&#27599;&#19968;&#20010;&#27979;&#35797;&#21019;&#24314;&#24182;&#22238;&#28378;&#19968;&#20010;&#20107;&#21153;&#12290;&#20320;&#21487;&#20197;&#20551;&#35774;&#20107;&#21153;&#30340;&#23384;&#22312;&#65292;
&#32780;&#31616;&#21333;&#22320;&#20889;&#20195;&#30721;&#12290;&#22312;&#20320;&#30340;&#27979;&#35797;&#20013;&#65292;&#22914;&#26524;&#35843;&#29992;&#20102;&#19968;&#20010;&#20107;&#21153;&#24615;&#30340;&#20195;&#29702;&#23545;&#35937;&#65292;&#26681;&#25454;&#23545;&#23427;&#20204;&#30340;&#20107;&#21153;&#35821;&#20041;&#37197;&#32622;&#65292;&#23427;&#20204;&#23558;&#20250;&#34892;&#20026;&#27491;&#30830;&#22320;&#25191;&#34892;&#12290;
&#21478;&#22806;&#65292;&#22312;&#27979;&#35797;&#20013;&#65292;&#24403;&#36816;&#34892;&#22312;&#21463;&#31649;&#20107;&#21153;&#20013;&#26102;&#65292;&#22914;&#26524;&#19968;&#20010;&#26041;&#27861;&#21024;&#38500;&#20102;&#36873;&#23450;&#34920;&#30340;&#20869;&#23481;&#65292;&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#20107;&#21153;&#23558;&#20250;&#22238;&#28378;&#65292;&#25968;&#25454;&#24211;&#23558;&#20250;&#36820;&#22238;&#21040;
&#25191;&#34892;&#27979;&#35797;&#21069;&#30340;&#29366;&#24577;&#12290;&#22312;&#27979;&#35797;&#20013;&#20107;&#21153;&#30340;&#25903;&#25345;&#26159;&#36890;&#36807;&#22312;&#24212;&#29992;&#19978;&#19979;&#25991;&#20013;&#23450;&#19968;&#20010;bean <code class="literal">PlatformTransactionManager</code> &#12290;</p>
<p>&#22914;&#26524;&#20320;&#24819;&#25552;&#20132;&#19968;&#20010;&#20107;&#21153;&#8212;&#8212;&#26497;&#23569;&#20986;&#29616;&#20294;&#20598;&#26377;&#21457;&#29983;&#65292;&#24403;&#20320;&#35201;&#19968;&#20010;&#29305;&#23450;&#30340;&#27979;&#35797;&#26469;&#36801;&#31227;&#25110;&#20462;&#25913;&#25968;&#25454;&#24211;&#8212;&#8212;TestContext&#26694;&#26550;&#21487;&#20197;&#36890;&#36807;&#27880;&#35299;
<a class="link" href="aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;&#27880;&#35299;"><code class="literal">@TransactionConfiguration</code></a> &#21644;
<a class="link" href="aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;&#27880;&#35299;"><code class="literal">@Rollback</code></a>&#25552;&#31034;&#36827;&#34892;&#20107;&#21153;&#25552;&#20132;&#32780;&#19981;&#26159;&#20107;&#21153;&#22238;&#28378;&#12290;</p>
<p>&#21442;&#38405;&#20351;&#29992;<a class="link" href="aop-api.html#testcontext-tx" title="Transaction management">TestContext &#26694;&#26550;</a>&#36827;&#34892;&#20107;&#21153;&#31649;&#29702;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-support-classes" href="#testing-support-classes"></a>&#38598;&#25104;&#27979;&#35797;&#25903;&#25345;&#31867;</h4></div></div></div>

<p>Spring TestContext &#26694;&#26550;&#20026;&#31616;&#21270;&#38598;&#25104;&#27979;&#35797;&#30340;&#32534;&#20889;&#25552;&#20379;&#20102;&#20960;&#20010; <code class="literal">abstract</code> &#25903;&#25345;&#31867;&#12290;&#36825;&#20123;&#22522;&#30784;&#31867;&#25552;&#20379;&#20102;&#23450;&#20041;&#33391;&#22909;&#30340;&#38057;&#23376;&#20197;&#21450;
&#20415;&#21033;&#30340;&#23454;&#20363;&#21464;&#37327;&#21644;&#26041;&#27861;&#65292;&#20197;&#20415;&#20320;&#33021;&#22815;&#35775;&#38382;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ApplicationContext</code>&#23545;&#35937;&#65292;&#20026;&#20102;&#26174;&#24335;bean&#30340;&#26597;&#25214;&#20197;&#21450;&#25972;&#20010;&#19978;&#19979;&#25991;&#29366;&#24577;&#30340;&#27979;&#35797;&#12290;
</li><li class="listitem">
<code class="literal">JdbcTemplate</code>&#23545;&#35937;&#65292;&#20026;&#20102;&#25191;&#34892;SQL&#35821;&#21477;&#26597;&#35810;&#25968;&#25454;&#24211;&#12290;&#36825;&#20123;&#26597;&#35810;&#65292;&#21487;&#20197;&#29992;&#26469;&#30830;&#35748;&#25968;&#25454;&#24211;&#30456;&#20851;&#30340;&#20195;&#30721;&#25191;&#34892; <span class="emphasis"><em>&#21069;&#21518;</em></span> &#25968;&#25454;&#24211;&#29366;&#24577;&#12290;
Spring &#36824;&#20445;&#35777;&#36825;&#20123;&#20195;&#30721;&#19982;&#24212;&#29992;&#20195;&#30721;&#36816;&#34892;&#22312;&#30456;&#21516;&#30340;&#20107;&#21153;&#26041;&#20301;&#20869;&#12290;&#24403;&#32852;&#21512;&#20351;&#29992;ORM&#24037;&#20855;&#20351;&#29992;&#26102;&#65292;&#30830;&#20445;&#36991;&#20813;<a class="link" href="aop-api.html#testcontext-tx-false-positives" title="Avoid false positives when testing ORM code">false positives</a>
&#38382;&#39064;&#12290;
</li></ul></div>

<p>&#21478;&#22806;&#65292;&#20320;&#21487;&#33021;&#24819;&#21019;&#24314;&#33258;&#23450;&#20041;&#30340;&#65292;&#24212;&#29992;&#33539;&#22260;&#30340;&#36229;&#31867;&#12290;&#36825;&#20123;&#36229;&#31867;&#25317;&#26377;&#23454;&#20363;&#29305;&#23450;&#20110;&#20320;&#30340;&#39033;&#30446;&#30340;&#21464;&#37327;&#21644;&#26041;&#27861;&#12290;</p>
<p>&#35831;&#21442;&#38405;<a class="link" href="aop-api.html#testcontext-support-classes" title="TestContext Framework support classes">TestContext &#26694;&#26550;</a>&#25903;&#25345;&#31867;&#12290;</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-support-jdbc" href="#integration-testing-support-jdbc"></a>10.15.3&nbsp;JDBC &#27979;&#35797;&#25903;&#25345;</h3></div></div></div>

<p><code class="literal">org.springframework.test.jdbc</code> &#21253;&#21253;&#21547;&#20102; <code class="literal">JdbcTestUtils</code>&#24037;&#20855;&#31867;&#65292;&#23427;&#26159;&#20010;JDBC&#30456;&#20851;&#30340;&#21151;&#33021;&#24037;&#20855;&#38598;&#65292;&#20027;&#35201;&#29992;&#26469;
&#24212;&#23545;&#31616;&#21270;&#26631;&#20934;&#21270;&#25968;&#25454;&#24211;&#30340;&#27979;&#35797;&#22330;&#26223;&#12290; <code class="literal">JdbcTestUtils</code> &#24037;&#20855;&#31867;&#25552;&#20379;&#20102;&#19979;&#21015;&#38745;&#24577;&#24037;&#20855;&#26041;&#27861;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">countRowsInTable(..)</code>: &#23545;&#25351;&#23450;&#30340;&#34920;&#36827;&#34892;&#34892;&#35745;&#25968;
</li><li class="listitem">
<code class="literal">countRowsInTableWhere(..)</code>: &#20351;&#29992;&#25552;&#20379;&#30340;<code class="literal">WHERE</code> &#26465;&#20214;&#23545;&#25351;&#23450;&#30340;&#34920;&#36827;&#34892;&#34892;&#35745;&#25968;
</li><li class="listitem">
<code class="literal">deleteFromTables(..)</code>: &#23545;&#25351;&#23450;&#30340;&#34920;&#21024;&#38500;&#25152;&#26377;&#30340;&#34892;
</li><li class="listitem">
<code class="literal">deleteFromTableWhere(..)</code>: &#20351;&#29992;&#25552;&#20379;&#30340;<code class="literal">WHERE</code> &#26465;&#20214;&#23545;&#25351;&#23450;&#30340;&#34920;&#21024;&#38500;&#35760;&#24405;
</li><li class="listitem">
<code class="literal">dropTables(..)</code>: &#21024;&#38500;&#25351;&#23450;&#30340;&#34920;
</li></ul></div>

<p><span class="emphasis"><em>&#27880;&#24847;&#65292;<a class="link" href="aop-api.html#testcontext-support-classes-junit4" title="JUnit support classes"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code></a>
&#21644;<a class="link" href="aop-api.html#testcontext-support-classes-testng" title="TestNG support classes"><code class="literal">AbstractTransactionalTestNGSpringContextTests</code></a>&#20013;&#25552;&#20379;
&#30340;&#20415;&#21033;&#26041;&#27861;&#26159;&#22996;&#25176;&#32473;&#20102;&#21069;&#36848; <code class="literal">JdbcTestUtils</code> &#24037;&#20855;&#31867;&#20013;&#30340;&#26041;&#27861;&#12290;</em></span></p>
<p><code class="literal">spring-jdbc</code> &#27169;&#22359;&#25552;&#20379;&#20102;&#23545;&#37197;&#32622;&#21644;&#21551;&#21160;&#19968;&#20010;&#23884;&#20837;&#24335;&#25968;&#25454;&#24211;&#30340;&#25903;&#25345;&#65292;&#23427;&#21487;&#20197;&#29992;&#26469;&#22312;&#38598;&#25104;&#27979;&#35797;&#29992;&#19982;&#25968;&#25454;&#24211;&#36827;&#34892;&#20132;&#20114;&#12290;&#35814;&#24773;
&#35831;&#21442;&#38405;<a class="xref" href="jdbc.html#jdbc-embedded-database-support" title="13.8&nbsp;Embedded database support">Section&nbsp;13.8, &#8220;Embedded database support&#8221;</a> &#21644; <a class="xref" href="jdbc.html#jdbc-embedded-database-dao-testing" title="13.8.8&nbsp;Testing data access logic with an embedded database">Section&nbsp;13.8.8, &#8220;Testing data access logic with an embedded database&#8221;</a>&#30456;&#20851;&#31456;&#33410;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-annotations" href="#integration-testing-annotations"></a>10.15.4&nbsp;&#27880;&#35299;</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-spring" href="#integration-testing-annotations-spring"></a>Spring &#27979;&#35797;&#30456;&#20851;&#27880;&#35299;</h4></div></div></div>

<p>Spring&#26694;&#26550;&#25552;&#20379;&#20102;&#19968;&#32452;<span class="emphasis"><em>Spring&#29305;&#23450;</em></span>&#30340;&#27880;&#35299;&#65292;&#20320;&#21487;&#20197;&#22312;&#27979;&#35797;&#20013;&#32852;&#21512;TestContext&#26694;&#26550;&#36827;&#34892;&#21333;&#20803;&#25110;&#32773;&#26159;&#38598;&#25104;&#27979;&#35797;&#12290;
&#24819;&#35201;&#33719;&#24471;&#36827;&#19968;&#27493;&#30340;&#20449;&#24687;&#65292;&#21253;&#25324;&#40664;&#35748;&#20540;&#12289;&#23646;&#24615;&#21035;&#21517;&#31561;&#31561;&#65292;&#35831;&#21442;&#38405;&#30456;&#20851;&#30340;javadocs&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><code class="literal">@ContextConfiguration</code></p>
<p class="simpara">&#23450;&#20041;&#31867;&#32423;&#21035;&#30340;&#20803;&#25968;&#25454;&#65292;&#29992;&#26469;&#20915;&#23450;&#22914;&#20309;&#20026;&#38598;&#25104;&#27979;&#35797;&#21152;&#36733;&#21644;&#37197;&#32622;&#19968;&#20010; <code class="literal">ApplicationContext</code>&#12290;<code class="literal">@ContextConfiguration</code>
&#29992;&#26469;&#22768;&#26126;&#24212;&#29992;&#19978;&#19979;&#25991;&#36164;&#28304;&#30340; <code class="literal">locations</code> &#25110;&#32773;&#21152;&#20102;&#27880;&#35299;&#30340;&#34987;&#29992;&#26469;&#21152;&#36733;&#19978;&#19979;&#25991;&#30340; <code class="literal">classes</code>&#12290;</p>
<p class="simpara">&#36164;&#28304;&#36335;&#24452;&#20856;&#22411;&#30340;&#26159;&#20301;&#20110;&#31867;&#36335;&#24452;&#20013;&#30340;XML&#37197;&#32622;&#25991;&#20214;&#65307;&#32780;&#27880;&#35299;&#30340;&#31867;&#20856;&#22411;&#30340;&#26159;&#21152;&#20102;&#27880;&#35299; <code class="literal">@Configuration</code> &#30340;&#31867;&#12290;&#23613;&#31649;&#22914;&#27492;
&#36164;&#28304;&#36335;&#24452;&#20063;&#21487;&#20197;&#26159;&#25191;&#34892;&#25991;&#20214;&#31995;&#32479;&#20013;&#30340;&#25991;&#20214;&#65292;&#27880;&#35299;&#30340;&#31867;&#21487;&#20197;&#26159;&#32452;&#20214;&#31867;&#31561;&#31561;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="hl-string">"/test-config.xml"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> XmlApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>classes</strong></span> = TestConfig.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConfigClassApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">&#23545;&#22768;&#26126;&#36164;&#28304;&#31867;&#36335;&#24452;&#25110;&#27880;&#35299;&#31867;&#32780;&#35328;&#65292;&#20316;&#20026;&#19968;&#20010;&#21487;&#36873;&#30340;&#25110;&#32773;&#26159;&#38468;&#21152;&#30340;&#26041;&#24335;&#65292;<code class="literal">@ContextConfiguration</code>&#21487;&#20197;&#34987;&#29992;&#26469;&#25351;&#23450;
&#29992;&#20110;&#33258;&#23450;&#20041;&#30340; <code class="literal">ApplicationContextInitializer</code> &#25509;&#21475;&#30340;&#23454;&#29616;&#31867;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>initializers</strong></span> = CustomContextIntializer.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextInitializerTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara"><code class="literal">@ContextConfiguration</code>&#20063;&#21487;&#20197;&#21487;&#36873;&#22320;&#34987;&#29992;&#26469;&#22768;&#26126; <code class="literal">ContextLoader</code> &#31574;&#30053;&#12290;&#27880;&#24847;&#65292;&#23613;&#31649;&#22914;&#27492;&#65292;&#20856;&#22411;&#24615;&#24773;&#20917;&#19979;
&#20320;&#19981;&#24517;&#26174;&#24335;&#37197;&#32622;&#21152;&#36733;&#22120;&#65292;&#22240;&#20026;&#40664;&#35748;&#30340;&#21152;&#36733;&#20854;&#26082;&#25903;&#25345;&#36164;&#28304; <code class="literal">locations</code> &#25110;&#27880;&#35299; <code class="literal">classes</code> &#20063;&#25903;&#25345; <code class="literal">initializers</code> &#21021;&#22987;&#22120;&#26041;&#24335;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>locations</strong></span> = <span class="hl-string">"/test-context.xml"</span>, <span class="strong"><strong>loader</strong></span> = CustomContextLoader.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomLoaderXmlApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ContextConfiguration</code> &#40664;&#35748;&#22320;&#25552;&#20379;&#20102;&#23545;&#36164;&#28304;&#36335;&#24452;&#25110;&#37197;&#32622;&#31867;&#20197;&#21450;&#30001;&#36229;&#31867;&#22768;&#26126;&#30340;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#30340; <span class="emphasis"><em>&#32487;&#25215;</em></span> &#26426;&#21046;&#12290;</p>
</td></tr></table></div>

<p class="simpara">&#21442;&#38405; <a class="xref" href="aop-api.html#testcontext-ctx-management" title="&#19978;&#19979;&#25991;&#31649;&#29702;">the section called &#8220;&#19978;&#19979;&#25991;&#31649;&#29702;&#8221;</a> &#21644;  <code class="literal">@ContextConfiguration</code> javadocs &#36827;&#19968;&#27493;&#20102;&#35299;&#35814;&#24773;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@WebAppConfiguration</code></p>
<p class="simpara">&#20026;&#38598;&#25104;&#27979;&#35797;&#21152;&#36733;&#30340;&#20351;&#29992;&#31867;&#32423;&#27880;&#35299;&#22768;&#26126;&#30340; <code class="literal">ApplicationContext</code> &#23545;&#35937;&#24212;&#35813;&#26159;&#19968;&#20010; <code class="literal">WebApplicationContext</code>
&#23545;&#35937;&#12290;&#22312;&#27979;&#35797;&#31867;&#19978;&#23384;&#22312;<code class="literal">@WebAppConfiguration</code> &#22522;&#26412;&#20215;&#20540;&#26159;&#22312;&#27979;&#35797;&#20013;&#30830;&#20445;&#19968;&#20010; <code class="literal">WebApplicationContext</code>
&#23545;&#35937;&#34987;&#21152;&#36733;&#65292;&#35813;&#23545;&#35937;&#20351;&#29992;&#40664;&#35748;&#20540; <code class="literal">"file:src/main/webapp"</code> &#20316;&#20026;web&#24212;&#29992;&#65288;&#20363;&#22914;&#65292;<span class="emphasis"><em>&#36164;&#28304;&#22522;&#26412;&#36335;&#24452;</em></span>&#65289;&#30340;&#26681;
&#36335;&#24452;&#12290;&#36164;&#28304;&#22522;&#26412;&#36335;&#24452;&#34987;&#29992;&#26469;&#22312; <code class="literal">WebApplicationContext</code> &#27979;&#35797;&#20013;&#21019;&#24314;&#19968;&#20010;&#27169;&#25311; <code class="literal">ServletContext</code> &#23545;&#35937;&#30340;
<code class="literal">MockServletContext</code> &#27169;&#25311;&#23545;&#35937;&#26469;&#25552;&#20379;&#26381;&#21153;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@WebAppConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebAppTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">&#35201;&#35206;&#30422;&#40664;&#35748;&#20540;&#65292;&#21487;&#20197;&#36890;&#36807; <span class="emphasis"><em>&#22266;&#26377;</em></span> <code class="literal">value</code> &#23646;&#24615;&#25351;&#23450;&#21478;&#22806;&#19968;&#20010;&#22522;&#30784;&#36164;&#28304;&#36335;&#24452;&#12290;&#36164;&#28304;&#21069;&#32512;&#25903;&#25345; <code class="literal">classpath:</code> &#21644;
<code class="literal">file:</code> &#20004;&#31181;&#26041;&#24335;&#12290; &#22914;&#26524;&#27809;&#26377;&#25351;&#23450;&#36164;&#28304;&#21069;&#32512;&#65292;&#21017;&#40664;&#35748;&#20026;&#25991;&#20214;&#31995;&#32479;&#36164;&#28304;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@WebAppConfiguration("classpath:test-web-resources")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebAppTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">&#27880;&#24847;&#65306; <code class="literal">@WebAppConfiguration</code> &#24517;&#39035;&#21644;&#32852;&#21512; <code class="literal">@ContextConfiguration</code> &#19968;&#36215;&#20351;&#29992;&#65292;&#21516;&#26102;&#38656;&#35201;&#22312;&#21333;&#20010;
&#27979;&#35797;&#31867;&#25110;&#32773;&#26159;&#22312;&#19968;&#20010;&#27979;&#35797;&#31867;&#30340;&#23618;&#27425;&#20869;&#12290; &#21442;&#32771; <code class="literal">@WebAppConfiguration</code> javadocs &#20102;&#35299;&#35814;&#24773;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@ContextHierarchy</code></p>
<p class="simpara">&#19968;&#20010;&#31867;&#32423;&#21035;&#30340;&#27880;&#35299;&#65292;&#29992;&#26469;&#20026;&#38598;&#25104;&#27979;&#35797;&#23450;&#20041; <code class="literal">ApplicationContext</code>s &#30340;&#23618;&#27425;&#12290; <code class="literal">@ContextHierarchy</code> &#22768;&#26126;&#30340;
&#26102;&#20505;&#24212;&#35813;&#21253;&#21547;&#19968;&#20010;&#25110;&#22810;&#20010; <code class="literal">@ContextConfiguration</code> &#23454;&#20363;&#30340;&#21015;&#34920;&#12290;&#22312;&#19978;&#19979;&#25991;&#23618;&#27425;&#20013;&#65292;&#27599;&#19968;&#20010;&#23454;&#20363;&#37117;&#23450;&#20041;&#20102;&#19968;&#20010;&#32423;&#21035;&#12290;
&#19979;&#38754;&#30340;&#31034;&#20363;&#28436;&#31034;&#20102;&#21333;&#20010;&#27979;&#35797;&#31867;&#20013; <code class="literal">@ContextHierarchy</code> &#30340;&#20351;&#29992;&#65307;&#23613;&#31649;&#22914;&#27492;&#65292; <code class="literal">@ContextHierarchy</code>&#20063;&#21487;&#20197;&#34987;&#29992;&#22312;
&#19968;&#20010;&#27979;&#35797;&#31867;&#23618;&#27425;&#20013;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration("/parent-config.xml"),
    @ContextConfiguration("/child-config.xml")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextHierarchyTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(classes = AppConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">&#22914;&#26524;&#20320;&#38656;&#35201;&#22312;&#19968;&#20010;&#27979;&#35797;&#31867;&#23618;&#27425;&#20013;&#21512;&#24182;&#25110;&#35206;&#30422;&#25351;&#23450;&#30340;&#19978;&#19979;&#25991;&#23618;&#27425;&#30340;&#32423;&#21035;&#65292;&#22312;&#27599;&#19968;&#20010;&#31867;&#23618;&#27425;&#30340;&#30456;&#20851;&#32423;&#21035;&#20013;&#65292;&#20320;&#24517;&#39035;&#36890;&#36807;&#20026;
<code class="literal">@ContextConfiguration</code> &#30340; <code class="literal">name</code> &#23646;&#24615;&#25552;&#20379;&#30456;&#21516;&#30340;&#20540;&#26174;&#24335;&#21629;&#21517;&#37027;&#20010;&#32423;&#21035;&#12290;&#35831;&#21442;&#32771; <a class="xref" href="aop-api.html#testcontext-ctx-management-ctx-hierarchies" title="Context hierarchies">the section called &#8220;Context hierarchies&#8221;</a>
&#21644; <code class="literal">@ContextHierarchy</code> javadocs &#20102;&#35299;&#36827;&#19968;&#27493;&#30340;&#20363;&#23376;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@ActiveProfiles</code></p>
<p class="simpara">&#19968;&#20010;&#31867;&#32423;&#21035;&#30340;&#27880;&#35299;&#65292;&#29992;&#26469;&#22768;&#26126;&#24403;&#20026;&#27979;&#35797;&#31867;&#21152;&#36733;&#19968;&#20010; <code class="literal">ApplicationContext</code>&#26102;&#65292;&#21738;&#20123; <span class="emphasis"><em>bean &#23450;&#20041;&#37197;&#32622;</em></span> &#24212;&#35813;
&#34987;&#28608;&#27963;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@ActiveProfiles</strong></span>(<span class="hl-string">"dev"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DeveloperTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@ActiveProfiles</strong></span>({<span class="hl-string">"dev"</span>, <span class="hl-string">"integration"</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DeveloperIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;<code class="literal">@ActiveProfiles</code> &#25552;&#20379;&#20102;&#23545; <span class="emphasis"><em>&#32487;&#25215;</em></span> &#36229;&#31867;&#22768;&#26126;&#30340;&#27963;bean&#23450;&#20041;&#37197;&#32622;&#30340;&#25903;&#25345;&#12290;&#20063;&#21487;&#20197;&#20351;&#29992;&#32534;&#31243;&#30340;
&#26041;&#24335;&#26469;&#35299;&#26512;&#24050;&#28608;&#27963;bean&#23450;&#20041;&#37197;&#32622;&#65292;&#21482;&#38656;&#19968;&#20010;<a class="link" href="aop-api.html#testcontext-ctx-management-env-profiles-ActiveProfilesResolver"><code class="literal">ActiveProfilesResolver</code></a>
&#30340;&#33258;&#23450;&#20041;&#23454;&#29616;&#24182;&#19988;&#36890;&#36807; <code class="literal">@ActiveProfiles</code> &#30340; <code class="literal">resolver</code> &#23646;&#24615;&#36827;&#34892;&#27880;&#20876;&#12290;</p>
</td></tr></table></div>

<p class="simpara">&#21442;&#32771; <a class="xref" href="aop-api.html#testcontext-ctx-management-env-profiles" title="&#20351;&#29992;&#29615;&#22659;&#27010;&#35201;&#36827;&#34892;&#19978;&#19979;&#25991;&#37197;&#32622;">the section called &#8220;&#20351;&#29992;&#29615;&#22659;&#27010;&#35201;&#36827;&#34892;&#19978;&#19979;&#25991;&#37197;&#32622;&#8221;</a> &#21644; <code class="literal">@ActiveProfiles</code> javadocs&#20102;&#35299;&#31034;&#20363;&#21644;
&#36827;&#19968;&#27493;&#30340;&#35814;&#24773;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TestPropertySource</code></p>
<p class="simpara">&#19968;&#20010;&#31867;&#32423;&#21035;&#30340;&#27880;&#35299;&#65292;&#29992;&#26469;&#37197;&#32622;&#23646;&#24615;&#25991;&#20214;&#21644;&#20869;&#32852;&#23646;&#24615;&#30340;&#20301;&#32622;&#65292;&#22312;&#38598;&#25104;&#27979;&#35797;&#30340;<code class="literal">ApplicationContext</code> &#23545;&#35937;&#21152;&#36733;&#30340;&#26102;&#20505;&#65292;
&#36825;&#20123;&#23646;&#24615;&#35201;&#34987;&#21152;&#21040; <code class="literal">PropertySources</code> &#30340; <code class="literal">Environment</code>&#30340;&#35774;&#32622;&#20013;&#12290;</p>
<p class="simpara">&#27979;&#35797;&#23646;&#24615;&#28304;&#27604;&#25805;&#20316;&#31995;&#32479;&#29615;&#22659;&#21152;&#36733;&#30340;&#23646;&#24615;&#12289;Java&#31995;&#32479;&#23646;&#24615;&#12289;&#24212;&#29992;&#36890;&#36807; <code class="literal">@PropertySource</code> &#25110;&#32534;&#31243;&#26041;&#24335;&#22768;&#26126;&#30340;&#23646;&#24615;&#26377;&#26356;&#39640;
&#20248;&#20808;&#32423;&#12290;&#22240;&#27492;&#65292;&#27979;&#35797;&#23646;&#24615;&#28304;&#21487;&#20197;&#34987;&#29992;&#26469;&#21487;&#36873;&#22320;&#35206;&#30422;&#31995;&#32479;&#25110;&#32773;&#24212;&#29992;&#23450;&#20041;&#30340;&#23646;&#24615;&#28304;&#12290;&#27492;&#22806;&#65292;&#20869;&#32852;&#23646;&#24615;&#27604;&#22312;&#36164;&#28304;&#36335;&#24452;&#20013;&#21152;&#36733;&#30340;&#23646;&#24615;
&#26377;&#26356;&#39640;&#30340;&#20248;&#20808;&#32423;&#12290;</p>
<p class="simpara">&#19979;&#36848;&#31034;&#20363;&#28436;&#31034;&#20102;&#22914;&#20309;&#36890;&#36807;&#31867;&#36335;&#24452;&#22768;&#26126;&#19968;&#20010;&#23646;&#24615;&#25991;&#20214;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TestPropertySource</strong></span>(<span class="hl-string">"/test.properties"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">&#19979;&#36848;&#31034;&#20363;&#28436;&#31034;&#20102;&#22914;&#20309;&#22768;&#26126; <span class="emphasis"><em>&#20869;&#32852;</em></span> &#30340;&#23646;&#24615;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TestPropertySource</strong></span>(properties = { <span class="hl-string">"timezone = GMT"</span>, <span class="hl-string">"port: 4242"</span> })
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@DirtiesContext</code></p>
<p class="simpara">&#25351;&#31034;Spring&#30340; <code class="literal">ApplicationContext</code> &#22312;&#27979;&#35797;&#25191;&#34892;&#26399;&#38388;&#65288;&#20363;&#22914;&#65306; &#20197;&#26576;&#31181;&#26041;&#24335;&#34987;&#20462;&#25913;&#25110;&#36973;&#21040;&#30772;&#22351;&#8212;&#8212; &#20363;&#22914;&#21333;&#20363;&#30340;
&#29366;&#24577;&#34987;&#25913;&#21464;&#65289;&#24050;&#32463; <span class="emphasis"><em>&#21464;&#33039;</em></span> &#65292;&#19981;&#31649;&#27979;&#35797;&#26159;&#21542;&#36890;&#36807;&#37117;&#24212;&#35813;&#20851;&#38381;&#12290; &#19968;&#26086;&#24212;&#29992;&#19978;&#19979;&#25991;&#34987;&#26631;&#35760;&#20026; <span class="emphasis"><em>dirty</em></span> &#65292;&#23427;&#24212;&#35813;&#20174;
&#26694;&#26550;&#30340;&#32531;&#23384;&#20013;&#28165;&#38500;&#24182;&#20851;&#38381;&#12290; &#22240;&#27492;&#65292; &#25509;&#19979;&#26469;Spring&#23481;&#22120;&#23558;&#20250;&#20026;&#21518;&#32493;&#30340;&#20381;&#36182;&#30456;&#21516;&#37197;&#32622;&#20803;&#25968;&#25454;&#30340;&#27979;&#35797;&#36827;&#34892;&#37325;&#24314;&#12290;</p>
<p class="simpara"><code class="literal">@DirtiesContext</code> &#22312;&#21516;&#19968;&#20010;&#27979;&#35797;&#31867;&#20013;&#21487;&#20197;&#21516;&#26102;&#29992;&#20316;&#31867;&#32423;&#21035;&#30340;&#21644;&#26041;&#27861;&#32423;&#21035;&#30340;&#27880;&#35299;&#12290;&#22312;&#36825;&#31181;&#22330;&#26223;&#19979;&#65292;&#25972;&#20010;&#31867;&#24050;&#32463;&#25152;&#26377;&#21152;&#27880;&#20102;
&#36825;&#20010;&#27880;&#35299;&#30340;&#26041;&#27861;&#20043;&#21518;&#65292; <code class="literal">ApplicationContext</code> &#37117;&#34987;&#26631;&#35760;&#20026; <span class="emphasis"><em>dirty</em></span> &#12290; &#22914;&#26524; <code class="literal">ClassMode</code> &#35774;&#32622;&#20026; <code class="literal">AFTER_EACH_TEST_METHOD</code>
,&#22312;&#31867;&#20013;&#30340;&#27599;&#19968;&#20010;&#27979;&#35797;&#26041;&#27861;&#20043;&#21518;&#65292;&#19978;&#19979;&#25991;&#23558;&#34987;&#26631;&#35760;&#20026; <span class="emphasis"><em>dirty</em></span> &#12290;</p>
<p class="simpara">&#19979;&#36848;&#30340;&#31034;&#20363;&#38024;&#23545;&#21508;&#31181;&#37197;&#32622;&#22330;&#26223;&#35299;&#37322;&#20102;&#19978;&#19979;&#25991;&#20309;&#26102;&#21464;&#33039;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<p class="simpara">&#24403;&#21069;&#30340;&#27979;&#35797;&#31867;&#20043;&#21518;&#65292;&#31867;&#19978;&#22768;&#26126;&#65292;&#31867;&#27169;&#24335;&#35774;&#32622;&#20026; <code class="literal">AFTER_CLASS</code> &#65288;&#20363;&#22914;&#65306;&#40664;&#35748;&#30340;&#31867;&#27169;&#24335;&#65289;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextDirtyingTests {
    <span class="hl-comment">// &#19968;&#20123;&#23548;&#33268;spring&#23481;&#22120;&#21464;&#33039;&#30340;&#27979;&#35797;</span>
}</pre>

</li><li class="listitem">
<p class="simpara">&#24403;&#21069;&#27979;&#35797;&#31867;&#30340;&#27599;&#19968;&#20010;&#27979;&#35797;&#26041;&#27861;&#20043;&#21518;&#65292;&#31867;&#19978;&#22768;&#26126;&#65292;&#31867;&#27169;&#24335;&#35774;&#32622;&#20026; <code class="literal">AFTER_EACH_TEST_METHOD</code> &#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>(<span class="strong"><strong>classMode</strong></span> = ClassMode.AFTER_EACH_TEST_METHOD)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextDirtyingTests {
    <span class="hl-comment">// &#19968;&#20123;&#23548;&#33268;spring&#23481;&#22120;&#21464;&#33039;&#30340;&#27979;&#35797;</span>
}</pre>

</li><li class="listitem">
<p class="simpara">&#24403;&#21069;&#30340;&#27979;&#35797;&#20043;&#21518;&#65292;&#22312;&#26041;&#27861;&#19978;&#22768;&#26126;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichDirtiesAppCtx() {
    <span class="hl-comment">// &#19968;&#20123;&#23548;&#33268;spring&#23481;&#22120;&#21464;&#33039;&#30340;&#27979;&#35797;</span>
}</pre>

<p class="simpara">&#22914;&#26524;&#19968;&#20010;&#27979;&#35797;&#30340;&#19978;&#19979;&#25991;&#36890;&#36807; <code class="literal">@ContextHierarchy</code> &#34987;&#37197;&#32622;&#20026;&#19978;&#19979;&#25991;&#23618;&#27425;&#20013;&#30340;&#19968;&#37096;&#20998;&#65292; &#21487;&#20197;&#20351;&#29992; <code class="literal">@DirtiesContext</code>
&#27880;&#35299;&#65292;  &#36890;&#36807; <code class="literal">hierarchyMode</code> &#26631;&#24535;&#26469;&#25511;&#21046;&#19978;&#19979;&#25991;&#32531;&#23384;&#30340;&#28165;&#29702;&#12290; &#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#23558;&#20351;&#29992;&#19968;&#20010; <span class="emphasis"><em>EXHAUSTIVE</em></span> &#30340;&#31639;&#27861;&#28165;&#29702;
&#24403;&#21069;&#27979;&#35797;&#20013;&#36890;&#29992;&#30340;&#19978;&#19979;&#25991;&#32531;&#23384;&#65292;&#19981;&#20165;&#21253;&#25324;&#24403;&#21069;&#32423;&#21035;&#32780;&#19988;&#21253;&#25324;&#25152;&#26377;&#20854;&#20182;&#30340;&#20849;&#20139;&#19968;&#20010;&#31062;&#20808;&#30340;&#19978;&#19979;&#25991;&#23618;&#27425;&#12290;&#25152;&#26377;&#30340;&#20303;&#30041;&#22312;&#36890;&#29992;&#31062;&#20808;&#19978;&#19979;
&#25991;&#30340;&#23376;&#23618;&#27425;&#20013;&#30340; <code class="literal">ApplicationContext</code>s &#23558;&#20174;&#32531;&#23384;&#20013;&#28165;&#38500;&#24182;&#20851;&#38381;&#12290; &#22914;&#26524; <span class="emphasis"><em>EXHAUSTIVE</em></span> &#30340;&#31639;&#27861;&#22312;&#29305;&#23450;&#30340;&#29992;&#20363;&#20013;&#28165;&#29702;
&#36807;&#24230;&#65292;&#21487;&#20197;&#36873;&#25321;&#26356;&#31616;&#21333;&#30340; <span class="emphasis"><em>CURRENT_LEVEL</em></span> &#31639;&#27861;&#26469;&#26367;&#25442;&#65292;&#21442;&#32771;&#22914;&#19979;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration("/parent-config.xml"),
    @ContextConfiguration("/child-config.xml")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    @DirtiesContext(<span class="strong"><strong>hierarchyMode = HierarchyMode.CURRENT_LEVEL</strong></span>)
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> test() {
        <span class="hl-comment">// &#19968;&#20123;&#23548;&#33268;&#23376;&#19978;&#19979;&#25991;&#21464;&#33039;&#30340;&#36923;&#36753;</span>
    }
}</pre>

</li></ul></div>

<p class="simpara">&#36827;&#19968;&#27493;&#20102;&#35299; <code class="literal">EXHAUSTIVE</code> &#21644; <code class="literal">CURRENT_LEVEL</code> &#31639;&#27861;&#30340;&#35814;&#24773;&#65292;&#28165;&#21442;&#32771; <code class="literal">DirtiesContext.HierarchyMode</code> javadocs&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TestExecutionListeners</code></p>
<p class="simpara">&#23450;&#20041;&#31867;&#32423;&#21035;&#30340;&#20803;&#25968;&#25454;&#37197;&#32622;&#65292; &#22312; <code class="literal">TestContextManager</code> &#20013;&#27880;&#20876; <code class="literal">TestExecutionListener</code>s &#12290; &#20856;&#22411;&#24773;&#20917;&#19979;&#65292;
<code class="literal">@TestExecutionListeners</code> &#19982;  <code class="literal">@ContextConfiguration</code> &#32852;&#21512;&#20351;&#29992;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TestExecutionListeners</strong></span>({CustomTestExecutionListener.<span class="hl-keyword">class</span>, AnotherTestExecutionListener.<span class="hl-keyword">class</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomTestExecutionListenerTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara"><code class="literal">@TestExecutionListeners</code> &#40664;&#35748;&#24773;&#20917;&#19979;&#25903;&#25345;&#30417;&#21548;&#22120; <span class="emphasis"><em>inherited</em></span> &#12290; &#21442;&#32771;javadocs&#26597;&#30475;&#31034;&#20363;&#21644;&#36827;&#19968;&#27493;&#30340;&#35814;&#24773;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TransactionConfiguration</code></p>
<p class="simpara">&#20026;&#20107;&#21153;&#24615;&#27979;&#35797;&#37197;&#32622;&#31867;&#32423;&#21035;&#30340;&#20803;&#25968;&#25454;&#12290;&#20855;&#20307;&#26469;&#35828;&#65292;&#22914;&#26524;&#22312;&#22312;&#27979;&#35797;&#20013;&#26377;&#22810;&#20010; <code class="literal">PlatformTransactionManager</code> &#31867;&#22411;&#30340;bean,
&#24182;&#19988;&#26399;&#26395;&#30340; <code class="literal">PlatformTransactionManager</code> &#30340;bean&#21517;&#19981;&#26159; "transactionManager"&#65292; <code class="literal">PlatformTransactionManager</code>
&#30340;bean&#21517;&#24212;&#35813;&#34987;&#26174;&#24335;&#22320;&#25351;&#23450;&#26469;&#39537;&#21160;&#20107;&#21153;&#12290;&#21478;&#22806;&#65292;&#20320;&#21487;&#20197;&#25913;&#21464; <code class="literal">defaultRollback</code> &#26631;&#24535;&#20026; <code class="literal">false</code>&#12290; &#20856;&#22411;&#24773;&#20917;&#19979;&#65292;
<code class="literal">@TransactionConfiguration</code> &#21644; <code class="literal">@ContextConfiguration</code> &#34987;&#32852;&#21512;&#20351;&#29992;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TransactionConfiguration</strong></span>(<span class="strong"><strong>transactionManager</strong></span> = <span class="hl-string">"txMgr"</span>, <span class="strong"><strong>defaultRollback</strong></span> = false)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomConfiguredTransactionalTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#22914;&#26524;&#40664;&#35748;&#30340;&#20256;&#32479;&#23545;&#20320;&#30340;&#27979;&#35797;&#37197;&#32622;&#22815;&#29992;&#30340;&#35805;&#65292;&#20320;&#21487;&#20197;&#36991;&#20813; &#19982;  <code class="literal">@TransactionConfiguration</code>  &#19968;&#36215;&#20351;&#29992;&#12290;&#25442;&#21477;&#35805;&#35828;
&#22914;&#26524;&#20320;&#21482;&#26377;&#19968;&#20010;&#20107;&#21153;&#31649;&#29702;&#22120;&#8212;&#8212;&#25110;&#32773;&#20320;&#26377;&#22810;&#20010;&#20107;&#21153;&#31649;&#29702;&#22120;&#65292;&#20294;&#26159;&#20107;&#21153;&#31649;&#29702;&#22120;&#30340;&#21517;&#23383;&#37117;&#26159; "transactionManager" &#25110;&#32773;&#36890;&#36807;
<code class="literal">TransactionManagementConfigurer</code> &#36827;&#34892;&#20102;&#25351;&#23450; &#8212;&#8212; &#24182;&#19988;&#20320;&#24819;&#20107;&#21153;&#33258;&#21160;&#22238;&#28378;&#65292;&#37027;&#20040;&#20320;&#26080;&#38656;&#20351;&#29992;<code class="literal">@TransactionConfiguration</code>
&#27880;&#35299;&#20320;&#30340;&#27979;&#35797;&#31867;&#12290;</p>
</td></tr></table></div>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Rollback</code></p>
<p class="simpara">&#25351;&#31034;&#27880;&#35299;&#30340;&#27979;&#35797;&#26041;&#27861;&#25191;&#34892;&#23436;&#25104;&#20043;&#21518;&#20107;&#21153;&#26159;&#21542;&#24212;&#35813; <span class="emphasis"><em>rolled back</em></span>&#12290; &#22914;&#26524;&#35774;&#32622;&#20026; <code class="literal">true</code> &#65292;&#20107;&#21153;&#23558;&#20250;&#22238;&#28378;&#65292;
&#21542;&#21017;&#65292;&#20107;&#21153;&#23558;&#20250;&#25552;&#20132;&#12290; &#20351;&#29992; <code class="literal">@Rollback</code> &#33021;&#22815;&#35206;&#30422;&#22312;&#31867;&#32423;&#21035;&#37197;&#32622;&#30340;&#40664;&#35748;&#30340;&#22238;&#28378;&#26631;&#24535;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@Rollback</strong></span>(false)
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWithoutRollback() {
    <span class="hl-comment">// ...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@BeforeTransaction</code></p>
<p class="simpara">&#25351;&#31034;&#19968;&#20010; <code class="literal">public void</code> &#26041;&#27861;&#22312;&#20107;&#21153;&#21551;&#21160;&#20043;&#21069;&#25191;&#34892;&#65292;&#36825;&#20010;&#26041;&#27861;&#26159;&#36890;&#36807; <code class="literal">@Transactional</code> &#27880;&#35299;&#37197;&#32622;&#20107;&#21153;&#30340;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@BeforeTransaction</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> beforeTransaction() {
    <span class="hl-comment">// &#22312;&#20107;&#21153;&#21551;&#21160;&#20043;&#21069;&#25191;&#34892;&#30340;&#36923;&#36753;</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@AfterTransaction</code></p>
<p class="simpara">&#25351;&#31034;&#19968;&#20010; <code class="literal">public void</code> &#26041;&#27861;&#22312;&#20107;&#21153;&#25191;&#34892;&#32467;&#26463;&#20043;&#21518;&#25191;&#34892;&#65292;&#36825;&#20010;&#26041;&#27861;&#26159;&#36890;&#36807; <code class="literal">@Transactional</code> &#27880;&#35299;&#37197;&#32622;&#20107;&#21153;&#30340;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@AfterTransaction</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterTransaction() {
    <span class="hl-comment">// &#20107;&#21153;&#25191;&#34892;&#32467;&#26463;&#21518;&#30340;&#36923;&#36753;</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Sql</code></p>
<p class="simpara">&#22312;&#38598;&#25104;&#27979;&#35797;&#20013;&#29992;&#26469;&#23545;&#32473;&#23450;&#30340;&#25968;&#25454;&#24211;&#37197;&#32622;&#35201;&#25191;&#34892;&#30340;SQL&#33050;&#26412;&#65292;&#36825;&#20010;&#27880;&#35299;&#29992;&#22312;&#31867;&#32423;&#21035;&#25110;&#32773;&#26159;&#26041;&#27861;&#32423;&#21035;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="strong"><strong>@Sql</strong></span>({<span class="hl-string">"/test-schema.sql"</span>, <span class="hl-string">"/test-user-data.sql"</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// &#25191;&#34892;&#20381;&#36182;&#30340;&#27979;&#35797;&#25968;&#25454;&#24211;&#21644;&#27979;&#35797;&#25968;&#25454;&#30340;&#20195;&#30721;</span>
}</pre>

<p class="simpara">&#21442;&#38405; <a class="xref" href="aop-api.html#testcontext-executing-sql-declaratively" title="Executing SQL scripts declaratively with @Sql">the section called &#8220;Executing SQL scripts declaratively with <code class="literal">@Sql</code>&#8221;</a>  &#26597;&#30475;&#35814;&#24773;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@SqlConfig</code></p>
<p class="simpara">&#23450;&#20041;&#29992;&#26469;&#20915;&#23450;&#22914;&#20309;&#35299;&#26512;&#21644;&#25191;&#34892;&#36890;&#36807; <code class="literal">@Sql</code> &#27880;&#35299;&#37197;&#32622;&#30340;SQL&#33050;&#26412;&#30340;&#20803;&#25968;&#25454;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
@Sql(
    scripts = <span class="hl-string">"/test-user-data.sql"</span>,
    config = <span class="strong"><strong>@SqlConfig</strong></span>(commentPrefix = <span class="hl-string">"`"</span>, separator = <span class="hl-string">"@@"</span>)
)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// &#20381;&#36182;&#27979;&#35797;&#25968;&#25454;&#30340;&#20195;&#30721;</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@SqlGroup</code></p>
<p class="simpara">&#36825;&#26159;&#19968;&#20010;&#23481;&#22120;&#27880;&#35299;&#65292;&#29992;&#26469;&#32858;&#21512;&#33509;&#24178;&#20010; <code class="literal">@Sql</code> &#27880;&#35299;&#12290; &#21487;&#20197;&#33258;&#28982;&#22320;&#29992;&#26469;&#22768;&#26126;&#33509;&#24178;&#20010;&#20869;&#32622;&#30340; <code class="literal">@Sql</code> &#27880;&#35299;&#12290; &#20063;&#21487;&#20197;&#29992;&#26469;&#32467;&#21512;
Java8 &#21487;&#37325;&#22797;&#27880;&#35299;&#30340;&#25903;&#25345;&#65292;&#29992;&#26469;&#22312;&#31867;&#25110;&#32773;&#26159;&#26041;&#27861;&#19978;&#22768;&#26126;&#22810;&#27425; <code class="literal">@Sql</code> &#27880;&#35299;&#65292; &#36825;&#31181;&#24773;&#20917;&#65292;&#23558;&#38544;&#24335;&#29983;&#25104;&#36825;&#20010;&#23481;&#22120;&#27880;&#35299;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="strong"><strong>@SqlGroup</strong></span>({
    <em><span class="hl-annotation" style="color: gray">@Sql(scripts = "/test-schema.sql", config = @SqlConfig(commentPrefix = "`")),</span></em>
    <em><span class="hl-annotation" style="color: gray">@Sql("/test-user-data.sql")</span></em>
)}
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// &#20351;&#29992;&#27979;&#35797;&#25968;&#25454;&#24211;&#21644;&#27979;&#35797;&#25968;&#25454;&#30340;&#25191;&#34892;&#20195;&#30721;</span>
}</pre>

</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-standard" href="#integration-testing-annotations-standard"></a>&#26631;&#20934;&#27880;&#35299;&#25903;&#25345;</h4></div></div></div>

<p>&#19979;&#36848;&#30340;&#27880;&#35299;&#23545;&#25152;&#26377;&#30340;Spring TestContext&#26694;&#26550;&#37197;&#32622;&#25903;&#25345;&#26631;&#20934;&#30340;&#35821;&#20041;&#12290;&#36825;&#20123;&#27880;&#35299;&#24182;&#38750;&#26159;&#22312;&#27979;&#35797;&#20013;&#19987;&#29992;&#30340;&#65292;&#32780;&#26159;&#21487;&#20197;&#29992;&#22312;
Spring&#26694;&#26550;&#30340;&#20219;&#20309;&#22320;&#26041;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@Autowired</code>
</li><li class="listitem">
<code class="literal">@Qualifier</code>
</li><li class="listitem">
<code class="literal">@Resource</code> (javax.annotation) <span class="emphasis"><em>if JSR-250 is present</em></span>
</li><li class="listitem">
<code class="literal">@Inject</code> (javax.inject) <span class="emphasis"><em>if JSR-330 is present</em></span>
</li><li class="listitem">
<code class="literal">@Named</code> (javax.inject) <span class="emphasis"><em>if JSR-330 is present</em></span>
</li><li class="listitem">
<code class="literal">@PersistenceContext</code> (javax.persistence) <span class="emphasis"><em>if JPA is present</em></span>
</li><li class="listitem">
<code class="literal">@PersistenceUnit</code> (javax.persistence) <span class="emphasis"><em>if JPA is present</em></span>
</li><li class="listitem">
<code class="literal">@Required</code>
</li><li class="listitem">
<code class="literal">@Transactional</code>
</li></ul></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: JSR-250 &#22768;&#26126;&#21608;&#26399;&#27880;&#35299;"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">JSR-250 &#22768;&#26126;&#21608;&#26399;&#27880;&#35299;</th></tr><tr><td align="left" valign="top">

<p>&#22312;Spring TestContext&#26694;&#26550;&#20013;&#65292;  <code class="literal">@PostConstruct</code> &#21644; <code class="literal">@PreDestroy</code> &#21487;&#20197;&#20197;&#26631;&#20934;&#30340;&#35821;&#20041;&#34987;&#29992;&#22312;&#20219;&#20309;&#37197;&#32622;
&#22312; <code class="literal">@ApplicationContext</code> &#24212;&#29992;&#32452;&#20214;&#20013;; &#28982;&#32780;&#65292;&#29983;&#21629;&#21608;&#26399;&#27880;&#35299;&#22312;&#23454;&#38469;&#30340;&#27979;&#35797;&#31867;&#20013;&#20351;&#29992;&#26159;&#21463;&#38480;&#30340;&#12290;</p>
<p>&#22914;&#26524;&#27979;&#35797;&#31867;&#20013;&#30340;&#19968;&#20010;&#26041;&#27861;&#22686;&#21152;&#20102; <code class="literal">@PostConstruct</code> &#27880;&#35299;&#65292;&#36825;&#20010;&#26041;&#27861;&#23558;&#20250;&#22312;&#27979;&#35797;&#26694;&#26550;&#65288;&#20363;&#22914;&#65292;&#21152;&#27880;&#20102;JUnit&#30340; <code class="literal">@Before</code>
&#27880;&#35299;&#30340;&#26041;&#27861;&#65289;&#20013;&#30340;&#20219;&#20309; <span class="emphasis"><em>before</em></span> &#26041;&#27861;&#20043;&#21069;&#34987;&#25191;&#34892;&#65292;&#24182;&#19988;&#23427;&#20250;&#34987;&#24212;&#29992;&#22312;&#27979;&#35797;&#31867;&#30340;&#27599;&#19968;&#20010;&#27979;&#35797;&#26041;&#27861;&#20013;&#12290;&#21478;&#19968;&#26041;&#38754;&#65292;&#22914;&#26524;&#19968;&#20010;
&#27979;&#35797;&#31867;&#20013;&#30340;&#26041;&#27861;&#21152;&#27880;&#20102; <code class="literal">@PreDestroy</code> &#27880;&#35299;&#65292; &#36825;&#20010;&#26041;&#27861;&#23558; <span class="emphasis"><em>&#32477;&#23545;</em></span> &#19981;&#20250;&#25191;&#34892;&#12290; &#22240;&#27492;&#65292;&#22312;&#27979;&#35797;&#31867;&#20013;&#24314;&#35758;&#20351;&#29992;&#27979;&#35797;&#26694;&#26550;
&#30340;&#29983;&#21629;&#21608;&#26399;&#22238;&#35843;&#32780;&#38750; <code class="literal">@PostConstruct</code> &#21644; <code class="literal">@PreDestroy</code> &#27880;&#35299;&#12290;</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-junit" href="#integration-testing-annotations-junit"></a>Spring JUnit &#27979;&#35797;&#27880;&#35299;</h4></div></div></div>

<p>&#19979;&#36848;&#30340;&#27880;&#35299; <span class="emphasis"><em>&#20165;&#20165;</em></span> &#25903;&#25345;&#32852;&#21512; <a class="link" href="aop-api.html#testcontext-junit4-runner" title="Spring JUnit Runner">SpringJUnit4ClassRunner</a> &#25110;&#32773;&#26159;
<a class="link" href="aop-api.html#testcontext-support-classes-junit4" title="JUnit support classes">JUnit</a> &#30340;&#25903;&#25345;&#31867;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><code class="literal">@IfProfileValue</code></p>
<p class="simpara">&#25351;&#31034;&#22686;&#21152;&#20102;&#35813;&#27880;&#35299;&#30340;&#27979;&#35797;&#23545;&#29305;&#23450;&#30340;&#27979;&#35797;&#29615;&#22659;&#21487;&#29992;&#12290; &#22914;&#26524;&#37197;&#32622;&#30340; <code class="literal">ProfileValueSource</code> &#23545;&#25552;&#20379;&#30340; <code class="literal">name</code> &#36820;&#22238;
&#20102;&#21305;&#37197;&#30340; <code class="literal">value</code>, &#36825;&#20010;&#27979;&#35797;&#21363;&#21487;&#29992;&#12290; &#36825;&#20010;&#27880;&#35299;&#21487;&#20197;&#29992;&#22312;&#25972;&#20010;&#31867;&#19978;&#65292;&#20063;&#21487;&#20197;&#34987;&#29992;&#22312;&#29420;&#31435;&#30340;&#26041;&#27861;&#19978;&#12290;&#22312;&#31867;&#32423;&#21035;&#20351;&#29992;&#23558;&#35206;&#30422;
&#26041;&#27861;&#32423;&#21035;&#30340;&#37197;&#32622;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@IfProfileValue</strong></span>(<span class="strong"><strong>name</strong></span>=<span class="hl-string">"java.vendor"</span>, <span class="strong"><strong>value</strong></span>=<span class="hl-string">"Oracle Corporation"</span>)
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichRunsOnlyOnOracleJvm() {
    <span class="hl-comment">// &#19968;&#20123;&#20165;&#24212;&#35813;&#22312;Oracle&#20844;&#21496;&#30340;JAVA JVM&#19978;&#36816;&#34892;&#30340;&#36923;&#36753;</span>
}</pre>

<p class="simpara">&#21487;&#36873;&#22320;&#65292;&#20320;&#21487;&#20197;&#29992;&#19968;&#32452; <code class="literal">values</code> &#65288;&#25317;&#26377; <span class="emphasis"><em>OR</em></span> &#35821;&#20041;&#65289;&#21015;&#34920;&#26469;&#37197;&#32622; <code class="literal">@IfProfileValue</code> &#27880;&#35299;&#65292;&#22312;JUnit&#29615;&#22659;&#20013;
&#20197;&#27492;&#26469;&#36798;&#21040;&#31867;&#20284;TestNG&#23545; <span class="emphasis"><em>test group</em></span> &#30340;&#25903;&#25345;&#12290;
&#32771;&#34385;&#22914;&#19979;&#30340;&#31034;&#20363;&#65306;</p>
<pre class="programlisting"><span class="strong"><strong>@IfProfileValue</strong></span>(<span class="strong"><strong>name</strong></span>=<span class="hl-string">"test-groups"</span>, <span class="strong"><strong>values</strong></span>={<span class="hl-string">"unit-tests"</span>, <span class="hl-string">"integration-tests"</span>})
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichRunsForUnitOrIntegrationTestGroups() {
    <span class="hl-comment">// &#19968;&#20123;&#20165;&#33021;&#36816;&#34892;&#21333;&#20803;&#21644;&#38598;&#25104;&#27979;&#35797;&#32452;&#30340;&#36923;&#36753;</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@ProfileValueSourceConfiguration</code></p>
<p class="simpara">&#31867;&#32423;&#21035;&#30340;&#27880;&#35299;&#65292;&#29992;&#26469;&#25351;&#23450;&#25628;&#32034; <span class="emphasis"><em>profile values</em></span> &#30340; <code class="literal">ProfileValueSource</code> &#30340;&#31867;&#22411;&#65292;&#36825;&#20123; <span class="emphasis"><em>profile values</em></span>
&#26469;&#28304;&#20110; <code class="literal">@IfProfileValue</code> &#27880;&#35299;&#30340;&#37197;&#32622;&#12290;&#22914;&#26524;&#27979;&#35797;&#20013;&#27809;&#26377;&#22768;&#26126; <code class="literal">@ProfileValueSourceConfiguration</code> &#27880;&#35299;&#65292;&#40664;&#35748;
&#23558;&#20351;&#29992; <code class="literal">SystemProfileValueSource</code> &#27880;&#35299;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@ProfileValueSourceConfiguration</strong></span>(CustomProfileValueSource.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomProfileValueSourceTests {
    <span class="hl-comment">// class body...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Timed</code></p>
<p class="simpara">&#25351;&#31034;&#19968;&#20010;&#27880;&#35299;&#30340;&#26041;&#27861;&#24517;&#39035;&#22312;&#25351;&#23450;&#30340;&#26102;&#38388;&#21608;&#26399;&#20869;&#65288;&#20197;&#27627;&#31186;&#20026;&#21333;&#20301;&#65289;&#23436;&#25104;&#25191;&#34892;&#12290;&#22914;&#26524;&#25191;&#34892;&#26102;&#38388;&#36229;&#36807;&#20102;&#25351;&#23450;&#30340;&#26102;&#38388;&#21608;&#26399;&#65292;&#27979;&#35797;&#23558;
&#22833;&#36133;&#12290;</p>
<p class="simpara">&#26102;&#38388;&#21608;&#26399;&#21253;&#25324;&#27979;&#35797;&#26041;&#27861;&#26412;&#36523;&#30340;&#25191;&#34892;&#65292;&#20219;&#20309;&#27979;&#35797;&#30340;&#37325;&#22797;&#65288;&#21442;&#38405; <code class="literal">@Repeat</code> &#27880;&#35299;&#65289;&#25191;&#34892;&#65292;&#20063;&#21253;&#25324;&#20219;&#20309;&#27979;&#35797;&#22841;&#20855;&#30340;
<span class="emphasis"><em>set up</em></span> &#25110;&#32773; <span class="emphasis"><em>tear down</em></span> &#26041;&#27861;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@Timed</strong></span>(millis=<span class="hl-number">1000</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWithOneSecondTimeout() {
    <span class="hl-comment">// &#19968;&#20123;&#25191;&#34892;&#26102;&#38388;&#19981;&#20250;&#36229;&#36807;1&#22937;&#30340;&#20195;&#30721;&#36923;&#36753;</span>
}</pre>

<p class="simpara">Spring&#30340; <code class="literal">@Timed</code> &#27880;&#35299;&#19982;JUnit&#30340; <code class="literal">@Test(timeout=...)</code>&#25903;&#25345;&#26377;&#19981;&#21516;&#30340;&#35821;&#20041;&#12290;&#20855;&#20307;&#26469;&#35828;&#65292;&#24402;&#22240;&#20110;JUnit&#22788;&#29702;
&#27979;&#35797;&#25191;&#34892;&#36229;&#26102;&#65288;&#22312;&#19968;&#20010;&#29420;&#31435;&#30340; <code class="literal">Thread</code> &#20013;&#25191;&#34892;&#27979;&#35797;&#26041;&#27861;&#30340;&#26102;&#38388;&#65289;&#30340;&#26041;&#24335;&#65292; &#22914;&#26524;&#27979;&#35797;&#33457;&#36153;&#22826;&#38271;&#30340;&#26102;&#38388;&#65292;&#37027;&#20040;
<code class="literal">@Test(timeout=...)</code> &#27880;&#35299;&#20250;&#24378;&#21046;&#27979;&#35797;&#22833;&#36133;&#12290; &#28982;&#32780;&#65292;Spring&#30340; @Timed &#27880;&#35299;&#19981;&#20250;&#24378;&#21046;&#27979;&#35797;&#22833;&#36133;&#65292;&#32780;&#26159;&#22312;&#22833;&#36133;&#20043;&#21069;
&#31561;&#24453;&#27979;&#35797;&#23436;&#25104;&#25191;&#34892;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@Repeat</code></p>
<p class="simpara">&#25351;&#31034;&#37325;&#22797;&#25191;&#34892;&#22686;&#21152;&#20102;&#35813;&#27880;&#35299;&#30340;&#26041;&#27861;&#12290;&#25191;&#34892;&#30340;&#27425;&#25968;&#22312;&#35813;&#27880;&#35299;&#20013;&#25351;&#23450;&#12290;</p>
<p class="simpara">&#22810;&#27425;&#25191;&#34892;&#30340;&#26041;&#27861;&#21253;&#25324;&#27979;&#35797;&#26041;&#27861;&#26412;&#36523;&#65292; &#27979;&#35797;&#22841;&#20855;&#30340; <span class="emphasis"><em>set up</em></span> &#26041;&#27861;&#21644; <span class="emphasis"><em>tear down</em></span> &#26041;&#27861;&#12290;</p>
<pre class="programlisting"><span class="strong"><strong>@Repeat</strong></span>(<span class="hl-number">10</span>)
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessRepeatedly() {
    <span class="hl-comment">// ...</span>
}</pre>

</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-meta" href="#integration-testing-annotations-meta"></a>&#27979;&#35797;&#20803;&#27880;&#35299;&#30340;&#25903;&#25345;</h4></div></div></div>

<p>&#22312;Spring 4.0&#20013;&#30340;&#27979;&#35797;&#22871;&#20214;&#20013;&#65292;&#20351;&#29992;&#31867;&#20284; <a class="link" href="beans.html#beans-meta-annotations" title="5.10.2&nbsp;Meta-annotations">meta-annotations</a> &#27979;&#35797;&#30456;&#20851;&#30340;&#27880;&#35299;&#26469;&#21019;&#24314;
&#33258;&#23450;&#20041;&#30340; <span class="emphasis"><em>&#32452;&#21512;&#30340;&#27880;&#35299;</em></span> &#24182;&#38477;&#20302;&#37325;&#22797;&#37197;&#32622;&#25104;&#20026;&#21487;&#33021;&#12290;</p>
<p>&#19979;&#36848;&#30340;&#27599;&#19968;&#20010;&#27880;&#35299;&#22312;&#32852;&#21512; <a class="link" href="aop-api.html#testcontext-framework" title="10.15.5&nbsp;Spring TestContext Framework">TestContext framework</a> &#20351;&#29992;&#26102;&#65292;&#37117;&#21487;&#20197;&#20316;&#20026;&#20803;&#27880;&#35299;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@ContextConfiguration</code>
</li><li class="listitem">
<code class="literal">@ContextHierarchy</code>
</li><li class="listitem">
<code class="literal">@ActiveProfiles</code>
</li><li class="listitem">
<code class="literal">@TestPropertySource</code>
</li><li class="listitem">
<code class="literal">@DirtiesContext</code>
</li><li class="listitem">
<code class="literal">@WebAppConfiguration</code>
</li><li class="listitem">
<code class="literal">@TestExecutionListeners</code>
</li><li class="listitem">
<code class="literal">@Transactional</code>
</li><li class="listitem">
<code class="literal">@BeforeTransaction</code>
</li><li class="listitem">
<code class="literal">@AfterTransaction</code>
</li><li class="listitem">
<code class="literal">@TransactionConfiguration</code>
</li><li class="listitem">
<code class="literal">@Rollback</code>
</li><li class="listitem">
<code class="literal">@Sql</code>
</li><li class="listitem">
<code class="literal">@SqlConfig</code>
</li><li class="listitem">
<code class="literal">@SqlGroup</code>
</li><li class="listitem">
<code class="literal">@Repeat</code>
</li><li class="listitem">
<code class="literal">@Timed</code>
</li><li class="listitem">
<code class="literal">@IfProfileValue</code>
</li><li class="listitem">
<code class="literal">@ProfileValueSourceConfiguration</code>
</li></ul></div>

<p>&#20363;&#22914;&#65292;&#22914;&#26524;&#25105;&#20204;&#21457;&#29616;&#27491;&#22312;&#37325;&#22797;&#37197;&#32622;&#22522;&#20110;JUnit&#30340;&#27979;&#35797;&#22871;&#20214;&#8230;&#8230;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderRepositoryTests { }

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserRepositoryTests { }</pre>

<p>&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;&#24341;&#20837;&#19968;&#20010;&#33258;&#23450;&#20041;&#30340; <span class="emphasis"><em>&#32452;&#21512;&#27880;&#35299;</em></span> &#26469;&#21066;&#20943;&#19978;&#36848;&#37325;&#22797;&#30340;&#37197;&#32622;&#65292;&#36825;&#20010;&#32452;&#21512;&#27880;&#35299;&#21487;&#20197;&#38598;&#20013;&#31649;&#29702;&#36890;&#29992;&#30340;&#27979;&#35797;&#37197;
&#32622;&#65292;&#22914;&#19979;&#25152;&#31034;&#65306;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target(ElementType.TYPE)</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> TransactionalDevTest { }</pre>

<p>&#25105;&#20204;&#21487;&#20197;&#20351;&#29992;&#25105;&#20204;&#30340;&#33258;&#23450;&#20041; <code class="literal">@TransactionalDevTest</code> &#27880;&#35299;&#31616;&#21270;&#29420;&#31435;&#27979;&#35797;&#31867;&#30340;&#37197;&#32622;&#65292;&#22914;&#19979;&#25152;&#31034;&#65306;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@TransactionalDevTest</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderRepositoryTests { }

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@TransactionalDevTest</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserRepositoryTests { }</pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="testcontext-framework" href="#testcontext-framework"></a>10.15.5&nbsp;Spring TestContext Framework</h3></div></div></div>

<p><span class="emphasis"><em>Spring TestContext Framework</em></span> (&#22312; <code class="literal">org.springframework.test.context</code> &#21253;&#20013;) &#25552;&#20379;&#20102;&#36890;&#29992;&#30340;,
&#27880;&#35299;&#39537;&#21160;&#30340;&#21333;&#20803;&#27979;&#35797;&#21644;&#38598;&#25104;&#27979;&#35797;&#25903;&#25345;&#65292;&#32780;&#19981;&#38480;&#23450;&#36825;&#20123;&#27979;&#35797;&#25152;&#20351;&#29992;&#30340;&#20855;&#20307;&#30340;&#27979;&#35797;&#22871;&#20214;&#12290; Spring TestContext Framework
&#23588;&#20854;&#37325;&#35270; <span class="emphasis"><em>&#24815;&#20363;&#37197;&#32622;</em></span> &#65292;&#20110;&#26159;&#25918;&#32622;&#20102;&#22823;&#37327;&#30340;&#40664;&#35748;&#37197;&#32622;&#65292;&#20320;&#20063;&#21487;&#20197;&#22522;&#20110;&#27880;&#35299;&#30340;&#37197;&#32622;&#23545;&#40664;&#35748;&#20540;&#36827;&#34892;&#35206;&#30422;&#12290;</p>
<p>&#38500;&#20102;&#36890;&#29992;&#30340;&#27979;&#35797;&#35774;&#26045;&#65292;Spring TestContext framework &#20197; <code class="literal">&#25277;&#35937;</code> &#25903;&#25345;&#31867;&#30340;&#24418;&#24335;&#23545;JUnit&#21644;TestNG&#25552;&#20379;&#20102;&#30452;&#25509;&#30340;
&#25903;&#25345;&#12290;&#27979;&#35797;&#26694;&#26550;&#23545;JUnit&#25552;&#20379;&#20102;&#19968;&#20010;&#29992;&#25143;&#33258;&#23450;&#20041;&#30340;JUnit <code class="literal">Runner</code> ,&#36825;&#20010;&#36816;&#34892;&#22120;&#26159;&#19968;&#20010;&#34987;&#31216;&#20026; <span class="emphasis"><em>POJO&#30340;&#27979;&#35797;&#31867;</em></span> &#65292;
&#23427;&#19981;&#38656;&#35201;&#32487;&#25215;&#19968;&#20010;&#29305;&#23450;&#30340;&#31867;&#23618;&#27425;&#12290;</p>
<p>&#25509;&#19979;&#26469;&#30340;&#31456;&#33410;&#23558;&#25552;&#20379;TestContext framework&#30340;&#27010;&#35272;&#12290;&#22914;&#26524;&#20320;&#20165;&#20165;&#23545;&#22914;&#20309;&#20351;&#29992;&#36825;&#20010;&#26694;&#26550;&#24863;&#20852;&#36259;&#65292;&#32780;&#23545;&#22914;&#20309;&#20351;&#29992;&#33258;&#23450;&#20041;&#30340;
&#30417;&#21548;&#22120;&#25110;&#21152;&#36733;&#22120;&#25193;&#23637;&#23427;&#65292;&#37027;&#20040;&#65292;&#35831;&#30452;&#25509;&#21442;&#32771;&#37197;&#32622;&#65288;<a class="link" href="aop-api.html#testcontext-ctx-management" title="&#19978;&#19979;&#25991;&#31649;&#29702;">&#19978;&#19979;&#25991;&#31649;&#29702;</a>&#65292;
<a class="link" href="aop-api.html#testcontext-fixture-di" title="Dependency injection of test fixtures">&#20381;&#36182;&#27880;&#20837;</a>&#65292;<a class="link" href="aop-api.html#testcontext-tx" title="Transaction management">&#20107;&#21153;&#31649;&#29702;</a>&#65289;&#65292;<a class="link" href="aop-api.html#testcontext-support-classes" title="TestContext Framework support classes">&#25903;&#25345;&#31867;</a>
&#21644; <a class="link" href="aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;&#27880;&#35299;">&#27880;&#35299;&#25903;&#25345;</a> &#31456;&#33410;&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-key-abstractions" href="#testcontext-key-abstractions"></a>&#26680;&#24515;&#27010;&#36848;</h4></div></div></div>

<p>&#27979;&#35797;&#26694;&#26550;&#30340;&#26680;&#24515;&#30001; <code class="literal">TestContext</code> &#21644; <code class="literal">TestContextManager</code> &#31867;&#20197;&#21450; <code class="literal">TestExecutionListener</code>, <code class="literal">ContextLoader</code>, &#21644;
<code class="literal">SmartContextLoader</code> &#25509;&#21475;&#32452;&#25104;&#12290; <code class="literal">TestContextManager</code> &#23454;&#20363;&#22312;&#27599;&#19968;&#20010;&#22522;&#26412;&#27979;&#35797;&#21333;&#20803;&#65288;&#22914;JUnit&#20013;&#30340;&#27979;&#35797;&#26041;&#27861;&#25191;&#34892;&#26102;&#65289;
&#25191;&#34892;&#26102;&#34987;&#21019;&#24314;&#12290;<code class="literal">TestContextManager</code>&#23545;&#35937;&#29992;&#26469;&#31649;&#29702;&#25345;&#26377;&#24403;&#21069;&#27979;&#35797;&#19978;&#19979;&#25991;&#30340;<code class="literal">TestContext</code>&#23454;&#20363;&#65292;&#23427;&#20063;&#26356;&#26032; <code class="literal">TestContext</code>&#31867;&#30340;
&#29366;&#24577;&#26469;&#25351;&#31034;&#27979;&#35797;&#36827;&#24230;&#65292;&#24182;&#19988;&#23427;&#23558;&#20381;&#36182;&#27880;&#20837;&#65292;&#20107;&#21153;&#31649;&#29702;&#31561;&#21151;&#33021;&#22996;&#25176;&#32473;<code class="literal">TestExecutionListener</code>s&#31867;&#36827;&#34892;&#22788;&#29702;&#12290;<code class="literal">ContextLoader</code>
&#31867;&#36127;&#36131;&#23545;&#25351;&#23450;&#30340;&#27979;&#35797;&#31867;&#21152;&#36733; <code class="literal">ApplicationContext</code>&#23454;&#20363;&#12290;&#35831;&#21442;&#32771;javadocs&#25991;&#20214;&#26469;&#20102;&#35299;&#36827;&#19968;&#27493;&#30340;&#20449;&#24687;&#21644;&#21508;&#31181;&#31034;&#20363;&#30340;&#23454;&#29616;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TestContext</code>: &#27979;&#35797;&#25191;&#34892;&#26102;&#20026;&#27979;&#35797;&#23454;&#20363;&#23553;&#35013;&#27979;&#35797;&#19978;&#19979;&#25991;&#65292;&#23545;&#23454;&#38469;&#20351;&#29992;&#30340;&#27979;&#35797;&#26694;&#26550;&#36879;&#26126;&#65292;&#25552;&#20379;&#19978;&#19979;&#25991;&#31649;&#29702;&#21644;&#32531;&#23384;&#25903;&#25345;
&#21516;&#26102;&#22312;&#24517;&#35201;&#26102;&#20026;&#21152;&#36733; <code class="literal">ApplicationContext</code>&#23454;&#20363;&#22996;&#25176;&#20110; <code class="literal">ContextLoader</code>&#31867;&#65288;&#25110; <code class="literal">SmartContextLoader</code>&#31867;&#65289;&#12290;
</li><li class="listitem">
<p class="simpara"><code class="literal">TestContextManager</code>: <span class="emphasis"><em>Spring TestContext Framework</em></span> &#30340;&#20027;&#35201;&#20837;&#21475;&#28857;&#65292;&#22312;&#33391;&#22909;&#23450;&#20041;&#30340;&#27979;&#35797;&#25191;&#34892;&#28857;
&#31649;&#29702;&#21333;&#20010; <code class="literal">TestContext</code>&#21644;&#25152;&#26377;&#30340;&#24050;&#27880;&#20876;&#30340; <code class="literal">TestExecutionListener</code>s&#31867;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
&#22312;&#29305;&#23450;&#30340;&#27979;&#35797;&#26694;&#26550;&#20013;&#30340;&#20219;&#20309; <span class="emphasis"><em>before class methods</em></span> &#21069;
</li><li class="listitem">
&#27979;&#35797;&#23454;&#20363;&#20934;&#22791;
</li><li class="listitem">
&#29305;&#23450;&#27979;&#35797;&#26694;&#26550;&#20013;&#30340;&#20219;&#20309; <span class="emphasis"><em>before methods</em></span> &#21069;
</li><li class="listitem">
&#29305;&#23450;&#30340;&#27979;&#35797;&#26694;&#26550;&#20013;&#20219;&#30340;&#20219;&#20309; <span class="emphasis"><em>after methods</em></span> &#20043;&#21518;
</li><li class="listitem">
&#29305;&#23450;&#30340;&#27979;&#35797;&#26694;&#26550;&#20013;&#30340;&#20219;&#20309; <span class="emphasis"><em>after class methods</em></span> &#20043;&#21518;
</li></ul></div>

</li><li class="listitem">
<code class="literal">TestExecutionListener</code>: &#20026; <code class="literal">TestContextManager</code> &#23545;&#35937;&#21457;&#24067;&#30340;&#27979;&#35797;&#25191;&#34892;&#20107;&#20214;&#23450;&#20041;&#19968;&#20010;  <span class="emphasis"><em>listener</em></span> API
&#65292;&#26597;&#30475; <a class="xref" href="aop-api.html#testcontext-tel-config" title="TestExecutionListener &#37197;&#32622;">the section called &#8220;TestExecutionListener &#37197;&#32622;&#8221;</a> &#12290;
</li><li class="listitem">
<p class="simpara"><code class="literal">ContextLoader</code>: &#22312;Spring 2.5&#20013;&#24341;&#20837;&#30340;&#31574;&#30053;&#25509;&#21475;&#65292;&#29992;&#26469;&#20026;Spring TestContext Framework&#31649;&#29702;&#30340;&#38598;&#25104;&#27979;&#35797;&#21152;&#36733;
&#19968;&#20010;  <code class="literal">ApplicationContext</code> &#23454;&#20363;&#12290;</p>
<p class="simpara">&#20026;&#20102;&#25552;&#20379;&#23545;&#27880;&#35299;&#31867;&#12289;&#28608;&#27963;&#30340;bean&#23450;&#20041;&#37197;&#32622;&#12289;&#27979;&#35797;&#23646;&#24615;&#28304;&#12289;&#19978;&#19979;&#25991;&#23618;&#27425;&#21644; <code class="literal">WebApplicationContext</code>s&#30340;&#25903;&#25345;&#65292; <code class="literal">SmartContextLoader</code>
&#26159;&#19968;&#20010;&#25509;&#21475;&#30340;&#26367;&#20195;&#23454;&#29616;&#12290;</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">SmartContextLoader</code>:   <code class="literal">ContextLoader</code> &#25509;&#21475;&#30340;&#25193;&#23637;&#22312;Spring 3.1&#20013;&#24341;&#20837;&#12290;</p>
<p class="simpara"><code class="literal">SmartContextLoader</code> SPI &#22312;Spring 2.5&#20013;&#34987;&#24341;&#20837;&#65292;&#29992;&#26469;&#26367;&#20195;  <code class="literal">ContextLoader</code> SPI &#12290;&#29305;&#23450;&#22320;&#65292; <code class="literal">SmartContextLoader</code>
&#21487;&#20197;&#36873;&#25321;&#29992;&#26469;&#22788;&#29702;&#36164;&#28304; <code class="literal">&#20301;&#32622;</code>&#65292;&#27880;&#35299;&#30340; <code class="literal">&#31867;</code>&#65292;&#25110;&#19978;&#19979;&#25991; <code class="literal">&#21021;&#22987;&#21270;&#22120;</code>&#12290;&#36827;&#19968;&#27493;&#22320;&#65292;&#20320;&#21487;&#20197;&#22312;&#20854;&#21152;&#36733;&#30340;&#19978;&#19979;&#25991;&#20013;&#35774;&#32622;
<code class="literal">SmartContextLoader</code>&#31867;&#26469;&#28608;&#27963;bean&#23450;&#20041;&#37197;&#32622;&#21644;&#27979;&#35797;&#23646;&#24615;&#28304;&#12290;</p>
<p class="simpara">Spring &#25552;&#20379;&#20102;&#22914;&#19979;&#30340;&#23454;&#29616;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">DelegatingSmartContextLoader</code>: &#20004;&#20010;&#40664;&#35748;&#30340;&#21152;&#36733;&#22120;&#20013;&#30340;&#19968;&#20010;&#65292;&#22312;&#20869;&#37096;&#22996;&#25176;&#32473;<code class="literal">AnnotationConfigContextLoader</code>&#12289;
<code class="literal">GenericXmlContextLoader</code> &#25110; <code class="literal">GenericGroovyXmlContextLoader</code> &#31867;&#65292;&#20855;&#20307;&#20381;&#36182;&#20110;&#27979;&#35797;&#31867;&#30340;&#37197;&#32622;&#22768;&#26126;&#12289;&#40664;&#35748;&#20301;&#32622;
&#25110;&#40664;&#35748;&#30340;&#37197;&#32622;&#31867;&#12290; Groovy&#30340;&#25903;&#25345;&#38656;&#35201;Groovy&#65288;&#30456;&#20851;Jar&#65289;&#22312;Java&#31867;&#36335;&#24452;&#19978;&#12290;
</li><li class="listitem">
<code class="literal">WebDelegatingSmartContextLoader</code>: &#20004;&#20010;&#40664;&#35748;&#30340;&#21152;&#36733;&#22120;&#20013;&#30340;&#19968;&#20010;&#65292;&#22312;&#20869;&#37096;&#22996;&#25176;&#32473;<code class="literal">AnnotationConfigContextLoader</code>&#12289;
<code class="literal">GenericXmlContextLoader</code> &#25110; <code class="literal">GenericGroovyXmlContextLoader</code> &#31867;&#65292;&#20855;&#20307;&#20381;&#36182;&#20110;&#27979;&#35797;&#31867;&#30340;&#37197;&#32622;&#22768;&#26126;&#12289;&#40664;&#35748;&#20301;&#32622;
&#25110;&#40664;&#35748;&#30340;&#37197;&#32622;&#31867;&#12290; &#22914;&#26524;&#22312;&#27979;&#35797;&#31867;&#19978;&#20986;&#29616;&#20102; <code class="literal">@WebAppConfiguration</code> &#27880;&#35299;&#65292;&#21017;&#20165;&#20165;&#20351;&#29992; Web&#31867;&#21152;&#36733;&#22120; <code class="literal">ContextLoader</code> &#12290;
Groovy&#30340;&#25903;&#25345;&#38656;&#35201;Groovy&#65288;&#30456;&#20851;Jar&#65289;&#22312;Java&#31867;&#36335;&#24452;&#19978;&#12290;
</li><li class="listitem">
<code class="literal">AnnotationConfigContextLoader</code>: &#26681;&#25454; <span class="emphasis"><em>&#27880;&#35299;&#30340;&#31867;</em></span> &#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23454;&#20363;&#12290;
</li><li class="listitem">
<code class="literal">AnnotationConfigWebContextLoader</code>: &#26681;&#25454; <span class="emphasis"><em>&#27880;&#35299;&#30340;&#31867;</em></span> &#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">WebApplicationContext</code> &#23454;&#20363;&#12290;
</li><li class="listitem">
<code class="literal">GenericGroovyXmlContextLoader</code>: &#26681;&#25454; <span class="emphasis"><em>&#36164;&#28304;&#36335;&#24452;</em></span> &#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23454;&#20363;&#65292;
&#35813;&#36164;&#28304;&#36335;&#24452;&#21487;&#20197;&#26159;Groovy&#33050;&#26412;&#25110;&#32773;&#26159;XML&#37197;&#32622;&#25991;&#20214;&#12290;
</li><li class="listitem">
<code class="literal">GenericGroovyXmlWebContextLoader</code>: &#26681;&#25454; <span class="emphasis"><em>&#36164;&#28304;&#36335;&#24452;</em></span> &#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">WebApplicationContext</code> &#23454;&#20363;&#65292;
&#35813;&#36164;&#28304;&#36335;&#24452;&#21487;&#20197;&#26159;Groovy&#33050;&#26412;&#25110;&#32773;&#26159;XML&#37197;&#32622;&#25991;&#20214;&#12290;
</li><li class="listitem">
<code class="literal">GenericXmlContextLoader</code>: &#26681;&#25454;XML <span class="emphasis"><em>&#36164;&#28304;&#36335;&#24452;</em></span> &#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23454;&#20363;&#12290;
</li><li class="listitem">
<code class="literal">GenericXmlWebContextLoader</code>: &#26681;&#25454;XML <span class="emphasis"><em>&#36164;&#28304;&#36335;&#24452;</em></span> &#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">WebApplicationContext</code> &#23454;&#20363;&#12290;
</li><li class="listitem">
<code class="literal">GenericPropertiesContextLoader</code>: &#26681;&#25454; Java &#23646;&#24615;&#25991;&#20214;&#21152;&#36733;&#19968;&#20010;&#26631;&#20934;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23454;&#20363;&#12290;
</li></ul></div>

</li></ul></div>

<p>&#19979;&#36848;&#30340;&#31456;&#33410;&#23558;&#35299;&#37322;&#22914;&#20309;&#36890;&#36807;&#27880;&#35299;&#37197;&#32622;TestContext framework&#24182;&#19988;&#25552;&#20379;&#20351;&#29992;&#27979;&#35797;&#26694;&#26550;&#37197;&#32622;&#21333;&#20803;&#21450;&#38598;&#25104;&#27979;&#35797;&#30340;&#21487;&#20197;&#24037;&#20316;&#30340;&#31034;&#20363;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-tel-config" href="#testcontext-tel-config"></a>TestExecutionListener &#37197;&#32622;</h4></div></div></div>

<p>Spring&#25552;&#20379;&#20102;&#22914;&#19979;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code> &#23454;&#29616;&#65292;&#23427;&#20204;&#23558;&#25353;&#22914;&#19979;&#39034;&#24207;&#40664;&#35748;&#34987;&#27880;&#20876;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ServletTestExecutionListener</code>: &#20026;WEB&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">WebApplicationContext</code> &#23545;&#35937;&#37197;&#32622;Servlet API &#27169;&#25311;&#22120;
</li><li class="listitem">
<code class="literal">DependencyInjectionTestExecutionListener</code>: &#20026;&#27979;&#35797;&#23454;&#20363;&#25552;&#20379;&#20381;&#36182;&#27880;&#20837;&#12290;
</li><li class="listitem">
<code class="literal">DirtiesContextTestExecutionListener</code>: &#22788;&#29702; <code class="literal">@DirtiesContext</code> &#27880;&#35299;
</li><li class="listitem">
<code class="literal">TransactionalTestExecutionListener</code>: &#25552;&#20379;&#24102;&#26377;&#40664;&#35748;&#22238;&#28378;&#35821;&#20041;&#30340;&#20107;&#21153;&#24615;&#27979;&#35797;&#25191;&#34892;
</li><li class="listitem">
<code class="literal">SqlScriptsTestExecutionListener</code>: &#25191;&#34892;&#36890;&#36807; <code class="literal">@Sql</code> &#27880;&#35299;&#37197;&#32622;&#30340;SQL&#33050;&#26412;
</li></ul></div>

<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-registering-tels" href="#testcontext-tel-config-registering-tels"></a>&#27880;&#20876;&#29992;&#25143;&#33258;&#23450;&#20041;&#30340; TestExecutionListeners</h5></div></div></div>

<p>&#29992;&#25143;&#33258;&#23450;&#20041;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s &#21487;&#20197;&#36890;&#36807;&#27880;&#35299; <code class="literal">@TestExecutionListeners</code> &#27880;&#20876;&#21040;&#27979;&#35797;&#31867;&#21450;&#20854;
&#23376;&#31867;&#20013;&#12290;&#20102;&#35299;&#27880;&#35299; <code class="literal">@TestExecutionListeners</code> &#30340;&#35814;&#24773;&#21644;&#31034;&#20363;&#65292;&#35831;&#21442;&#38405;<a class="link" href="aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;&#27880;&#35299;">&#27880;&#35299;&#25903;&#25345;</a>
&#21644;javadocs&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-automatic-discovery" href="#testcontext-tel-config-automatic-discovery"></a>&#40664;&#35748; TestExecutionListeners&#30340;&#33258;&#21160;&#21457;&#29616;</h5></div></div></div>

<p>&#36890;&#36807;&#27880;&#35299; <code class="literal">@TestExecutionListeners</code> &#27880;&#20876;&#29992;&#25143;&#33258;&#23450;&#20041;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s &#36866;&#21512;&#29992;&#25143;
&#33258;&#23450;&#20041;&#30417;&#21548;&#22120;&#30340;&#26377;&#38480;&#27979;&#35797;&#22330;&#26223;&#65307;&#23613;&#31649;&#22914;&#27492;&#65292;&#24403;&#29992;&#25143;&#33258;&#23450;&#20041;&#30417;&#21548;&#22120;&#36328;&#36234;&#27979;&#35797;&#22871;&#20214;&#30340;&#26102;&#20505;&#23558;&#20250;&#38750;&#24120;&#40635;&#28902;&#12290;&#20026;&#20102;&#35299;&#20915;&#36825;&#20010;&#38382;&#39064;&#65292;Spring &#26694;&#26550;
4.1 &#36890;&#36807; <code class="literal">SpringFactoriesLoader</code> &#26426;&#21046;&#25903;&#25345; <span class="emphasis"><em>&#40664;&#35748;</em></span> &#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code> &#23454;&#29616;&#30340;&#33258;&#21160;&#21457;&#29616;&#12290;</p>
<p>&#20855;&#20307;&#30340;&#65292;<code class="literal">spring-test</code> &#27169;&#22359;&#22312;&#23646;&#24615;&#25991;&#20214; <code class="literal">META-INF/spring.factories</code> &#19979;&#20197;<code class="literal">org.springframework.test.context.TestExecutionListener</code>
&#20026;&#38190;&#22768;&#26126;&#25152;&#26377;&#30340;&#26680;&#24515;&#40664;&#35748;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s &#12290;&#31532;&#19977;&#26041;&#26694;&#26550;&#21644;&#24320;&#21457;&#20154;&#21592;&#21487;&#20197;&#20197;&#30456;&#21516;&#30340;&#26041;&#24335;&#22312;&#23646;&#24615;&#25991;&#20214;&#20013;
&#22686;&#21152;&#20182;&#20204;&#33258;&#24049;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s &#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-ordering" href="#testcontext-tel-config-ordering"></a>TestExecutionListeners &#30340;&#39034;&#24207;</h5></div></div></div>

<p>&#24403;TestContext&#26694;&#26550;&#36890;&#36807;&#21069;&#36848;&#30340; <code class="literal">SpringFactoriesLoader</code> &#26426;&#21046;&#21457;&#29616;&#40664;&#35748;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListeners</code>&#65292;
&#23454;&#20363;&#21270;&#30340;&#30417;&#21548;&#22120;&#20351;&#29992;spring&#30340;&#27604;&#36739;&#22120; <code class="literal">AnnotationAwareOrderComparator</code> &#36827;&#34892;&#25490;&#24207;&#65292;&#35813;&#27604;&#36739;&#22120;&#23454;&#29616;&#20102; <code class="literal">Ordered</code> &#25509;&#21475;&#24182;&#21152;&#27880;
&#20102; <code class="literal">@Order</code> &#27880;&#35299;&#12290;spring&#25552;&#20379;&#30340; <code class="literal">AbstractTestExecutionListener</code> &#21644;&#25152;&#26377;&#30340;&#40664;&#35748;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s
&#37117;&#20351;&#29992;&#36866;&#24403;&#30340;&#20540;&#23454;&#29616;&#20102; <code class="literal">Ordered</code> &#25509;&#21475;&#12290; &#22240;&#27492;&#65292;&#31532;&#19977;&#26041;&#26694;&#26550;&#21644;&#24320;&#21457;&#20154;&#21592;&#20063;&#35201;&#30830;&#20445;&#20182;&#20204;&#30340; <span class="emphasis"><em>&#40664;&#35748;</em></span> &#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s
&#20351;&#29992;&#36866;&#24403;&#30340;&#39034;&#24207;&#27880;&#20876;&#65292;&#36890;&#36807;&#23454;&#29616; <code class="literal">Ordered</code> &#25509;&#21475;&#25110;&#32773;&#22768;&#26126; <code class="literal">@Order</code> &#27880;&#35299;&#12290;&#20026;&#20102;&#24324;&#28165;&#26970;&#27599;&#19968;&#20010;&#26680;&#24515;&#30417;&#21548;&#22120;&#36171;&#20540;&#35814;&#24773;&#65292;&#21487;&#20197;&#26597;&#38405;Javadoc&#26469;&#20102;&#35299;
&#40664;&#35748;&#30340;&#26680;&#24515;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>s &#30340; <code class="literal">getOrder()</code> &#26041;&#27861;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-merging" href="#testcontext-tel-config-merging"></a>&#21512;&#24182; TestExecutionListeners</h5></div></div></div>

<p>&#22914;&#26524;&#36890;&#36807; <code class="literal">@TestExecutionListeners</code> &#27880;&#35299;&#27880;&#20876;&#20102;&#29992;&#25143;&#33258;&#23450;&#20041;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120; <code class="literal">TestExecutionListener</code>&#65292;&#21017; <span class="emphasis"><em>default</em></span>
&#30417;&#21548;&#22120;&#23558;&#19981;&#20877;&#27880;&#20876;&#12290;&#22312;&#22823;&#22810;&#25968;&#27979;&#35797;&#22330;&#26223;&#19979;&#65292;&#36825;&#26377;&#25928;&#22320;&#24378;&#21046;&#20102;&#24320;&#21457;&#20154;&#21592;&#25163;&#21160;&#22768;&#26126;&#38500;&#20102;&#33258;&#23450;&#20041;&#30417;&#21548;&#22120;&#20197;&#22806;&#30340;&#25152;&#26377;&#40664;&#35748;&#30417;&#21548;&#22120;&#12290;&#19979;&#36848;&#30340;&#21015;&#34920;&#28436;&#31034;&#20102;
&#36825;&#31181;&#37197;&#32622;&#39118;&#26684;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestExecutionListeners({
    MyCustomTestExecutionListener.class,
    ServletTestExecutionListener.class,
    DependencyInjectionTestExecutionListener.class,
    DirtiesContextTestExecutionListener.class,
    TransactionalTestExecutionListener.class,
    SqlScriptsTestExecutionListener.class
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#36825;&#31181;&#26041;&#27861;&#30340;&#25361;&#25112;&#26102;&#23427;&#38656;&#35201;&#24320;&#21457;&#20154;&#21592;&#30830;&#20999;&#22320;&#20102;&#35299;&#21738;&#20123;&#30417;&#21548;&#22120;&#20250;&#40664;&#35748;&#27880;&#20876;&#12290;&#32780;&#19988;&#65292;&#36825;&#20123;&#40664;&#35748;&#30340;&#30417;&#21548;&#22120;&#22312;&#19981;&#21516;&#30340;&#29256;&#26412;&#20043;&#38388;&#36824;&#20250;&#21464;&#26356;--
&#20363;&#22914;&#65292;<code class="literal">SqlScriptsTestExecutionListener</code> &#30417;&#21548;&#22120;&#26102;&#22312;spring 4.1&#20013;&#34987;&#24341;&#20837;&#30340;&#12290;&#27492;&#22806;&#65292;&#31532;&#19977;&#26041;&#26694;&#26550;&#21916;&#27426;&#36890;&#36807;&#21069;&#36848;&#30340;
<a class="link" href="aop-api.html#testcontext-tel-config-automatic-discovery" title="&#40664;&#35748; TestExecutionListeners&#30340;&#33258;&#21160;&#21457;&#29616;">&#33258;&#21160;&#21457;&#29616;&#26426;&#21046;</a> &#26469;&#27880;&#20876;&#20182;&#20204;&#33258;&#24049;&#30340;&#40664;&#35748;&#30340;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120;
<code class="literal">TestExecutionListener</code>&#12290;</p>
<p>&#20026;&#20102;&#36991;&#20813;&#24517;&#39035;&#30693;&#36947;&#25110;&#32773;&#26102;&#37325;&#26032;&#22768;&#26126; <span class="strong"><strong>&#25152;&#26377;</strong></span> <span class="emphasis"><em>&#40664;&#35748;</em></span> &#30417;&#21548;&#22120;&#65292;&#27979;&#35797;&#25191;&#34892;&#30417;&#21548;&#22120;&#27880;&#35299; <code class="literal">@TestExecutionListeners</code>&#30340;
<code class="literal">mergeMode</code> &#23646;&#24615;&#21487;&#20197;&#35774;&#32622;&#20026; <code class="literal">MergeMode.MERGE_WITH_DEFAULTS</code>&#12290; &#35813;&#23646;&#24615;&#29992;&#26469;&#25351;&#31034;&#26412;&#22320;&#22768;&#26126;&#30340;&#30417;&#21548;&#22120;&#24212;&#35813;&#19982;&#40664;&#35748;&#30340;
&#30417;&#21548;&#22120;&#36827;&#34892;&#21512;&#24182;&#12290;&#21512;&#24182;&#31639;&#27861;&#30830;&#20445;&#37325;&#22797;&#30340;&#30417;&#21548;&#22120;&#23558;&#20174;&#21015;&#34920;&#20013;&#21024;&#38500;&#24182;&#19988;&#21512;&#24182;&#30340;&#30417;&#21548;&#22120;&#32467;&#26524;&#38598;&#21512;&#26159;&#26681;&#25454; <code class="literal">AnnotationAwareOrderComparator</code>
&#30340;&#35821;&#20041;&#26377;&#24207;&#25490;&#21015;&#30340;&#65292;&#20854;&#25490;&#24207;&#24212;&#35813;&#19982; <a class="xref" href="aop-api.html#testcontext-tel-config-ordering" title="TestExecutionListeners &#30340;&#39034;&#24207;">the section called &#8220;TestExecutionListeners &#30340;&#39034;&#24207;&#8221;</a> &#20013;&#30340;&#25551;&#36848;&#19968;&#33268;&#12290;&#22914;&#26524;&#19968;&#20010;&#30417;&#21548;&#22120;&#23454;&#29616;&#20102;
<code class="literal">Ordered</code> &#25509;&#21475;&#25110;&#32773;&#26102;&#22768;&#26126;&#20102; <code class="literal">@Order</code> &#27880;&#35299;&#65292;&#23427;&#23558;&#24433;&#21709;&#19982;&#40664;&#35748;&#30340;&#30417;&#21548;&#22120;&#21512;&#24182;&#25152;&#22312;&#30340;&#20301;&#32622;&#65292;&#21542;&#21017;&#22312;&#21512;&#24182;&#30340;&#26102;&#20505;&#26412;&#22320;&#22768;&#26126;
&#30340;&#30417;&#21548;&#22120;&#23558;&#31616;&#21333;&#22320;&#36861;&#21152;&#21040;&#40664;&#35748;&#30340;&#30417;&#21548;&#22120;&#21015;&#34920;&#19978;&#12290;</p>
<p>&#20363;&#22914;&#65292;&#22312;&#21069;&#38754;&#30340;&#31034;&#20363;&#37197;&#32622;&#20013;&#65292;&#22914;&#26524;&#30417;&#21548;&#22120; <code class="literal">MyCustomTestExecutionListener</code> &#31867;&#30340; <code class="literal">order</code> &#20540;&#65288;&#20363;&#22914;&#65292;<code class="literal">500</code>&#65289;
&#23567;&#20110; <code class="literal">ServletTestExecutionListener</code> &#31867;&#30340;&#20540;&#65288;&#30896;&#24039;&#26159;<code class="literal">1000</code>&#65289;&#65292;&#20110;&#26159; <code class="literal">MyCustomTestExecutionListener</code>
&#23558;&#33258;&#21160;&#22320;&#21512;&#24182;&#21040; <code class="literal">ServletTestExecutionListener</code> &#31867;&#30340; <span class="emphasis"><em>&#21069;&#38754;</em></span> &#65292;&#21069;&#38754;&#30340;&#31034;&#20363;&#23558;&#26367;&#25442;&#25104;&#19979;&#36848;&#30340;&#24418;&#24335;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestExecutionListeners(
    listeners = MyCustomTestExecutionListener.class,
    mergeMode = MERGE_WITH_DEFAULTS,
)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-ctx-management" href="#testcontext-ctx-management"></a>&#19978;&#19979;&#25991;&#31649;&#29702;</h4></div></div></div>

<p>&#27599;&#19968;&#20010; <code class="literal">TestContext</code> &#20026;&#23427;&#25152;&#36127;&#36131;&#30340;&#27979;&#35797;&#23454;&#20363;&#25552;&#20379;&#20102;&#19978;&#19979;&#25991;&#31649;&#29702;&#21644;&#32531;&#23384;&#25903;&#25345;&#12290;&#27979;&#35797;&#23454;&#20363;&#19981;&#20250;&#33258;&#21160;&#22320;&#25509;&#21463;&#23545;&#37197;&#32622;&#30340;
&#24212;&#29992;&#19978;&#19979;&#20026; <code class="literal">ApplicationContext</code> &#30340;&#26041;&#27861;&#12290; &#23613;&#31649;&#22914;&#27492;&#65292;&#22914;&#26524;&#19968;&#20010;&#27979;&#35797;&#31867;&#23454;&#29616;&#20102; <code class="literal">ApplicationContextAware</code>
&#25509;&#21475;&#65292;&#22312;&#27979;&#35797;&#31867;&#20013;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#30340;&#24341;&#29992;&#23558;&#34987;&#25552;&#20379;&#12290;&#27880;&#24847;&#65292;  <code class="literal">AbstractJUnit4SpringContextTests</code>
&#21644; <code class="literal">AbstractTestNGSpringContextTests</code> &#23454;&#29616;&#20102;&#25509;&#21475; <code class="literal">ApplicationContextAware</code> &#65292;&#22240;&#27492;&#33258;&#21160;&#22320;&#25552;&#20379;
&#20102;&#23545; <code class="literal">ApplicationContext</code> &#23545;&#35937;&#30340;&#26041;&#27861;&#12290;</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: @Autowired ApplicationContext"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">@Autowired ApplicationContext</th></tr><tr><td align="left" valign="top">

<p>&#20316;&#20026;&#23454;&#29616; <code class="literal">ApplicationContextAware</code> &#25509;&#21475;&#30340;&#19968;&#31181;&#21487;&#36873;&#26041;&#24335;&#65292;&#20320;&#21487;&#20197;&#36890;&#36807;&#22312;&#23383;&#27573;&#25110;setter&#26041;&#27861;&#19978;&#22686;&#21152;&#27880;&#35299;
<code class="literal">@Autowired</code> &#26469;&#20026;&#20320;&#30340;&#27979;&#35797;&#31867;&#27880;&#20837;&#24212;&#29992;&#19978;&#19979;&#25991;&#23545;&#35937;&#65292;&#20363;&#22914;&#65306;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)a</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> ApplicationContext applicationContext;

    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#31867;&#20284;&#22320;&#65292;&#22914;&#26524;&#20320;&#30340;&#27979;&#35797;&#37197;&#32622;&#20026;&#21152;&#36733;&#19968;&#20010;  <code class="literal">WebApplicationContext</code> &#65292;&#20320;&#21487;&#20197;&#27880;&#20837;web&#24212;&#29992;&#19978;&#19979;&#25991;&#21040;&#20320;&#30340;&#27979;&#35797;&#20013;&#65292;&#22914;&#19979;&#65306;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="strong"><strong>@WebAppConfiguration</strong></span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebAppTest {
    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#36890;&#36807;&#27880;&#35299; <code class="literal">@Autowired</code> &#20381;&#36182;&#27880;&#20837;&#21151;&#33021;&#30001; <code class="literal">DependencyInjectionTestExecutionListener</code> &#25552;&#20379;&#65292;&#35813;
&#30417;&#21548;&#22120;&#23646;&#20110;&#40664;&#35748;&#37197;&#32622;&#65288;&#20855;&#20307;&#21487;&#21442;&#32771; <a class="xref" href="aop-api.html#testcontext-fixture-di" title="Dependency injection of test fixtures">the section called &#8220;Dependency injection of test fixtures&#8221;</a> &#65289;&#12290;</p>
</td></tr></table></div>

<p>&#20351;&#29992;&#27979;&#35797;&#26694;&#26550;&#30340;&#31867;&#19981;&#38656;&#35201;&#32487;&#25215;&#29305;&#23450;&#30340;&#31867;&#25110;&#23454;&#29616;&#29305;&#23450;&#30340;&#25509;&#21475;&#12290;&#21453;&#32780;&#65292;&#22312;&#31867;&#32423;&#21035;&#22768;&#26126;&#19968;&#20010; <code class="literal">@ContextConfiguration</code> &#27880;&#35299;
&#23601;&#21487;&#20197;&#31616;&#21333;&#22320;&#37197;&#32622;&#12290;&#22914;&#26524;&#20320;&#30340;&#27979;&#35797;&#31867;&#27809;&#26377;&#26126;&#30830;&#22320;&#22768;&#26126;&#24212;&#29992;&#19978;&#19979;&#25991;&#36164;&#28304; <code class="literal">&#20301;&#32622;</code> &#25110;&#27880;&#35299; <code class="literal">&#31867;</code>&#65292;&#37197;&#32622;&#30340;&#19978;&#19979;&#25991;&#21152;&#36733;&#22120;
<code class="literal">ContextLoader</code> &#23558;&#20915;&#23450;&#22914;&#20309;&#20174;&#40664;&#35748;&#30340;&#20301;&#32622;&#25110;&#40664;&#35748;&#30340;&#37197;&#32622;&#31867;&#19978;&#21152;&#36733;&#19978;&#19979;&#25991;&#12290; &#38500;&#20102;&#19978;&#19979;&#25991;&#36164;&#28304; <code class="literal">&#20301;&#32622;</code> &#21644;&#27880;&#35299; <code class="literal">&#31867;</code> &#30340;
&#26041;&#24335;&#65292;&#20320;&#36824;&#21487;&#20197;&#36890;&#36807;&#24212;&#29992;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120; <code class="literal">initializers</code> &#30340;&#26041;&#24335;&#12290;</p>
<p>&#19979;&#36848;&#31456;&#33410;&#65292;&#35299;&#37322;&#20102;&#37197;&#32622;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#30340;&#20960;&#31181;&#26041;&#24335;&#65292;&#36890;&#36807;XML&#37197;&#32622;&#25991;&#20214;&#65292;&#36890;&#36807;&#27880;&#35299;&#31867;&#65288;&#20856;&#22411;&#30340;&#26159;
&#22686;&#21152;&#20102; <code class="literal">@Configuration</code> &#27880;&#35299;&#30340;&#31867;&#65289;&#65292;&#25110;&#32773;&#36890;&#36807;&#20351;&#29992;Spring&#30340;  <code class="literal">@ContextConfiguration</code>  &#27880;&#35299;&#30340;&#21021;&#22987;&#21270;&#22120;
&#30340;&#26041;&#24335;&#12290; &#21487;&#36873;&#22320;&#65292; &#20026;&#20102;&#39640;&#32423;&#30340;&#29992;&#20363;&#65292;&#20320;&#36824;&#21487;&#20197;&#23454;&#29616;&#21644;&#37197;&#32622;&#20320;&#33258;&#24049;&#30340;&#26234;&#33021;&#19978;&#19979;&#25991;&#21152;&#36733;&#22120;&#31867; <code class="literal">SmartContextLoader</code>&#12290;</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-xml" href="#testcontext-ctx-management-xml"></a>&#20351;&#29992;XML&#36164;&#28304;&#30340;&#19978;&#19979;&#25991;&#37197;&#32622;</h5></div></div></div>

<p>&#20351;&#29992;XML&#37197;&#32622;&#25991;&#20214;&#20026;&#20320;&#30340;&#27979;&#35797;&#21152;&#36733;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#65292; &#20351;&#29992; <code class="literal">@ContextConfiguration</code>
&#27880;&#35299;&#20320;&#30340;&#27979;&#35797;&#31867;&#24182;&#20197;&#25968;&#32452;&#30340;&#24418;&#24335;&#37197;&#32622; <code class="literal">locations</code> &#23646;&#24615;&#65292;&#35813;&#23646;&#24615;&#21253;&#21547;XML&#37197;&#32622;&#20803;&#25968;&#25454;&#30340;&#36164;&#28304;&#20301;&#32622;&#12290;&#19968;&#20010;&#26222;&#36890;&#30340;&#30456;&#23545;&#36335;&#24452;
&#8212;&#8212; &#20363;&#22914;&#65292;<code class="literal">"context.xml"</code> &#8212;&#8212;&#23558;&#20250;&#35748;&#20026;&#26159;&#30456;&#23545;&#20110;&#27979;&#35797;&#31867;&#23450;&#20041;&#25152;&#22312;&#21253;&#30340;&#30456;&#23545;&#36335;&#24452;&#12290; &#22914;&#26524;&#19968;&#20010;&#36335;&#24452;&#20197;&#8220;/&#8221;&#24320;&#22987;&#65292;&#21017;&#35813;&#36335;&#24452;
&#34987;&#35748;&#20026;&#26159;&#19968;&#20010;&#32477;&#23545;&#30340;&#31867;&#36335;&#24452;&#20301;&#32622;&#65292;&#20363;&#22914;&#65292;<code class="literal">"/org/example/config.xml"</code>&#12290;&#19968;&#20010;&#34920;&#31034;&#36164;&#28304;&#30340;URL&#65288;&#20363;&#22914;&#65292;&#19968;&#20010;&#36335;&#24452;&#21069;&#32512;
&#20026; <code class="literal">classpath:</code> , <code class="literal">file:</code> , <code class="literal">http:</code> , &#31561;&#31561;&#65289;&#36335;&#24452;&#39038;&#21517;&#24605;&#20041;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;&#23558;&#20250;&#20174;&#31867;&#36335;&#24452;&#26681;&#19979;&#30340; "/app-config.xml" &#21644; "/test-config.xml" &#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration(locations={"/app-config.xml", "/test-config.xml"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#27880;&#35299; <code class="literal">@ContextConfiguration</code> &#36890;&#36807;&#26631;&#20934;&#30340;Java <code class="literal">value</code> &#23646;&#24615;&#25903;&#25345;  <code class="literal">locations</code> &#23646;&#24615;&#30340;&#21035;&#21517;&#12290;
&#22240;&#27492;&#65292;&#22914;&#26524;&#22312;&#27880;&#35299; <code class="literal">@ContextConfiguration</code> &#20013;&#27809;&#26377;&#21035;&#30340;&#23646;&#24615;&#38656;&#35201;&#35774;&#32622;&#65292; &#20320;&#21487;&#20197;&#24573;&#30053; <code class="literal">locations</code> &#23646;&#24615;
&#30340;&#21517;&#23383;&#20351;&#29992;&#19968;&#31181;&#22914;&#19979;&#31034;&#20363;&#30340;&#31616;&#27905;&#26041;&#24335;&#36827;&#34892;&#22768;&#26126;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="strong"><strong>@ContextConfiguration({"/app-config.xml", "/test-config.xml"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#22914;&#26524;&#20320;&#21516;&#26102;&#24573;&#30053;&#20102; <code class="literal">@ContextConfiguration</code> &#27880;&#35299;&#30340; <code class="literal">locations</code> &#21644; <code class="literal">value</code> &#23646;&#24615;&#65292; &#37027;&#20040;&#27979;&#35797;&#19978;&#19979;&#25991;&#26694;&#26550;
&#23558;&#20250;&#23581;&#35797;&#25506;&#27979;&#40664;&#35748;&#30340;XML&#36164;&#28304;&#20301;&#32622;&#12290;&#30830;&#20999;&#22320;&#35828;&#65292;<code class="literal">GenericXmlContextLoader</code> &#21644; <code class="literal">GenericXmlWebContextLoader</code> &#20250;
&#22522;&#20110;&#27979;&#35797;&#31867;&#30340;&#21517;&#23383;&#25506;&#27979;&#40664;&#35748;&#30340;&#20301;&#32622;&#65292;&#22914;&#26524;&#20320;&#30340;&#27979;&#35797;&#31867;&#21629;&#21517;&#20026; <code class="literal">com.example.MyTest</code> &#65292;<code class="literal">GenericXmlContextLoader</code> &#31867;
&#23558;&#20174; <code class="literal">"classpath:com/example/MyTest-context.xml"</code> &#20301;&#32622;&#21152;&#36733;&#24212;&#29992;&#19978;&#19979;&#25991;&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.example;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;&#23558;&#20174; "classpath:com/example/MyTest-context.xml" &#20301;&#32622;&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-groovy" href="#testcontext-ctx-management-groovy"></a>&#20351;&#29992;Groovy&#33050;&#26412;&#37197;&#32622;&#19978;&#19979;&#25991;</h5></div></div></div>

<p>&#20351;&#29992;Groovy&#33050;&#26412;&#20026;&#20320;&#30340;&#27979;&#35797;&#31867;&#21152;&#36733;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code>&#65292;&#21487;&#20197;&#21033;&#29992; <a class="link" href="new-in-4.0.html#groovy-bean-definition-dsl" title="3.5&nbsp;Groovy DSL&#23450;&#20041;Bean">Groovy DSL</a>
&#27880;&#35299;&#20320;&#30340;&#27979;&#35797;&#31867;&#65292; &#22312;&#27880;&#35299; <code class="literal">@ContextConfiguration</code> &#30340; <code class="literal">locations</code> &#21644; <code class="literal">value</code> &#23646;&#24615;&#20013;&#20351;&#29992;&#19968;&#20010;&#21253;&#21547;Groovy &#33050;&#26412;
&#30340;&#36164;&#28304;&#20301;&#32622;&#30340;&#25968;&#32452;&#37197;&#32622;&#23646;&#24615;&#12290;&#36164;&#28304;&#26597;&#25214;&#30340;&#35821;&#20041;&#21644;<a class="link" href="aop-api.html#testcontext-ctx-management-xml" title="&#20351;&#29992;XML&#36164;&#28304;&#30340;&#19978;&#19979;&#25991;&#37197;&#32622;">XML &#37197;&#32622;&#25991;&#20214;</a>&#30340;&#25551;&#36848;&#26159;&#19968;&#33268;&#30340;&#12290;</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: &#21551;&#21160; Groovy &#33050;&#26412;&#25903;&#25345;"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">&#21551;&#21160; Groovy &#33050;&#26412;&#25903;&#25345;</th></tr><tr><td align="left" valign="top">

<p>&#22914;&#26524;Groovy&#22312;&#31867;&#36335;&#24452;&#19978;&#65292;&#22312;&#27979;&#35797;&#19978;&#19979;&#25991;&#26694;&#26550;&#20013;&#20351;&#29992;Groovy&#33050;&#26412;&#21152;&#36733;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#30340;&#25903;&#25345;&#26159;&#33258;&#21160;&#21551;&#21160;&#30340;&#12290;</p>
</td></tr></table></div>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;&#23558;&#20174;&#31867;&#36335;&#24452;&#26681;&#19979;&#30340; "/AppConfig.groovy" &#21644; "/TestConfig.groovy" &#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration({"/AppConfig.groovy", "/TestConfig.Groovy"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#22914;&#26524;&#20320;&#21516;&#26102;&#24573;&#30053;&#20102;&#27880;&#35299; <code class="literal">@ContextConfiguration</code> &#30340; <code class="literal">locations</code> &#21644; <code class="literal">value</code> &#23646;&#24615;&#65292;&#21017;&#27979;&#35797;&#19978;&#19979;&#25991;&#26694;&#26550;&#23558;&#20250;
&#23581;&#35797;&#25506;&#27979;&#40664;&#35748;&#30340;Groovy&#33050;&#26412;&#12290;&#30830;&#20999;&#22320;&#35828;&#65292;&#21152;&#36733;&#22120; <code class="literal">GenericGroovyXmlContextLoader</code> &#21644; <code class="literal">GenericGroovyXmlWebContextLoader</code>
&#22522;&#20110;&#27979;&#35797;&#31867;&#30340;&#21517;&#23383;&#25506;&#27979;&#40664;&#35748;&#30340;&#20301;&#32622;&#12290;&#22914;&#26524;&#20320;&#30340;&#27979;&#35797;&#31867;&#21629;&#21517;&#20026; <code class="literal">com.example.MyTest</code> &#65292; &#37027;&#20040;Groovy&#19978;&#19979;&#25991;&#21152;&#36733;&#22120;&#23558;&#20250;
&#20174;&#20301;&#32622; <code class="literal">"classpath:com/example/MyTestContext.groovy"</code> &#21152;&#36733;&#20320;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991;&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.example;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991; ApplicationContext &#23558;&#20174;&#20301;&#32622; "classpath:com/example/MyTestContext.groovy" &#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: &#21516;&#26102;&#22768;&#26126;XML &#37197;&#32622;&#21644;Groovy&#33050;&#26412;"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">&#21516;&#26102;&#22768;&#26126;XML &#37197;&#32622;&#21644;Groovy&#33050;&#26412;</th></tr><tr><td align="left" valign="top">

<p>XML&#37197;&#32622;&#25991;&#20214;&#21644;Groovy&#33050;&#26412;&#21487;&#20197;&#36890;&#36807;&#27880;&#35299;  <code class="literal">@ContextConfiguration</code> &#30340;&#23646;&#24615; <code class="literal">locations</code> &#25110; <code class="literal">value</code> &#21516;&#26102;
&#21516;&#26102;&#22768;&#26126;&#12290;&#22914;&#26524;&#37197;&#32622;&#30340;&#36164;&#28304;&#20301;&#32622;&#20197; <code class="literal">.xml</code> &#32467;&#23614;&#65292;&#21017;&#23558;&#20351;&#29992; <code class="literal">XmlBeanDefinitionReader</code> &#21152;&#36733;&#65292;&#21542;&#21017;&#23558;&#20250;&#20351;&#29992;
<code class="literal">GroovyBeanDefinitionReader</code> &#21152;&#36733;&#12290;</p>
<p>&#19979;&#36848;&#31034;&#20363;&#28436;&#31034;&#22312;&#38598;&#25104;&#27979;&#35797;&#20013;&#28151;&#21512;&#20004;&#31181;&#26041;&#24335;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext &#23558;&#20174;&#20301;&#32622;"/app-config.xml" &#21644; "/TestConfig.groovy"&#21152;&#36733;</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({ "/app-config.xml", "/TestConfig.groovy" })</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-javaconfig" href="#testcontext-ctx-management-javaconfig"></a>&#20351;&#29992;&#27880;&#35299;&#31867;&#37197;&#32622;&#19978;&#19979;&#25991;</h5></div></div></div>

<p>&#20351;&#29992;<span class="emphasis"><em>&#27880;&#35299;&#31867;</em></span> &#65288;&#21442;&#32771;<a class="xref" href="">???</a>&#65289;&#20026;&#20320;&#30340;&#27979;&#35797;&#31867;&#21152;&#36733;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#65292;&#21487;&#20197;
&#20026;&#20320;&#30340;&#27979;&#35797;&#31867;&#22686;&#21152;&#27880;&#35299;  <code class="literal">@ContextConfiguration</code> &#24182;&#20351;&#29992;&#19968;&#20010;&#25968;&#32452;&#37197;&#32622;&#20854; <code class="literal">classes</code> &#23646;&#24615;&#65292;&#35813;&#25968;&#32452;&#21253;&#21547;&#27880;&#35299;
&#31867;&#30340;&#24341;&#29992;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext &#23558;&#20174;AppConfig &#21644; TestConfig &#37197;&#32622;&#31867;&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration(classes = {AppConfig.class, TestConfig.class})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: &#27880;&#35299;&#31867;"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">&#27880;&#35299;&#31867;</th></tr><tr><td align="left" valign="top">

<p><span class="emphasis"><em>&#27880;&#35299;&#31867;</em></span> &#21487;&#20197;&#25351;&#19979;&#36848;&#20013;&#30340;&#20219;&#20309;&#19968;&#31181;&#12290;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#20351;&#29992;&#27880;&#35299; <code class="literal">@Configuration</code> &#37197;&#32622;&#30340;&#31867;
</li><li class="listitem">
&#19968;&#20010;&#32452;&#20214; (&#20363;&#22914;, &#34987; <code class="literal">@Component</code>, <code class="literal">@Service</code>, <code class="literal">@Repository</code>&#31561;&#27880;&#35299;&#30340;&#31867;.)
</li><li class="listitem">
&#19968;&#20010;&#20351;&#29992; <code class="literal">javax.inject</code> &#27880;&#35299;&#30340; JSR-330 &#20860;&#23481;&#31867;
</li><li class="listitem">
&#20219;&#24847;&#21253;&#21547;<code class="literal">@Bean</code>&#27880;&#35299;&#26041;&#27861;&#30340;&#31867;
</li></ul></div>

<p>&#21442;&#38405;&#27880;&#35299; <code class="literal">@Configuration</code> &#21644; <code class="literal">@Bean</code> &#30340;javadoc&#20102;&#35299; <span class="emphasis"><em>&#27880;&#35299;&#31867;</em></span> &#30340;&#37197;&#32622;&#21644;&#35821;&#20041;&#30340;&#28145;&#20837;&#20449;&#24687;&#65292;&#35831;&#22810;&#20851;&#27880;
<span class="emphasis"><em>`@Bean` Lite Mode</em></span> &#30340;&#35752;&#35770;&#12290;</p>
</td></tr></table></div>

<p>&#22914;&#26524;&#20320;&#24573;&#30053;&#20102;&#30452;&#25509;  <code class="literal">@ContextConfiguration</code> &#30340; <code class="literal">classes</code> &#23646;&#24615;&#65292;&#27979;&#35797;&#19978;&#19979;&#25991;&#26694;&#26550;&#23558;&#20250;&#23581;&#35797;&#25506;&#27979;&#40664;&#35748;&#37197;&#32622;
&#31867;&#30340;&#23384;&#22312;&#12290;&#30830;&#20999;&#22320;&#35828;&#65292;&#21152;&#36733;&#22120; <code class="literal">AnnotationConfigContextLoader</code> &#21644; <code class="literal">AnnotationConfigWebContextLoader</code>
&#23558;&#20250;&#25506;&#27979;&#28385;&#36275;&#38656;&#27714;&#30340;&#25152;&#26377;&#27979;&#35797;&#31867;&#30340;&#38745;&#24577;&#20869;&#37096;&#31867;&#65292; &#36825;&#20123;&#20869;&#37096;&#31867;&#36890;&#36807;&#27880;&#35299; <code class="literal">@Configuration</code> &#25351;&#23450;&#20102;&#20854;&#37197;&#32622;&#12290;&#19979;&#36848;&#31034;&#20363;
&#20013;&#65292;&#27979;&#35797;&#31867; <code class="literal">OrderServiceTest</code> &#22768;&#26126;&#20102;&#19968;&#20010;&#21517;&#23383;&#20026; <code class="literal">Config</code> &#30340;&#38745;&#24577;&#20869;&#37096;&#37197;&#32622;&#31867;&#65292; &#35813;&#31867;&#34987;&#29992;&#26469;&#20026;&#27979;&#35797;&#31867;&#21152;&#36733;&#24212;&#29992;
&#19978;&#19979;&#25991;  <code class="literal">ApplicationContext</code> &#12290;&#35831;&#27880;&#24847;&#65292;&#37197;&#32622;&#31867;&#30340;&#21517;&#23383;&#26159;&#20219;&#24847;&#30340;&#12290;&#38500;&#27492;&#20043;&#22806;&#65292;&#24517;&#35201;&#26102;&#65292;&#19968;&#20010;&#27979;&#35797;&#31867;&#21487;&#20197;&#21253;&#21547;&#22810;&#20010;
&#38745;&#24577;&#20869;&#37096;&#37197;&#32622;&#31867;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991; ApplicationContext &#23558;&#20174;&#38745;&#24577;&#20869;&#37096;&#37197;&#32622;&#31867; Config&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderServiceTest {

    <em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
    <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Config {

        <span class="hl-comment">// &#36825;&#20010;Bean&#23558;&#27880;&#20837;&#21040;OrderServiceTest&#20013;</span>
        <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
        <span class="hl-keyword">public</span> OrderService orderService() {
            OrderService orderService = <span class="hl-keyword">new</span> OrderServiceImpl();
            <span class="hl-comment">// &#35774;&#32622;&#23646;&#24615;&#65292; &#31561;&#31561;&#25805;&#20316;</span>
            <span class="hl-keyword">return</span> orderService;
        }
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> OrderService orderService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testOrderService() {
        <span class="hl-comment">// &#27979;&#35797;&#26381;&#21153; orderService</span>
    }

}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-mixed-config" href="#testcontext-ctx-management-mixed-config"></a>&#32452;&#21512;XML&#65292;Groovy&#33050;&#26412;&#21644;&#27880;&#35299;&#31867;&#19977;&#31181;&#37197;&#32622;&#26041;&#24335;</h5></div></div></div>

<p>&#26377;&#26102;&#20505;&#65292;&#21487;&#20197;&#26399;&#26395;&#32452;&#21512;XML&#37197;&#32622;&#25991;&#20214;&#12289;Groovy&#33050;&#26412;&#21644;&#27880;&#35299;&#31867;&#65288;&#20363;&#22914;&#65292;&#20856;&#22411;&#30340; <code class="literal">@Configuration</code> &#31867;&#65289;&#19977;&#31181;&#26041;&#24335;
&#26469;&#20026;&#20320;&#30340;&#27979;&#35797;&#31867;&#37197;&#32622;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991;&#12290;&#20363;&#22914;&#65292;&#20320;&#22312;&#20135;&#21697;&#20013;&#20351;&#29992;XML&#37197;&#32622;&#65292;&#22312;&#27979;&#35797;&#20013;&#20320;&#21487;&#33021;&#20915;&#23450;&#24819;&#20351;&#29992;&#27880;&#35299;&#31867; <code class="literal">@Configuration</code>
&#26469;&#37197;&#32622;Springg&#31649;&#29702;&#30340;&#32452;&#20214;&#65292;&#21453;&#20043;&#20134;&#28982;&#12290;</p>
<p>&#27492;&#22806;&#65292;&#19968;&#20123;&#31532;&#19977;&#26041;&#26694;&#26550;&#65288;&#23601;&#20687;Spring Boot&#65289;&#20026;&#21152;&#36733;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#25552;&#20379;&#20102;&#20248;&#31168;&#30340;&#25903;&#25345;&#65292;&#20182;&#20204;
&#21487;&#20197;&#20174;&#19981;&#21516;&#31867;&#22411;&#30340;&#36164;&#28304;&#20013;&#21516;&#26102;&#21152;&#36733;&#65288;&#20363;&#22914;&#65292;XML&#37197;&#32622;&#25991;&#20214;&#65292;Groovy&#33050;&#26412;&#21644;&#22686;&#21152;&#20102; <code class="literal">@Configuration</code> &#30340;&#31867;&#65289;&#12290;&#30001;&#20110;&#21382;&#21490;&#30340;&#21407;&#22240;&#65292;
Spring&#26694;&#26550;&#27809;&#26377;&#20197;&#26631;&#20934;&#21457;&#24067;&#30340;&#24418;&#24335;&#25903;&#25345;&#28151;&#21512;&#37197;&#32622;&#12290;&#22240;&#27492;&#65292;Spring&#26694;&#26550;&#20013;&#30340; <code class="literal">spring-test</code> &#27169;&#22359;&#30340;&#22823;&#22810;&#25968;&#19978;&#19979;&#25991;
&#21152;&#36733;&#22120; <code class="literal">SmartContextLoader</code> &#30340;&#23454;&#29616;&#22312;&#27599;&#19968;&#20010;&#27979;&#35797;&#19978;&#19979;&#25991;&#20013;&#20165;&#25903;&#25345;&#19968;&#31181;&#36164;&#28304;&#31867;&#22411;&#65307;&#23613;&#31649;&#22914;&#27492;&#65292;&#36825;&#24182;&#19981;&#24847;&#21619;&#30528;&#20320;
&#19981;&#33021;&#21516;&#26102;&#20351;&#29992;&#23427;&#20204;&#12290;&#36890;&#29992;&#35268;&#21017;&#30340;&#19968;&#20010;&#20363;&#22806;&#26159;&#19978;&#19979;&#25991;&#21152;&#36733;&#22120; <code class="literal">GenericGroovyXmlContextLoader</code> &#21644; <code class="literal">GenericGroovyXmlWebContextLoader</code>
&#21516;&#26102;&#25903;&#25345;XML&#37197;&#32622;&#25991;&#20214;&#21644;Groovy&#33050;&#26412;&#12290; &#27492;&#22806;&#65292;&#31532;&#19977;&#26041;&#26694;&#26550;&#21487;&#33021;&#36890;&#36807;&#27880;&#35299; <code class="literal">@ContextConfiguration</code> &#36873;&#25321;&#25903;&#25345;
<code class="literal">locations</code> &#21644; <code class="literal">classes</code> &#30340;&#22768;&#26126;&#20197;&#21450;&#27979;&#35797;&#26694;&#26550;&#30340;&#26631;&#20934;&#27979;&#35797;&#25903;&#25345;&#65292; &#20320;&#21487;&#20197;&#26377;&#22914;&#19979;&#30340;&#36873;&#39033;&#12290;</p>
<p>&#22914;&#26524;&#20320;&#24819;&#20351;&#29992;&#36164;&#28304;&#20301;&#32622;&#65288;&#20363;&#22914;&#65292;XML&#25110;Groovy&#33050;&#26412;&#65289; <span class="emphasis"><em>&#21644;</em></span> &#27880;&#35299; <code class="literal">@Configuration</code>&#31867;&#37197;&#32622;&#20320;&#30340;&#27979;&#35797;&#31867;&#65292;&#20320;&#24517;&#39035;
&#36873;&#25321;&#19968;&#20010;&#20316;&#20026; <span class="emphasis"><em>&#20837;&#21475;&#28857;</em></span> &#65292;&#24182;&#19988;&#21478;&#22806;&#19968;&#20010;&#24517;&#39035;&#21253;&#25324;&#25110;&#32773;&#23548;&#20837;&#21040;&#21478;&#19968;&#20010;&#12290;&#20363;&#22914;&#65292;&#22312;XML&#25110;Groovy&#33050;&#26412;&#20013;&#65292;&#20320;&#21487;&#20197;&#36890;&#36807;&#32452;&#20214;
&#25195;&#25551;&#25110;&#27491;&#24120;&#23450;&#20041;Spring beans&#21253;&#21547; <code class="literal">@Configuration</code> &#31867;;&#21453;&#36807;&#26469;&#65292;&#22312;&#27880;&#35299; <code class="literal">@Configuration</code> &#37197;&#32622;&#30340;&#31867;&#20013;&#65292;
&#20320;&#21487;&#20197;&#20351;&#29992;&#27880;&#35299; <code class="literal">@ImportResource</code> &#23548;&#20837;XML&#37197;&#32622;&#25991;&#20214;&#12290;&#27880;&#24847;&#65292;&#36825;&#31181;&#34892;&#20026;&#19982;&#22312;&#20135;&#21697;&#20013;&#37197;&#32622;&#24744;&#30340;&#24212;&#29992;&#22312;&#35821;&#20041;&#19978;&#26159;&#31561;&#20215;&#30340;&#65306;
&#22312;&#20135;&#21697;&#37197;&#32622;&#20013;&#65292;&#20320;&#21487;&#20197;&#23450;&#20041;XML&#25110;Groovy&#36164;&#28304;&#20301;&#32622;&#30340;&#38598;&#21512;&#65292;&#25110;&#32773;&#37197;&#32622;&#31867; <code class="literal">@Configuration</code> &#30340;&#38598;&#21512;&#65292;&#20135;&#21697;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991;
<code class="literal">ApplicationContext</code> &#23558;&#20174;&#20013;&#21152;&#36733;&#65292; &#20294;&#26159;&#20320;&#20173;&#28982;&#26377;&#21253;&#21547;&#25110;&#23548;&#20837;&#20854;&#20182;&#31867;&#22411;&#37197;&#32622;&#30340;&#33258;&#30001;&#12290;</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-initializers" href="#testcontext-ctx-management-initializers"></a>&#20351;&#29992;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#37197;&#32622;&#19978;&#19979;&#25991;</h5></div></div></div>

<p>&#20351;&#29992;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#20026;&#20320;&#30340;&#27979;&#35797;&#31867;&#37197;&#32622;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#65292;&#21487;&#20197;&#20351;&#29992;  <code class="literal">@ContextConfiguration</code>
&#27880;&#35299;&#20320;&#30340;&#27979;&#35797;&#31867;&#65292;&#28982;&#21518;&#20351;&#29992;&#19968;&#20010;&#25968;&#32452;&#37197;&#32622;&#20854; <code class="literal">initializers</code> &#23646;&#24615;&#65292;&#35813;&#25968;&#32452;&#21253;&#21547;&#23454;&#29616;&#20102; <code class="literal">ApplicationContextInitializer</code>
&#30340;&#31867;&#30340;&#24341;&#29992;&#12290;  &#22768;&#26126;&#30340;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#20854;&#21518;&#23558;&#34987;&#29992;&#26469;&#21021;&#22987;&#21270;&#27979;&#35797;&#31867;&#30340; <code class="literal">ConfigurableApplicationContext</code> &#12290;&#27880;&#24847;&#65292;
&#27599;&#19968;&#20010;&#20855;&#20307;&#30340;&#22768;&#26126;&#30340;&#21021;&#22987;&#21270;&#22120;&#25903;&#25345;&#30340; <code class="literal">ConfigurableApplicationContext</code> &#31867;&#22411;&#24517;&#39035;&#19982;&#20351;&#29992; <code class="literal">SmartContextLoader</code>
&#21019;&#24314;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#31867;&#22411;&#20860;&#23481;&#12290;&#27492;&#22806;&#65292;&#21021;&#22987;&#21270;&#22120;&#34987;&#35843;&#29992;&#30340;&#39034;&#24207;&#20381;&#36182;&#20110;&#23427;&#20204;&#26159;&#21542;&#23454;&#29616;&#20102;Spring&#30340;
<code class="literal">Ordered</code> &#25509;&#21475;&#25110;&#21152;&#27880;&#20102;Spring&#30340; <code class="literal">@Order</code> &#27880;&#35299;&#25110;&#21152;&#27880;&#20102;&#26631;&#20934;&#30340; <code class="literal">@Priority</code> &#27880;&#35299;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext&#23558;&#20174;&#37197;&#32622;&#31867;TestConfig&#21152;&#36733;&#24182;&#20174;TestAppCtxInitializer&#21021;&#22987;&#21270;</span>
<span class="strong"><strong>@ContextConfiguration(
    classes = TestConfig.class,
    initializers = TestAppCtxInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">//&#31867;&#20307;...</span>
}</pre>

<p>&#23436;&#20840;&#22320;&#24573;&#30053;XML&#37197;&#32622;&#25110;&#27880;&#35299;&#31867; <code class="literal">@ContextConfiguration</code> &#26041;&#24335;&#30340;&#22768;&#26126;&#20063;&#25104;&#20026;&#20102;&#21487;&#33021;&#65292;&#21462;&#32780;&#20195;&#20043;&#30340;&#26159;&#20165;&#20165;&#22768;&#26126;&#22312;&#19978;
&#19979;&#25991;&#20013;&#36127;&#36131;&#27880;&#20876;beans&#30340;&#31867; <code class="literal">ApplicationContextInitializer</code> &#8212;&#8212; &#20363;&#22914;&#65292;&#20174;XML&#25991;&#20214;&#25110;&#37197;&#32622;&#31867;&#20013;&#20197;&#32534;&#31243;&#26041;&#24335;
&#21152;&#36733;bean&#23450;&#20041;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext &#23558;&#34987;EntireAppInitializer&#21021;&#22987;&#21270;&#65292;&#20551;&#23450;EntireAppInitializer&#31867;&#22312;&#19978;&#19979;&#25991;&#20013;&#27880;&#20876;beans</span>
<span class="strong"><strong>@ContextConfiguration(initializers = EntireAppInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-inheritance" href="#testcontext-ctx-management-inheritance"></a>&#19978;&#19979;&#25991;&#37197;&#32622;&#32487;&#25215;</h5></div></div></div>

<p>&#27880;&#35299; <code class="literal">@ContextConfiguration</code> &#25903;&#25345;&#20004;&#20010;&#24067;&#23572;&#23646;&#24615;  <code class="literal">inheritLocations</code> &#21644; <code class="literal">inheritInitializers</code>&#65292;&#36825;&#20004;&#20010;&#23646;&#24615;
&#25351;&#30340;&#26159;&#22312;&#28526;&#31867;&#20013;&#22768;&#26126;&#30340;&#36164;&#28304;&#20301;&#32622;&#12289;&#27880;&#35299;&#31867;&#25110;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#26159;&#21542;&#21487;&#20197; <span class="emphasis"><em>&#32487;&#25215;</em></span> &#12290;&#23427;&#20204;&#20004;&#20010;&#30340;&#40664;&#35748;&#20540;&#37117;&#26159; <code class="literal">true</code>&#12290;&#37027;&#24847;&#21619;&#30528;&#19968;&#20010;&#27979;&#35797;
&#31867;&#40664;&#35748;&#20250;&#32487;&#25215;&#36229;&#31867;&#30340;&#36164;&#28304;&#20301;&#32622;&#12289;&#27880;&#35299;&#31867;&#25110;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#30340;&#37197;&#32622;&#12290;&#30830;&#20999;&#22320;&#35828;&#65292;&#19968;&#20010;&#27979;&#35797;&#31867;&#36164;&#28304;&#20301;&#32622;&#25110;&#32773;&#26159;&#27880;&#35299;&#31867;&#37197;&#32622;&#34987;&#36861;&#21152;&#21040;&#36229;&#31867;&#22768;&#26126;
&#30340;&#36164;&#28304;&#20301;&#32622;&#25110;&#27880;&#35299;&#31867;&#30340;&#21015;&#34920;&#19978;&#12290;&#31867;&#20284;&#22320;&#65292;&#25351;&#23450;&#27979;&#35797;&#31867;&#30340;&#21021;&#22987;&#21270;&#22120;&#23558;&#20250;&#22686;&#21152;&#21040;&#36229;&#31867;&#23450;&#20041;&#30340;&#21021;&#22987;&#21270;&#38598;&#21512;&#19978;&#12290;&#22240;&#27492;&#65292;&#23376;&#31867;&#25317;&#26377; <span class="emphasis"><em>&#32487;&#25215;</em></span> &#36164;&#28304;
&#20301;&#32622;&#12289;&#27880;&#35299;&#31867;&#25110;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#30340;&#36873;&#39033;&#12290;</p>
<p>&#22914;&#20309; <code class="literal">@ContextConfiguration</code>' &#30340; <code class="literal">inheritLocations</code> &#25110; <code class="literal">inheritInitializers</code> &#23646;&#24615;&#35774;&#32622;&#20026; <code class="literal">false</code> ,
&#27979;&#35797;&#31867;&#30340;&#36164;&#28304;&#20301;&#32622;&#12289;&#27880;&#35299;&#31867;&#25110;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#37197;&#32622;&#23558;&#20250;&#26367;&#20195;&#36229;&#31867;&#30340;&#37197;&#32622;&#12290;</p>
<p>&#22312;&#19979;&#36848;&#30340;&#20351;&#29992;XML&#36164;&#28304;&#20301;&#32622;&#30340;&#31034;&#20363;&#20013;&#65292;&#27979;&#35797;&#31867; <code class="literal">ExtendedTest</code> &#30340;&#24212;&#29992;&#19978;&#19979;&#25991;  <code class="literal">ApplicationContext</code> &#23558;&#20381;&#24207;&#20174;
<span class="emphasis"><em>"base-config.xml"</em></span> &#21644; <span class="emphasis"><em>"extended-config.xml"</em></span> &#20004;&#20010;&#37197;&#32622;&#25991;&#20214;&#20013;&#21152;&#36733;&#12290; &#22312; <span class="emphasis"><em>"extended-config.xml"</em></span>
&#37197;&#32622;&#25991;&#20214;&#20013;&#23450;&#20041;&#30340;beans&#23558;&#20250; <span class="emphasis"><em>&#35206;&#30422;</em></span> &#65288;&#20363;&#22914;&#65292;&#26367;&#25442;&#65289;&#22312; <span class="emphasis"><em>"base-config.xml"</em></span> &#37197;&#32622;&#25991;&#20214;&#20013;&#23450;&#20041;&#30340;beans&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext&#23558;&#20174;&#31867;&#36335;&#24452;&#26681;&#19979;&#30340;&#37197;&#32622;&#25991;&#20214;"/base-config.xml"&#20013;&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration("/base-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}

<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext&#23558;&#20174;&#31867;&#36335;&#24452;&#26681;&#19979;&#30340;&#37197;&#32622;&#25991;&#20214; "/base-config.xml"&#21644;"/extended-config.xml"&#20013;&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration("/extended-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#31867;&#20284;&#30340;&#65292;&#22312;&#19979;&#36848;&#20351;&#29992;&#27880;&#35299;&#31867;&#30340;&#31034;&#20363;&#20013;&#65292;<code class="literal">ExtendedTest</code> &#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23558;&#20250;&#20174; <code class="literal">BaseConfig</code> <span class="emphasis"><em>&#21644;</em></span>
<code class="literal">ExtendedConfig</code> &#20004;&#20010;&#37197;&#32622;&#31867;&#20013;&#21152;&#36733;&#12290;&#22312;&#37197;&#32622;&#31867; <code class="literal">ExtendedConfig</code> &#20013;&#23450;&#20041;&#30340;beans&#22240;&#27492;&#23558;&#20250;&#35206;&#30422;&#22312; <code class="literal">BaseConfig</code> &#37197;&#32622;&#31867;&#20013;
&#23450;&#20041;&#30340;beans&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext&#23558;&#20174;&#37197;&#32622;&#31867;BaseConfig&#20013;&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration(classes = BaseConfig.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}

<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext&#23558;&#20174;&#37197;&#32622;&#31867;BaseConfig &#21644; ExtendedConfig&#20013;&#21152;&#36733;</span>
<span class="strong"><strong>@ContextConfiguration(classes = ExtendedConfig.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

<p>&#22312;&#19979;&#36848;&#20351;&#29992;&#19978;&#19979;&#25991;&#21021;&#22987;&#21270;&#22120;&#30340;&#31034;&#20363;&#20013;&#65292;&#27979;&#35797;&#31867; <code class="literal">ExtendedTest</code> &#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23558;&#20351;&#29992;&#21021;&#22987;&#21270;&#22120;
<code class="literal">BaseInitializer</code> <span class="emphasis"><em>&#21644;</em></span> <code class="literal">ExtendedInitializer</code> &#36827;&#34892;&#21021;&#22987;&#21270;&#12290; &#27880;&#24847;&#65292;&#23613;&#31649;&#22914;&#27492;&#65292;&#21021;&#22987;&#21270;&#22120;&#30340;&#35843;&#29992;&#39034;&#24207;&#20381;&#36182;&#20110;&#23427;&#20204;
&#26159;&#21542;&#23454;&#29616;&#20102;Spring&#30340; <code class="literal">Ordered</code> &#25509;&#21475;&#65292;&#21152;&#27880; <code class="literal">@Order</code> &#27880;&#35299;&#25110;&#26159;&#26631;&#20934;&#30340; <code class="literal">@Priority</code> &#27880;&#35299;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext &#23558;&#36890;&#36807;&#21021;&#22987;&#21270;&#22120;BaseInitializer&#36827;&#34892;&#21021;&#22987;&#21270;</span>
<span class="strong"><strong>@ContextConfiguration(initializers = BaseInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}

<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991;ApplicationContext &#23558;&#36890;&#36807;BaseInitializer&#21644;ExtendedInitializer&#36827;&#34892;&#21021;&#22987;&#21270;</span>
<span class="strong"><strong>@ContextConfiguration(initializers = ExtendedInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// &#31867;&#20307;...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-env-profiles" href="#testcontext-ctx-management-env-profiles"></a>&#20351;&#29992;&#29615;&#22659;&#27010;&#35201;&#36827;&#34892;&#19978;&#19979;&#25991;&#37197;&#32622;</h5></div></div></div>

<p>&#22312;Spring 3.1&#23545;&#29615;&#22659;&#21644;&#27010;&#35201;&#65288;&#20063;&#31216;&#20026; <span class="emphasis"><em>bean &#23450;&#20041;&#27010;&#35201;</em></span>&#65289;&#30340;&#31526;&#21495;&#34920;&#31034;&#27861;&#24341;&#20837;&#20102;&#20248;&#31168;&#30340;&#25903;&#25345;&#65292;&#38598;&#25104;&#27979;&#35797;&#21487;&#20197;
&#20026;&#21508;&#31181;&#19981;&#21516;&#30340;&#27979;&#35797;&#22330;&#26223;&#37197;&#32622;&#20026;&#21487;&#20197;&#28608;&#27963;&#29305;&#23450;&#30340;bean &#23450;&#20041;&#27010;&#35201;&#12290;&#36825;&#20123;&#21487;&#20197;&#36890;&#36807;&#22312;&#27979;&#35797;&#31867;&#19978;&#22686;&#21152; <code class="literal">@ActiveProfiles</code>
&#27880;&#35299;&#24182;&#20026;&#20043;&#25552;&#20379;&#19968;&#20010;&#27010;&#35201;&#30340;&#21015;&#34920;&#65292;&#36825;&#20010;&#27010;&#35201;&#21015;&#34920;&#23558;&#22312;&#20026;&#27979;&#35797;&#31867;&#21152;&#36733;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#30340;&#26102;&#20505;&#34987;
&#28608;&#27963;&#12290;</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>&#27880;&#35299; <code class="literal">@ActiveProfiles</code> &#21487;&#20197;&#34987;&#29992;&#26469;&#19982;&#20219;&#20309;&#26032;&#30340;&#26234;&#33021;&#19978;&#19979;&#25991;&#21152;&#36733;&#22120;  <code class="literal">SmartContextLoader</code> SPI&#30340;&#23454;&#29616;&#37197;&#21512;
&#20351;&#29992;&#65292;&#20294;&#26159;&#21364;&#19981;&#25903;&#25345;&#26087;&#30340;&#19978;&#19979;&#25991;&#21152;&#36733;&#22120; <code class="literal">ContextLoader</code> SPI &#30340;&#23454;&#29616;&#12290;</p>
</td></tr></table></div>

<p>&#35753;&#25105;&#20204;&#30475;&#19968;&#20123;&#22522;&#20110;XML&#37197;&#32622;&#21644;&#22522;&#20110;&#37197;&#32622;&#31867;&#27880;&#35299;<code class="literal">@Configuration</code>&#30340;&#31034;&#20363;&#12290;</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- app-config.xml --&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:jdbc</span>=<span class="hl-value">"http://www.springframework.org/schema/jdbc"</span>
    <span class="hl-attribute">xmlns:jee</span>=<span class="hl-value">"http://www.springframework.org/schema/jee"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transferService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.service.internal.DefaultTransferService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountRepository"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"feePolicy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountRepository"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.repository.internal.JdbcAccountRepository"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"feePolicy"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.service.internal.ZeroFeePolicy"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"dev"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/schema.sql"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/test-data.sql"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"production"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/datasource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"default"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/schema.sql"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// &#24212;&#29992;&#19978;&#19979;&#25991; ApplicationContext &#23558;&#20174;&#37197;&#32622;&#25991;&#20214; "classpath:/app-config.xml" &#20013;&#21152;&#36733;</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("/app-config.xml")</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> TransferService transferService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p>&#24403;&#27979;&#35797;&#31867; <code class="literal">TransferServiceTest</code> &#36816;&#34892;&#30340;&#26102;&#20505;&#65292;&#23427;&#30340;&#24212;&#29992;&#19978;&#19979;&#25991; <code class="literal">ApplicationContext</code> &#23558;&#20174;&#31867;&#36335;&#24452;&#26681;&#19979;&#30340;
&#37197;&#32622;&#25991;&#20214; <code class="literal">app-config.xml</code> &#20013;&#21152;&#36733;&#12290;&#22914;&#26524;&#26816;&#26597;&#37197;&#32622;&#25991;&#20214;&#65292;&#20320;&#20250;&#27880;&#24847;&#21040;bean <code class="literal">accountRepository</code> &#20381;&#36182;bean
<code class="literal">dataSource</code> ;&#23613;&#31649;&#22914;&#27492;&#65292;<code class="literal">dataSource</code> bean&#24182;&#27809;&#26377;&#34987;&#23450;&#20041;&#20026;&#19968;&#20010;&#39030;&#23618;&#30340;bean&#12290;&#30456;&#21453;&#65292;&#23427;&#34987;&#23450;&#20041;&#20102;&#19977;&#27425;&#65306;&#20998;&#21035;
&#22312; <span class="emphasis"><em>product</em></span> &#27010;&#35201;&#65292;<span class="emphasis"><em>dev</em></span> &#27010;&#35201;&#65292;&#20197;&#21450; <span class="emphasis"><em>default</em></span> &#27010;&#35201;&#20013;&#12290;</p>
<p>&#36890;&#36807;&#20351;&#29992; <code class="literal">@ActiveProfiles("dev")</code> &#27880;&#35299;&#27979;&#35797;&#31867; <code class="literal">TransferServiceTest</code> &#65292;&#25105;&#20204;&#25552;&#31034;Spring &#27979;&#35797;&#26694;&#26550;
&#20351;&#29992;&#28608;&#27963;&#30340;&#27010;&#35201; <code class="literal">{"dev"}</code> &#26469;&#21152;&#36733;&#24212;&#29992;&#19978;&#19979;&#25991;  <code class="literal">ApplicationContext</code> &#12290; &#20110;&#26159;&#65292;&#19968;&#20010;&#23884;&#20837;&#24335;&#25968;&#25454;&#24211;&#23558;&#34987;&#21019;&#24314;
&#24182;&#23384;&#20648;&#27979;&#35797;&#25968;&#25454;&#65292;&#24182;&#19988; <code class="literal">accountRepository</code> bean&#23558;&#27880;&#20837;&#19968;&#20010;&#24320;&#21457;&#30340; <code class="literal">DataSource</code>&#12290;&#36825;&#20063;&#26159;&#25105;&#20204;&#24819;&#22312;&#38598;&#25104;
&#27979;&#35797;&#20013;&#24076;&#26395;&#30340;&#12290;</p>
<p>&#23558;bean&#20998;&#37197;&#32473; <code class="literal">default</code> &#30340;&#27010;&#35201;&#26377;&#26102;&#20505;&#26159;&#24456;&#26377;&#29992;&#30340;&#12290;&#40664;&#35748;&#27010;&#35201;&#20013;&#30340;bean&#20165;&#24403;&#27809;&#26377;&#20854;&#20182;&#30340;&#27010;&#35201;&#34987;&#28608;&#27963;&#26102;&#20351;&#29992;&#12290;&#36825;&#21487;&#20197;&#34987;
&#29992;&#26469;&#23450;&#20041;&#19968;&#20010; <span class="emphasis"><em>fallback</em></span> bean&#65292;&#35813;bean&#34987;&#29992;&#20110;&#24212;&#29992;&#30340;&#40664;&#35748;&#29366;&#24577;&#12290;&#20363;&#22914;&#65292;&#20320;&#21487;&#20197;&#26174;&#24335;&#22320;&#25552;&#20379;&#19968;&#20010; <code class="literal">dev</code> &#27010;&#35201;&#21644;&#19968;&#20010;
<code class="literal">product</code> &#27010;&#35201;&#65292;&#20294;&#26159;&#24403;&#36825;&#20004;&#20010;&#37117;&#27809;&#26377;&#28608;&#27963;&#30340;&#24773;&#20917;&#19979;&#65292;&#20320;&#21487;&#20197;&#23450;&#20041;&#19968;&#20010;&#20869;&#23384;&#25968;&#25454;&#28304;&#20316;&#20026;&#40664;&#35748;&#20540;&#12290;</p>
<p>&#19979;&#36848;&#30340;&#31034;&#20363;&#20195;&#30721;&#28436;&#31034;&#20102;&#22914;&#20309;&#20351;&#29992; <code class="literal">@Configuration</code> &#31867;&#26469;&#23454;&#29616;&#19982;XML&#30456;&#21516;&#30340;&#37197;&#32622;&#12290;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> StandaloneDataConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/schema.sql"</span>)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/test-data.sql"</span>)
            .build();
    }
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("production")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JndiDataConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> DataSource dataSource() <span class="hl-keyword">throws</span> Exception {
        Context ctx = <span class="hl-keyword">new</span> InitialContext();
        <span class="hl-keyword">return</span> (DataSource) ctx.lookup(<span class="hl-string">"java:comp/env/jdbc/datasource"</span>);
    }
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("default")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultDataConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/schema.sql"</span>)
            .build();
    }
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceConfig {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> DataSource dataSource;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultTransferService(accountRepository(), feePolicy());
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AccountRepository accountRepository() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcAccountRepository(dataSource);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FeePolicy feePolicy() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ZeroFeePolicy();
    }

}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = {
        TransferServiceConfig.class,
        StandaloneDataConfig.class,
        JndiDataConfig.class,
        DefaultDataConfig.class})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> TransferService transferService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// &#27979;&#35797;&#30456;&#20851;&#36923;&#36753;</span>
    }
}</pre>

<p>&#36825;&#27425;&#30340;&#21464;&#21270;&#65292;&#25105;&#20204;&#23558;XML&#37197;&#32622;&#25286;&#20998;&#25104;&#20102;&#22235;&#20010;&#29420;&#31435;&#27880;&#35299;&#20102; <code class="literal">@Configuration</code> &#30340;&#37197;&#32622;&#31867;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TransferServiceConfig</code>: &#36890;&#36807;&#20351;&#29992;&#27880;&#35299; <code class="literal">@Autowired</code> &#20381;&#36182;&#27880;&#20837;&#33719;&#21462;&#19968;&#20010;&#25968;&#25454;&#28304; <code class="literal">dataSource</code>
</li><li class="listitem">
<code class="literal">StandaloneDataConfig</code>: &#23450;&#20041;&#20102;&#19968;&#20010;&#36866;&#21512;&#20110;&#24320;&#21457;&#20154;&#21592;&#27979;&#35797;&#30340;&#23884;&#20837;&#24335;&#25968;&#25454;&#24211;&#30340;&#25968;&#25454;&#28304; <code class="literal">dataSource</code>
</li><li class="listitem">
<code class="literal">JndiDataConfig</code>: &#23450;&#20041;&#19968;&#20010;&#20174;JNDI&#20135;&#21697;&#29615;&#22659;&#20013;&#33719;&#24471;&#25968;&#25454;&#28304; <code class="literal">dataSource</code>
</li><li class="listitem">
<code class="literal">DefaultDataConfig</code>: &#20026;&#38450;&#27490;&#27809;&#26377;&#28608;&#27963;&#30340;&#27010;&#35201;&#37197;&#32622;&#65292;&#22312;&#19968;&#20010;&#40664;&#35748;&#30340;&#23884;&#20837;&#24335;&#25968;&#25454;&#24211;&#20013;&#23450;&#20041;&#19968;&#20010;&#25968;&#25454;&#28304; <code class="literal">dataSource</code>
</li></ul></div>

<p>&#22312;&#20351;&#29992;&#22522;&#20110;XML&#30340;&#37197;&#32622;&#31034;&#20363;&#20013;&#65292; &#25105;&#20204;&#20173;&#28982;&#20351;&#29992; <code class="literal">@ActiveProfiles("dev")</code> &#27880;&#35299;&#27979;&#35797;&#31867; <code class="literal">TransferServiceTest</code> &#65292;
&#20294;&#26159;&#36825;&#27425;&#25105;&#20204;&#36890;&#36807;&#27880;&#35299; <code class="literal">@ContextConfiguration</code>&#25351;&#23450;&#20102;&#25152;&#26377;&#30340;&#22235;&#20010;&#37197;&#32622;&#31867;&#12290;&#27979;&#35797;&#31867;&#30340;&#26412;&#36523;&#27809;&#26377;&#21457;&#29983;&#20219;&#20309;&#25913;&#21464;&#12290;</p>
<p>&#36890;&#24120;&#30340;&#29992;&#20363;&#26159;&#22312;&#19968;&#20010;&#39033;&#30446;&#20013;&#36328;&#36234;&#22810;&#20010;&#27979;&#35797;&#31867;&#20351;&#29992;&#19968;&#32452;&#27010;&#35201;&#37197;&#32622;&#12290;&#22240;&#27492;&#65292;&#20026;&#20102;&#36991;&#20813;&#27880;&#35299; <code class="literal">@ActiveProfiles</code> &#30340;
&#37325;&#22797;&#22768;&#26126;&#65292;&#21487;&#20197;&#22312;&#19968;&#20010;&#22522;&#31867;&#19978;&#21482;&#22768;&#26126;&#19968;&#27425;&#27880;&#35299; <code class="literal">@ActiveProfiles</code>&#65292; &#20854;&#23376;&#31867;&#23558;&#33258;&#21160;&#30340;&#32487;&#25215;&#29238;&#31867;&#30340;&#27880;&#35299;&#37197;&#32622;&#12290;&#22312;&#19979;&#21015;
&#30340;&#31034;&#20363;&#20013;&#65292;&#27880;&#35299; <code class="literal">@ActiveProfiles</code> &#30340;&#22768;&#26126;&#34987;&#31227;&#20837;&#20102;&#25277;&#35937;&#36229;&#31867;  <code class="literal">AbstractIntegrationTest</code> &#20013;&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = {
        TransferServiceConfig.class,
        StandaloneDataConfig.class,
        JndiDataConfig.class,
        DefaultDataConfig.class})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractIntegrationTest {
}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" &#27010;&#35201;&#20174;&#36229;&#31867;&#20013;&#32487;&#25215;</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> TransferService transferService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// &#27979;&#35797;&#36923;&#36753;</span>
    }
}</pre>

<p>&#27880;&#35299; <code class="literal">@ActiveProfiles</code> &#20063;&#25903;&#25345;&#19968;&#20010; <code class="literal">inheritProfiles</code> &#23646;&#24615;&#65292;&#35813;&#23646;&#24615;&#21487;&#20197;&#29992;&#26469;&#31105;&#27490;&#28608;&#27963;&#27010;&#35201;&#30340;&#32487;&#25215;&#29305;&#24615;&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" &#27010;&#35201;&#34987; "production" &#27010;&#35201;&#35206;&#30422;</span>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles(profiles = "production", inheritProfiles = false)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductionTransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {
    <span class="hl-comment">// &#27979;&#35797;&#20307;</span>
}</pre>

<p><a name="testcontext-ctx-management-env-profiles-ActiveProfilesResolver" href="#testcontext-ctx-management-env-profiles-ActiveProfilesResolver"></a>&#27492;&#22806;&#65292;&#26377;&#20123;&#26102;&#20505;&#20026;&#27979;&#35797;&#31867;&#37319;&#29992; <span class="emphasis"><em>&#21487;&#32534;&#31243;</em></span> &#30340;&#26041;&#24335;&#32780;&#38750;&#22768;&#26126;&#30340;&#26041;&#24335;&#35299;&#26512;&#28608;&#27963;&#30340;&#27010;&#35201;&#26159;&#24517;&#35201;&#30340; &#8212;&#8212; &#20363;&#22914;&#65292; &#22522;&#20110;&#65306;</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
&#24403;&#21069;&#30340;&#25805;&#20316;&#31995;&#32479;
</li><li class="listitem">
&#26159;&#21542;&#22312;&#25345;&#32493;&#38598;&#25104;&#26500;&#24314;&#26381;&#21153;&#22120;&#19978;&#34987;&#25191;&#34892;
</li><li class="listitem">
&#23384;&#22312;&#29305;&#23450;&#30340;&#29615;&#22659;&#21464;&#37327;
</li><li class="listitem">
&#23384;&#22312;&#29992;&#25143;&#23450;&#20041;&#30340;&#31867;&#32423;&#21035;&#30340;&#27880;&#35299;
</li><li class="listitem">
&#31561;&#31561;&#12290;
</li></ul></div>

<p>&#20026;&#20102;&#21487;&#32534;&#31243;&#22320;&#35299;&#26512;&#27963;&#21160;bean&#23450;&#20041;&#27010;&#35201;&#65292;&#31616;&#21333;&#22320;&#23454;&#29616;&#19968;&#20010;&#33258;&#23450;&#20041;&#30340;&#27963;&#21160;&#27010;&#35201;&#35299;&#26512;&#22120; <code class="literal">ActiveProfilesResolver</code> &#24182;
&#36890;&#36807;&#27880;&#35299; <code class="literal">@ActiveProfiles</code> &#30340;&#23646;&#24615; <code class="literal">resolver</code> &#26469;&#27880;&#20876;&#19978;&#12290; &#19979;&#21015;&#30340;&#31034;&#20363;&#28436;&#31034;&#20102;&#22914;&#20309;&#23454;&#29616;&#19968;&#20010;&#29992;&#25143;&#33258;&#23450;&#20041;&#30340;
&#27963;&#21160;&#27010;&#35201;&#35299;&#26512;&#22120; <code class="literal">OperatingSystemActiveProfilesResolver</code> &#24182;&#27880;&#20876;&#20043;&#12290;&#24819;&#20102;&#35299;&#36827;&#19968;&#27493;&#30340;&#20449;&#24687;&#65292;&#21487;&#21442;&#32771;&#30456;&#20851;
&#30340;javadoc&#12290;</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// &#36890;&#36807;&#33258;&#23450;&#20041;&#30340;&#35299;&#26512;&#22120;&#20197;&#32534;&#31243;&#26041;&#24335;&#35206;&#30422; "dev" &#27010;&#35201;</span>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles(
    resolver = OperatingSystemActiveProfilesResolver.class,
    inheritProfiles = false)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {
    <span class="hl-comment">// &#27979;&#35797;&#20307;</span>
}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service.test;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OperatingSystemActiveProfilesResolver <span class="hl-keyword">implements</span> ActiveProfilesResolver {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    String[] resolve(Class&lt;?&gt; testClass) {
        String profile = ...;
        <span class="hl-comment">// &#22522;&#20110;&#25805;&#20316;&#31995;&#32479;&#20915;&#23450;&#27010;&#35201;&#30340;&#21462;&#20540;</span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] {profile};
    }
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-property-sources" href="#testcontext-ctx-management-property-sources"></a>&#27979;&#35797;&#23646;&#24615;&#28304;&#19978;&#19979;&#25991;&#37197;&#32622;</h5></div></div></div>

<p>Spring 3.1 introduced first-class support in the framework for the notion of an
environment with a hierarchy of <span class="emphasis"><em>property sources</em></span>, and since Spring 4.1 integration
tests can be configured with test-specific property sources. In contrast to the
<code class="literal">@PropertySource</code> annotation used on <code class="literal">@Configuration</code> classes, the <code class="literal">@TestPropertySource</code>
annotation can be declared on a test class to declare resource locations for test
properties files or <span class="emphasis"><em>inlined</em></span> properties. These test property sources will be added to
the <code class="literal">Environment</code>'s set of <code class="literal">PropertySources</code> for the <code class="literal">ApplicationContext</code> loaded for the
annotated integration test.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@TestPropertySource</code> may be used with any implementation of the <code class="literal">SmartContextLoader</code>
SPI, but <code class="literal">@TestPropertySource</code> is not supported with implementations of the older
<code class="literal">ContextLoader</code> SPI.</p>
<p>Implementations of <code class="literal">SmartContextLoader</code> gain access to merged test property source values
via the <code class="literal">getPropertySourceLocations()</code> and <code class="literal">getPropertySourceProperties()</code> methods in
<code class="literal">MergedContextConfiguration</code>.</p>
</td></tr></table></div>

<p><span class="strong"><strong>Declaring test property sources</strong></span></p>
<p>Test properties files can be configured via the <code class="literal">locations</code> or <code class="literal">value</code> attribute of
<code class="literal">@TestPropertySource</code> as shown in the following example.</p>
<p>Both traditional and XML-based properties file formats are supported&#8201;&#8212;&#8201;for example,
<code class="literal">"classpath:/com/example/test.properties"</code> or <code class="literal">"file:///path/to/file.xml"</code>.</p>
<p>Each path will be interpreted as a Spring <code class="literal">Resource</code>. A plain path&#8201;&#8212;&#8201;for example,
<code class="literal">"test.properties"</code>&#8201;&#8212;&#8201;will be treated as a classpath resource that is <span class="emphasis"><em>relative</em></span> to the
package in which the test class is defined. A path starting with a slash will be treated
as an <span class="emphasis"><em>absolute</em></span> classpath resource, for example: <code class="literal">"/org/example/test.xml"</code>. A path which
references a URL (e.g., a path prefixed with <code class="literal">classpath:</code>, <code class="literal">file:</code>, <code class="literal">http:</code>, etc.) will
be loaded using the specified resource protocol. Resource location wildcards (e.g.
<code class="literal">**/*.properties</code>) are not permitted: each location must evaluate to exactly one
<code class="literal">.properties</code> or <code class="literal">.xml</code> resource.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestPropertySource("/test.properties")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><span class="emphasis"><em>Inlined</em></span> properties in the form of key-value pairs can be configured via the
<code class="literal">properties</code> attribute of <code class="literal">@TestPropertySource</code> as shown in the following example. All
key-value pairs will be added to the enclosing <code class="literal">Environment</code> as a single test
<code class="literal">PropertySource</code> with the highest precedence.</p>
<p>The supported syntax for key-value pairs is the same as the syntax defined for entries in
a Java properties file:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">"key=value"</code>
</li><li class="listitem">
<code class="literal">"key:value"</code>
</li><li class="listitem">
<code class="literal">"key value"</code>
</li></ul></div>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestPropertySource(properties = {"timezone = GMT", "port: 4242"})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><span class="strong"><strong>Default properties file detection</strong></span></p>
<p>If <code class="literal">@TestPropertySource</code> is declared as an empty annotation (i.e., without explicit
values for the <code class="literal">locations</code> or <code class="literal">properties</code> attributes), an attempt will be made to detect
a <span class="emphasis"><em>default</em></span> properties file relative to the class that declared the annotation. For
example, if the annotated test class is <code class="literal">com.example.MyTest</code>, the corresponding default
properties file is <code class="literal">"classpath:com/example/MyTest.properties"</code>. If the default cannot be
detected, an <code class="literal">IllegalStateException</code> will be thrown.</p>
<p><span class="strong"><strong>Precedence</strong></span></p>
<p>Test property sources have higher precedence than those loaded from the operating
system&#8217;s environment or Java system properties as well as property sources added by the
application declaratively via <code class="literal">@PropertySource</code> or programmatically. Thus, test property
sources can be used to selectively override properties defined in system and application
property sources. Furthermore, inlined properties have higher precedence than properties
loaded from resource locations.</p>
<p>In the following example, the <code class="literal">timezone</code> and <code class="literal">port</code> properties as well as any properties
defined in <code class="literal">"/test.properties"</code> will override any properties of the same name that are
defined in system and application property sources. Furthermore, if the
<code class="literal">"/test.properties"</code> file defines entries for the <code class="literal">timezone</code> and <code class="literal">port</code> properties those
will be overridden by the <span class="emphasis"><em>inlined</em></span> properties declared via the <code class="literal">properties</code> attribute.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestPropertySource(
    locations = "/test.properties",
    properties = {"timezone = GMT", "port: 4242"}
)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><span class="strong"><strong>Inheriting and overriding test property sources</strong></span></p>
<p><code class="literal">@TestPropertySource</code> supports boolean <code class="literal">inheritLocations</code> and <code class="literal">inheritProperties</code>
attributes that denote whether resource locations for properties files and inlined
properties declared by superclasses should be <span class="emphasis"><em>inherited</em></span>. The default value for both
flags is <code class="literal">true</code>. This means that a test class inherits the locations and inlined
properties declared by any superclasses. Specifically, the locations and inlined
properties for a test class are appended to the locations and inlined properties declared
by superclasses. Thus, subclasses have the option of <span class="emphasis"><em>extending</em></span> the locations and
inlined properties. Note that properties that appear later will <span class="emphasis"><em>shadow</em></span> (i.e..,
override) properties of the same name that appear earlier. In addition, the
aforementioned precedence rules apply for inherited test property sources as well.</p>
<p>If <code class="literal">@TestPropertySource</code>'s <code class="literal">inheritLocations</code> or <code class="literal">inheritProperties</code> attribute is set to
<code class="literal">false</code>, the locations or inlined properties, respectively, for the test class <span class="emphasis"><em>shadow</em></span>
and effectively replace the configuration defined by superclasses.</p>
<p>In the following example, the <code class="literal">ApplicationContext</code> for <code class="literal">BaseTest</code> will be loaded using
only the <code class="literal">"base.properties"</code> file as a test property source. In contrast, the
<code class="literal">ApplicationContext</code> for <code class="literal">ExtendedTest</code> will be loaded using the <code class="literal">"base.properties"</code>
<span class="strong"><strong>and</strong></span> <code class="literal">"extended.properties"</code> files as test property source locations.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@TestPropertySource("base.properties")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// ...</span>
}

<em><span class="hl-annotation" style="color: gray">@TestPropertySource("extended.properties")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// ...</span>
}</pre>

<p>In the following example, the <code class="literal">ApplicationContext</code> for <code class="literal">BaseTest</code> will be loaded using only
the <span class="emphasis"><em>inlined</em></span> <code class="literal">key1</code> property. In contrast, the <code class="literal">ApplicationContext</code> for <code class="literal">ExtendedTest</code> will be
loaded using the <span class="emphasis"><em>inlined</em></span> <code class="literal">key1</code> and <code class="literal">key2</code> properties.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@TestPropertySource(properties = "key1 = value1")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// ...</span>
}

<em><span class="hl-annotation" style="color: gray">@TestPropertySource(properties = "key2 = value2")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// ...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-web" href="#testcontext-ctx-management-web"></a>Loading a WebApplicationContext</h5></div></div></div>

<p>Spring 3.2 introduced support for loading a <code class="literal">WebApplicationContext</code> in integration
tests. To instruct the TestContext framework to load a <code class="literal">WebApplicationContext</code> instead
of a standard <code class="literal">ApplicationContext</code>, simply annotate the respective test class with
<code class="literal">@WebAppConfiguration</code>.</p>
<p>The presence of <code class="literal">@WebAppConfiguration</code> on your test class instructs the TestContext
framework (TCF) that a <code class="literal">WebApplicationContext</code> (WAC) should be loaded for your
integration tests. In the background the TCF makes sure that a <code class="literal">MockServletContext</code> is
created and supplied to your test&#8217;s WAC. By default the base resource path for your
<code class="literal">MockServletContext</code> will be set to <span class="emphasis"><em>"src/main/webapp"</em></span>. This is interpreted as a path
relative to the root of your JVM (i.e., normally the path to your project). If you&#8217;re
familiar with the directory structure of a web application in a Maven project, you&#8217;ll
know that <span class="emphasis"><em>"src/main/webapp"</em></span> is the default location for the root of your WAR. If you
need to override this default, simply provide an alternate path to the
<code class="literal">@WebAppConfiguration</code> annotation (e.g., <code class="literal">@WebAppConfiguration("src/test/webapp")</code>). If
you wish to reference a base resource path from the classpath instead of the file
system, just use Spring&#8217;s <span class="emphasis"><em>classpath:</em></span> prefix.</p>
<p>Please note that Spring&#8217;s testing support for <code class="literal">WebApplicationContexts</code> is on par with
its support for standard <code class="literal">ApplicationContexts</code>. When testing with a
<code class="literal">WebApplicationContext</code> you are free to declare either XML configuration files or
<code class="literal">@Configuration</code> classes via <code class="literal">@ContextConfiguration</code>. You are of course also free to use
any other test annotations such as <code class="literal">@TestExecutionListeners</code>,
<code class="literal">@TransactionConfiguration</code>, <code class="literal">@ActiveProfiles</code>, etc.</p>
<p>The following examples demonstrate some of the various configuration options for loading
a <code class="literal">WebApplicationContext</code>.</p>
<p>
<b>Conventions.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>

<span class="hl-comment">// defaults to "file:src/main/webapp"</span>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>

<span class="hl-comment">// detects "WacTests-context.xml" in same package</span>
<span class="hl-comment">// or static nested @Configuration class</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p>

</p>

<p>The above example demonstrates the TestContext framework&#8217;s support for <span class="emphasis"><em>convention over
configuration</em></span>. If you annotate a test class with <code class="literal">@WebAppConfiguration</code> without
specifying a resource base path, the resource path will effectively default
to <span class="emphasis"><em>"file:src/main/webapp"</em></span>. Similarly, if you declare <code class="literal">@ContextConfiguration</code> without
specifying resource <code class="literal">locations</code>, annotated <code class="literal">classes</code>, or context <code class="literal">initializers</code>, Spring
will attempt to detect the presence of your configuration using conventions
(i.e., <span class="emphasis"><em>"WacTests-context.xml"</em></span> in the same package as the <code class="literal">WacTests</code> class or static
nested <code class="literal">@Configuration</code> classes).</p>
<p>
<b>Default resource semantics.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>

<span class="hl-comment">// file system resource</span>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration("webapp")</span></em>

<span class="hl-comment">// classpath resource</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/test-servlet-config.xml")</span></em>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p>

</p>

<p>This example demonstrates how to explicitly declare a resource base path with
<code class="literal">@WebAppConfiguration</code> and an XML resource location with <code class="literal">@ContextConfiguration</code>. The
important thing to note here is the different semantics for paths with these two
annotations. By default, <code class="literal">@WebAppConfiguration</code> resource paths are file system based;
whereas, <code class="literal">@ContextConfiguration</code> resource locations are classpath based.</p>
<p>
<b>Explicit resource semantics.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>

<span class="hl-comment">// classpath resource</span>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration("classpath:test-web-resources")</span></em>

<span class="hl-comment">// file system resource</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("file:src/main/webapp/WEB-INF/servlet-config.xml")</span></em>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p>

</p>

<p>In this third example, we see that we can override the default resource semantics for
both annotations by specifying a Spring resource prefix. Contrast the comments in this
example with the previous example.</p>
<p>To provide comprehensive web testing support, Spring 3.2 introduced a
<code class="literal">ServletTestExecutionListener</code> that is enabled by default. When testing against a
<code class="literal">WebApplicationContext</code> this <a class="link" href="aop-api.html#testcontext-key-abstractions" title="&#26680;&#24515;&#27010;&#36848;">TestExecutionListener</a> sets
up default thread-local state via Spring Web&#8217;s <code class="literal">RequestContextHolder</code> before each test
method and creates a <code class="literal">MockHttpServletRequest</code>, <code class="literal">MockHttpServletResponse</code>, and
<code class="literal">ServletWebRequest</code> based on the base resource path configured via
<code class="literal">@WebAppConfiguration</code>. <code class="literal">ServletTestExecutionListener</code> also ensures that the
<code class="literal">MockHttpServletResponse</code> and <code class="literal">ServletWebRequest</code> can be injected into the test
instance, and once the test is complete it cleans up thread-local state.</p>
<p>Once you have a <code class="literal">WebApplicationContext</code> loaded for your test you might find that you
need to interact with the web mocks&#8201;&#8212;&#8201;for example, to set up your test fixture or to
perform assertions after invoking your web component. The following example demonstrates
which mocks can be autowired into your test instance. Note that the
<code class="literal">WebApplicationContext</code> and <code class="literal">MockServletContext</code> are both cached across the test suite;
whereas, the other mocks are managed per test method by the
<code class="literal">ServletTestExecutionListener</code>.</p>
<p>
<b>Injecting mocks.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    WebApplicationContext wac; <span class="hl-comment">// cached</span>

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockServletContext servletContext; <span class="hl-comment">// cached</span>

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockHttpSession session;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockHttpServletRequest request;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockHttpServletResponse response;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    ServletWebRequest webRequest;

    <span class="hl-comment">//...</span>
}</pre><p>

</p>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-caching" href="#testcontext-ctx-management-caching"></a>Context caching</h5></div></div></div>

<p>Once the TestContext framework loads an <code class="literal">ApplicationContext</code> (or <code class="literal">WebApplicationContext</code>)
for a test, that context will be cached and reused for <span class="emphasis"><em>all</em></span> subsequent tests that
declare the same unique context configuration within the same test suite. To understand
how caching works, it is important to understand what is meant by <span class="emphasis"><em>unique</em></span> and <span class="emphasis"><em>test
suite</em></span>.</p>
<p>An <code class="literal">ApplicationContext</code> can be <span class="emphasis"><em>uniquely</em></span> identified by the combination of
configuration parameters that are used to load it. Consequently, the unique combination
of configuration parameters are used to generate a <span class="emphasis"><em>key</em></span> under which the context is
cached. The TestContext framework uses the following configuration parameters to build
the context cache key:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">locations</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">classes</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">contextInitializerClasses</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">contextLoader</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">parent</code> <span class="emphasis"><em>(from @ContextHierarchy)</em></span>
</li><li class="listitem">
<code class="literal">activeProfiles</code> <span class="emphasis"><em>(from @ActiveProfiles)</em></span>
</li><li class="listitem">
<code class="literal">propertySourceLocations</code> <span class="emphasis"><em>(from @TestPropertySource)</em></span>
</li><li class="listitem">
<code class="literal">propertySourceProperties</code> <span class="emphasis"><em>(from @TestPropertySource)</em></span>
</li><li class="listitem">
<code class="literal">resourceBasePath</code> <span class="emphasis"><em>(from @WebAppConfiguration)</em></span>
</li></ul></div>

<p>For example, if <code class="literal">TestClassA</code> specifies <code class="literal">{"app-config.xml", "test-config.xml"}</code> for the
<code class="literal">locations</code> (or <code class="literal">value</code>) attribute of <code class="literal">@ContextConfiguration</code>, the TestContext framework
will load the corresponding <code class="literal">ApplicationContext</code> and store it in a <code class="literal">static</code> context cache
under a key that is based solely on those locations. So if <code class="literal">TestClassB</code> also defines
<code class="literal">{"app-config.xml", "test-config.xml"}</code> for its locations (either explicitly or
implicitly through inheritance) but does not define <code class="literal">@WebAppConfiguration</code>, a different
<code class="literal">ContextLoader</code>, different active profiles, different context initializers, different
test property sources, or a different parent context, then the same <code class="literal">ApplicationContext</code>
will be shared by both test classes. This means that the setup cost for loading an
application context is incurred only once (per test suite), and subsequent test execution
is much faster.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Test suites and forked processes"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Test suites and forked processes</th></tr><tr><td align="left" valign="top">

<p>The Spring TestContext framework stores application contexts in a <span class="emphasis"><em>static</em></span> cache. This
means that the context is literally stored in a <code class="literal">static</code> variable. In other words, if
tests execute in separate processes the static cache will be cleared between each test
execution, and this will effectively disable the caching mechanism.</p>
<p>To benefit from the caching mechanism, all tests must run within the same process or
test suite. This can be achieved by executing all tests as a group within an IDE.
Similarly, when executing tests with a build framework such as Ant, Maven, or Gradle it
is important to make sure that the build framework does not <span class="emphasis"><em>fork</em></span> between tests. For
example, if the
<a class="ulink" href="http://maven.apache.org/plugins/maven-surefire-plugin/test-mojo.html#forkMode" target="_top">forkMode</a>
for the Maven Surefire plug-in is set to <code class="literal">always</code> or <code class="literal">pertest</code>, the TestContext
framework will not be able to cache application contexts between test classes and the
build process will run significantly slower as a result.</p>
</td></tr></table></div>

<p>Since having a large number of application contexts loaded within a given test suite can
cause the suite to take an unnecessarily long time to execute, it is often beneficial to
know exactly how many contexts have been loaded and cached. To view the statistics for
the underlying context cache, simply set the log level for the
<code class="literal">org.springframework.test.context.cache</code> logging category to <code class="literal">DEBUG</code>.</p>
<p>In the unlikely case that a test corrupts the application context and requires reloading&#8201;&#8212;&#8201;for example, by modifying a bean definition or the state of an application object&#8201;&#8212;&#8201;you can annotate your test class or test method with <code class="literal">@DirtiesContext</code> (see the
discussion of <code class="literal">@DirtiesContext</code> in <a class="xref" href="aop-api.html#integration-testing-annotations-spring" title="Spring &#27979;&#35797;&#30456;&#20851;&#27880;&#35299;">the section called &#8220;Spring &#27979;&#35797;&#30456;&#20851;&#27880;&#35299;&#8221;</a>). This
instructs Spring to remove the context from the cache and rebuild the application
context before executing the next test. Note that support for the <code class="literal">@DirtiesContext</code>
annotation is provided by the <code class="literal">DirtiesContextTestExecutionListener</code> which is enabled by
default.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-ctx-hierarchies" href="#testcontext-ctx-management-ctx-hierarchies"></a>Context hierarchies</h5></div></div></div>

<p>When writing integration tests that rely on a loaded Spring <code class="literal">ApplicationContext</code>, it is
often sufficient to test against a single context; however, there are times when it is
beneficial or even necessary to test against a hierarchy of <code class="literal">ApplicationContext</code>s. For
example, if you are developing a Spring MVC web application you will typically have a
root <code class="literal">WebApplicationContext</code> loaded via Spring&#8217;s <code class="literal">ContextLoaderListener</code> and a child
<code class="literal">WebApplicationContext</code> loaded via Spring&#8217;s <code class="literal">DispatcherServlet</code>. This results in a
parent-child context hierarchy where shared components and infrastructure configuration
are declared in the root context and consumed in the child context by web-specific
components. Another use case can be found in Spring Batch applications where you often
have a parent context that provides configuration for shared batch infrastructure and a
child context for the configuration of a specific batch job.</p>
<p>As of Spring Framework 3.2.2, it is possible to write integration tests that use context
hierarchies by declaring context configuration via the <code class="literal">@ContextHierarchy</code> annotation,
either on an individual test class or within a test class hierarchy. If a context
hierarchy is declared on multiple classes within a test class hierarchy it is also
possible to merge or override the context configuration for a specific, named level in
the context hierarchy. When merging configuration for a given level in the hierarchy the
configuration resource type (i.e., XML configuration files or annotated classes) must be
consistent; otherwise, it is perfectly acceptable to have different levels in a context
hierarchy configured using different resource types.</p>
<p>The following JUnit-based examples demonstrate common configuration scenarios for
integration tests that require the use of context hierarchies.</p>
<p><code class="literal">ControllerIntegrationTests</code> represents a typical integration testing scenario for a
Spring MVC web application by declaring a context hierarchy consisting of two levels,
one for the <span class="emphasis"><em>root</em></span> WebApplicationContext (loaded using the <code class="literal">TestAppConfig</code>
<code class="literal">@Configuration</code> class) and one for the <span class="emphasis"><em>dispatcher servlet</em></span> <code class="literal">WebApplicationContext</code>
(loaded using the <code class="literal">WebConfig</code> <code class="literal">@Configuration</code> class). The <code class="literal">WebApplicationContext</code> that
is <span class="emphasis"><em>autowired</em></span> into the test instance is the one for the child context (i.e., the
lowest context in the hierarchy).</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(classes = TestAppConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ControllerIntegrationTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-comment">// ...</span>
}</pre>

<p>The following test classes define a context hierarchy within a test class hierarchy.
<code class="literal">AbstractWebTests</code> declares the configuration for a root <code class="literal">WebApplicationContext</code> in a
Spring-powered web application. Note, however, that <code class="literal">AbstractWebTests</code> does not declare
<code class="literal">@ContextHierarchy</code>; consequently, subclasses of <code class="literal">AbstractWebTests</code> can optionally
participate in a context hierarchy or simply follow the standard semantics for
<code class="literal">@ContextConfiguration</code>. <code class="literal">SoapWebServiceTests</code> and <code class="literal">RestWebServiceTests</code> both extend
<code class="literal">AbstractWebTests</code> and define a context hierarchy via <code class="literal">@ContextHierarchy</code>. The result is
that three application contexts will be loaded (one for each declaration of
<code class="literal">@ContextConfiguration</code>), and the application context loaded based on the configuration
in <code class="literal">AbstractWebTests</code> will be set as the parent context for each of the contexts loaded
for the concrete subclasses.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("file:src/main/webapp/WEB-INF/applicationContext.xml")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractWebTests {}

@ContextHierarchy(<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/soap-ws-config.xml")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SoapWebServiceTests <span class="hl-keyword">extends</span> AbstractWebTests {}

@ContextHierarchy(<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/rest-ws-config.xml")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RestWebServiceTests <span class="hl-keyword">extends</span> AbstractWebTests {}</pre>

<p>The following classes demonstrate the use of <span class="emphasis"><em>named</em></span> hierarchy levels in order to
<span class="emphasis"><em>merge</em></span> the configuration for specific levels in a context hierarchy. <code class="literal">BaseTests</code>
defines two levels in the hierarchy, <code class="literal">parent</code> and <code class="literal">child</code>. <code class="literal">ExtendedTests</code> extends
<code class="literal">BaseTests</code> and instructs the Spring TestContext Framework to merge the context
configuration for the <code class="literal">child</code> hierarchy level, simply by ensuring that the names
declared via <code class="literal">ContextConfiguration</code>'s <code class="literal">name</code> attribute are both <code class="literal">"child"</code>. The result is
that three application contexts will be loaded: one for <code class="literal">"/app-config.xml"</code>, one for
<code class="literal">"/user-config.xml"</code>, and one for <code class="literal">{"/user-config.xml", "/order-config.xml"}</code>. As with
the previous example, the application context loaded from <code class="literal">"/app-config.xml"</code> will be
set as the parent context for the contexts loaded from <code class="literal">"/user-config.xml"</code> and
<code class="literal">{"/user-config.xml", "/order-config.xml"}</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(name = "parent", locations = "/app-config.xml"),
    @ContextConfiguration(name = "child", locations = "/user-config.xml")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {}

<em><span class="hl-annotation" style="color: gray">@ContextHierarchy(
    @ContextConfiguration(name = "child", locations = "/order-config.xml")
)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {}</pre>

<p>In contrast to the previous example, this example demonstrates how to <span class="emphasis"><em>override</em></span> the
configuration for a given named level in a context hierarchy by setting
<code class="literal">ContextConfiguration</code>'s <code class="literal">inheritLocations</code> flag to <code class="literal">false</code>. Consequently, the
application context for <code class="literal">ExtendedTests</code> will be loaded only from
<code class="literal">"/test-user-config.xml"</code> and will have its parent set to the context loaded from
<code class="literal">"/app-config.xml"</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(name = "parent", locations = "/app-config.xml"),
    @ContextConfiguration(name = "child", locations = "/user-config.xml")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {}

<em><span class="hl-annotation" style="color: gray">@ContextHierarchy(
    @ContextConfiguration(
        name = "child",
        locations = "/test-user-config.xml",
        inheritLocations = false
))</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Dirtying a context within a context hierarchy"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Dirtying a context within a context hierarchy</th></tr><tr><td align="left" valign="top">

<p>If <code class="literal">@DirtiesContext</code> is used in a test whose context is configured as part of a context
hierarchy, the <code class="literal">hierarchyMode</code> flag can be used to control how the context cache is
cleared. For further details consult the discussion of <code class="literal">@DirtiesContext</code> in
<a class="link" href="aop-api.html#integration-testing-annotations-spring" title="Spring &#27979;&#35797;&#30456;&#20851;&#27880;&#35299;">Spring Testing Annotations</a> and the
<code class="literal">@DirtiesContext</code> javadocs.</p>
</td></tr></table></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-fixture-di" href="#testcontext-fixture-di"></a>Dependency injection of test fixtures</h4></div></div></div>

<p>When you use the <code class="literal">DependencyInjectionTestExecutionListener</code>&#8201;&#8212;&#8201;which is configured by
default&#8201;&#8212;&#8201;the dependencies of your test instances are <span class="emphasis"><em>injected</em></span> from beans in the
application context that you configured with <code class="literal">@ContextConfiguration</code>. You may use setter
injection, field injection, or both, depending on which annotations you choose and
whether you place them on setter methods or fields. For consistency with the annotation
support introduced in Spring 2.5 and 3.0, you can use Spring&#8217;s <code class="literal">@Autowired</code> annotation
or the <code class="literal">@Inject</code> annotation from JSR 300.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>The TestContext framework does not instrument the manner in which a test instance is
instantiated. Thus the use of <code class="literal">@Autowired</code> or <code class="literal">@Inject</code> for constructors has no effect
for test classes.</p>
</td></tr></table></div>

<p>Because <code class="literal">@Autowired</code> is used to perform <a class="link" href="beans.html#beans-factory-autowire" title="5.4.5&nbsp;&#33258;&#21160;&#35013;&#37197;&#21327;&#20316;&#32773;"><span class="emphasis"><em>autowiring by type</em></span></a>, if you have multiple bean definitions of the same type, you cannot rely on this
approach for those particular beans. In that case, you can use <code class="literal">@Autowired</code> in
conjunction with <code class="literal">@Qualifier</code>. As of Spring 3.0 you may also choose to use <code class="literal">@Inject</code> in
conjunction with <code class="literal">@Named</code>. Alternatively, if your test class has access to its
<code class="literal">ApplicationContext</code>, you can perform an explicit lookup by using (for example) a call
to <code class="literal">applicationContext.getBean("titleRepository")</code>.</p>
<p>If you do not want dependency injection applied to your test instances, simply do not
annotate fields or setter methods with <code class="literal">@Autowired</code> or <code class="literal">@Inject</code>. Alternatively, you can
disable dependency injection altogether by explicitly configuring your class with
<code class="literal">@TestExecutionListeners</code> and omitting <code class="literal">DependencyInjectionTestExecutionListener.class</code>
from the list of listeners.</p>
<p>Consider the scenario of testing a <code class="literal">HibernateTitleRepository</code> class, as outlined in the
<a class="link" href="aop-api.html#integration-testing-goals" title="10.15.2&nbsp;&#38598;&#25104;&#27979;&#35797;&#30340;&#30446;&#26631;">Goals</a> section. The next two code listings demonstrate the
use of <code class="literal">@Autowired</code> on fields and setter methods. The application context configuration
is presented after all sample code listings.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The dependency injection behavior in the following code listings is not specific to
JUnit. The same DI techniques can be used in conjunction with any testing framework.</p>
<p>The following examples make calls to static assertion methods such as <code class="literal">assertNotNull()</code>
but without prepending the call with <code class="literal">Assert</code>. In such cases, assume that the method was
properly imported through an <code class="literal">import static</code> declaration that is not shown in the
example.</p>
</td></tr></table></div>

<p>The first code listing shows a JUnit-based implementation of the test class that uses
<code class="literal">@Autowired</code> for field injection.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// specifies the Spring configuration to load for this test fixture</span>
<span class="strong"><strong>@ContextConfiguration("repository-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateTitleRepositoryTests {

    <span class="hl-comment">// this instance will be dependency injected by type</span>
    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> HibernateTitleRepository titleRepository;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findById() {
        Title title = titleRepository.findById(<span class="hl-keyword">new</span> Long(<span class="hl-number">10</span>));
        assertNotNull(title);
    }
}</pre>

<p>Alternatively, you can configure the class to use <code class="literal">@Autowired</code> for setter injection as
seen below.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// specifies the Spring configuration to load for this test fixture</span>
<span class="strong"><strong>@ContextConfiguration("repository-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateTitleRepositoryTests {

    <span class="hl-comment">// this instance will be dependency injected by type</span>
    <span class="hl-keyword">private</span> HibernateTitleRepository titleRepository;

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setTitleRepository(HibernateTitleRepository titleRepository) {
        <span class="hl-keyword">this</span>.titleRepository = titleRepository;
    }

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> findById() {
        Title title = titleRepository.findById(<span class="hl-keyword">new</span> Long(<span class="hl-number">10</span>));
        assertNotNull(title);
    }
}</pre>

<p>The preceding code listings use the same XML context file referenced by the
<code class="literal">@ContextConfiguration</code> annotation (that is, <code class="literal">repository-config.xml</code>), which looks like
this:</p>
<pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="hl-tag">&gt;</span>

    <span class="hl-comment">&lt;!-- this bean will be injected into the HibernateTitleRepositoryTests class --&gt;</span>
    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"</span><span class="strong"><strong>titleRepository</strong></span>" class="<span class="strong"><strong>com.foo.repository.hibernate.HibernateTitleRepository</strong></span>"&gt;
        <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"sessionFactory"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"sessionFactory"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="hl-tag">&gt;</span>
        <span class="hl-comment">&lt;!-- configuration elided for brevity --&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If you are extending from a Spring-provided test base class that happens to use
<code class="literal">@Autowired</code> on one of its setter methods, you might have multiple beans of the affected
type defined in your application context: for example, multiple <code class="literal">DataSource</code> beans. In
such a case, you can override the setter method and use the <code class="literal">@Qualifier</code> annotation to
indicate a specific target bean as follows, but make sure to delegate to the overridden
method in the superclass as well.</p>
<pre class="programlisting"><span class="hl-comment">// ...</span>

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(<span class="strong"><strong>@Qualifier("myDataSource")</strong></span> DataSource dataSource) {
        <span class="strong"><strong>super</strong></span>.setDataSource(dataSource);
    }

<span class="hl-comment">// ...</span></pre>

<p>The specified qualifier value indicates the specific <code class="literal">DataSource</code> bean to inject,
narrowing the set of type matches to a specific bean. Its value is matched against
<code class="literal">&lt;qualifier&gt;</code> declarations within the corresponding <code class="literal">&lt;bean&gt;</code> definitions. The bean name
is used as a fallback qualifier value, so you may effectively also point to a specific
bean by name there (as shown above, assuming that "myDataSource" is the bean id).</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-web-scoped-beans" href="#testcontext-web-scoped-beans"></a>Testing request and session scoped beans</h4></div></div></div>

<p><a class="link" href="beans.html#beans-factory-scopes-other" title="5.5.4&nbsp;&#35831;&#27714;&#20316;&#29992;&#22495;&#12289;&#20250;&#35805;&#20316;&#29992;&#22495;&#21644;&#20840;&#23616;&#20250;&#35805;&#20316;&#29992;&#22495;">Request and session scoped beans</a> have been supported by
Spring for several years now, but it&#8217;s always been a bit non-trivial to test them. As of
Spring 3.2 it&#8217;s a breeze to test your request-scoped and session-scoped beans by
following these steps.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Ensure that a <code class="literal">WebApplicationContext</code> is loaded for your test by annotating your test
class with <code class="literal">@WebAppConfiguration</code>.
</li><li class="listitem">
Inject the mock request or session into your test instance and prepare your test
fixture as appropriate.
</li><li class="listitem">
Invoke your web component that you retrieved from the configured
<code class="literal">WebApplicationContext</code> (i.e., via dependency injection).
</li><li class="listitem">
Perform assertions against the mocks.
</li></ul></div>

<p>The following code snippet displays the XML configuration for a login use case. Note
that the <code class="literal">userService</code> bean has a dependency on a request-scoped <code class="literal">loginAction</code> bean.
Also, the <code class="literal">LoginAction</code> is instantiated using <a class="link" href="expressions.html" title="8.&nbsp;Spring &#34920;&#36798;&#24335;&#35821;&#35328; (SpEL)">SpEL expressions</a> that
retrieve the username and password from the current HTTP request. In our test, we will
want to configure these request parameters via the mock managed by the TestContext
framework.</p>
<p>
<b>Request-scoped bean configuration.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.SimpleUserService"</span>
            <span class="hl-attribute">c:loginAction-ref</span>=<span class="hl-value">"loginAction"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"loginAction"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.LoginAction"</span>
            <span class="hl-attribute">c:username</span>=<span class="hl-value">"{request.getParameter(</span><span class="emphasis"><em>'user</em></span>')}"
            c:password="{request.getParameter(<span class="emphasis"><em>'pswd</em></span>')}"
            scope="request"&gt;
        <span class="hl-tag">&lt;aop:scoped-proxy /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre><p>

</p>

<p>In <code class="literal">RequestScopedBeanTests</code> we inject both the <code class="literal">UserService</code> (i.e., the subject under
test) and the <code class="literal">MockHttpServletRequest</code> into our test instance. Within our
<code class="literal">requestScope()</code> test method we set up our test fixture by setting request parameters in
the provided <code class="literal">MockHttpServletRequest</code>. When the <code class="literal">loginUser()</code> method is invoked on our
<code class="literal">userService</code> we are assured that the user service has access to the request-scoped
<code class="literal">loginAction</code> for the current <code class="literal">MockHttpServletRequest</code> (i.e., the one we just set
parameters in). We can then perform assertions against the results based on the known
inputs for the username and password.</p>
<p>
<b>Request-scoped bean test.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RequestScopedBeanTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> UserService userService;
    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> MockHttpServletRequest request;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> requestScope() {

        request.setParameter(<span class="hl-string">"user"</span>, <span class="hl-string">"enigma"</span>);
        request.setParameter(<span class="hl-string">"pswd"</span>, <span class="hl-string">"$pr!ng"</span>);

        LoginResults results = userService.loginUser();

        <span class="hl-comment">// assert results</span>
    }
}</pre><p>

</p>

<p>The following code snippet is similar to the one we saw above for a request-scoped bean;
however, this time the <code class="literal">userService</code> bean has a dependency on a session-scoped
<code class="literal">userPreferences</code> bean. Note that the <code class="literal">UserPreferences</code> bean is instantiated using a
SpEL expression that retrieves the <span class="emphasis"><em>theme</em></span> from the current HTTP session. In our test,
we will need to configure a theme in the mock session managed by the TestContext
framework.</p>
<p>
<b>Session-scoped bean configuration.&nbsp;</b>

</p><pre class="programlisting"><span class="hl-tag">&lt;beans&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.SimpleUserService"</span>
            <span class="hl-attribute">c:userPreferences-ref</span>=<span class="hl-value">"userPreferences"</span><span class="hl-tag"> /&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"userPreferences"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.example.UserPreferences"</span>
            <span class="hl-attribute">c:theme</span>=<span class="hl-value">"#{session.getAttribute(</span><span class="emphasis"><em>'theme</em></span>')}"
            scope="session"&gt;
        <span class="hl-tag">&lt;aop:scoped-proxy /&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre><p>

</p>

<p>In <code class="literal">SessionScopedBeanTests</code> we inject the <code class="literal">UserService</code> and the <code class="literal">MockHttpSession</code> into
our test instance. Within our <code class="literal">sessionScope()</code> test method we set up our test fixture by
setting the expected "theme" attribute in the provided <code class="literal">MockHttpSession</code>. When the
<code class="literal">processUserPreferences()</code> method is invoked on our <code class="literal">userService</code> we are assured that
the user service has access to the session-scoped <code class="literal">userPreferences</code> for the current
<code class="literal">MockHttpSession</code>, and we can perform assertions against the results based on the
configured theme.</p>
<p>
<b>Session-scoped bean test.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SessionScopedBeanTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> UserService userService;
    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> MockHttpSession session;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> sessionScope() <span class="hl-keyword">throws</span> Exception {

        session.setAttribute(<span class="hl-string">"theme"</span>, <span class="hl-string">"blue"</span>);

        Results results = userService.processUserPreferences();

        <span class="hl-comment">// assert results</span>
    }
}</pre><p>

</p>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-tx" href="#testcontext-tx"></a>Transaction management</h4></div></div></div>

<p>In the TestContext framework, transactions are managed by the
<code class="literal">TransactionalTestExecutionListener</code> which is configured by default, even if you do not
explicitly declare <code class="literal">@TestExecutionListeners</code> on your test class. To enable support for
transactions, however, you must configure a <code class="literal">PlatformTransactionManager</code> bean in the
<code class="literal">ApplicationContext</code> that is loaded via <code class="literal">@ContextConfiguration</code> semantics (further
details are provided below). In addition, you must declare Spring&#8217;s <code class="literal">@Transactional</code>
annotation either at the class or method level for your tests.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-test-managed-transactions" href="#testcontext-tx-test-managed-transactions"></a>Test-managed transactions</h5></div></div></div>

<p><span class="emphasis"><em>Test-managed transactions</em></span> are transactions that are managed <span class="emphasis"><em>declaratively</em></span> via the
<code class="literal">TransactionalTestExecutionListener</code> or <span class="emphasis"><em>programmatically</em></span> via <code class="literal">TestTransaction</code> (see
below). Such transactions should not be confused with <span class="emphasis"><em>Spring-managed transactions</em></span>
(i.e., those managed directly by Spring within the <code class="literal">ApplicationContext</code> loaded for tests)
or <span class="emphasis"><em>application-managed transactions</em></span> (i.e., those managed programmatically within
application code that is invoked via tests). Spring-managed and application-managed
transactions will typically participate in test-managed transactions; however, caution
should be taken if Spring-managed or application-managed transactions are configured with
any <span class="emphasis"><em>propagation</em></span> type other than <code class="literal">REQUIRED</code> or <code class="literal">SUPPORTS</code> (see the discussion on
<a class="link" href="transaction.html#tx-propagation" title="11.5.7&nbsp;&#20107;&#21153;&#20256;&#25773;&#24615;">transaction propagation</a> for details).</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-enabling-transactions" href="#testcontext-tx-enabling-transactions"></a>Enabling and disabling transactions</h5></div></div></div>

<p>Annotating a test method with <code class="literal">@Transactional</code> causes the test to be run within a
transaction that will, by default, be automatically rolled back after completion of the
test. If a test class is annotated with <code class="literal">@Transactional</code>, each test method within that
class hierarchy will be run within a transaction. Test methods that are not annotated
with <code class="literal">@Transactional</code> (at the class or method level) will not be run within a
transaction. Furthermore, tests that are annotated with <code class="literal">@Transactional</code> but have the
<code class="literal">propagation</code> type set to <code class="literal">NOT_SUPPORTED</code> will not be run within a transaction.</p>
<p><span class="emphasis"><em>Note that <a class="link" href="aop-api.html#testcontext-support-classes-junit4" title="JUnit support classes"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code></a> and
<a class="link" href="aop-api.html#testcontext-support-classes-testng" title="TestNG support classes"><code class="literal">AbstractTransactionalTestNGSpringContextTests</code></a>
are preconfigured for transactional support at the class level.</em></span></p>
<p>The following example demonstrates a common scenario for writing an integration test for
a Hibernate-based <code class="literal">UserRepository</code>. As explained in
<a class="xref" href="aop-api.html#testcontext-tx-rollback-and-commit-behavior" title="Transaction rollback and commit behavior">the section called &#8220;Transaction rollback and commit behavior&#8221;</a>, there is no need to clean up the
database after the <code class="literal">createUser()</code> method is executed since any changes made to the
database will be automatically rolled back by the <code class="literal">TransactionalTestExecutionListener</code>.
See <a class="xref" href="aop-api.html#testing-examples-petclinic" title="10.15.7&nbsp;PetClinic Example">Section&nbsp;10.15.7, &#8220;PetClinic Example&#8221;</a> for an additional example.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = TestConfig.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateUserRepositoryTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    HibernateUserRepository repository;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    SessionFactory sessionFactory;

    JdbcTemplate jdbcTemplate;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> createUser() {
        <span class="hl-comment">// track initial state in test database:</span>
        <span class="hl-keyword">final</span> <span class="hl-keyword">int</span> count = countRowsInTable(<span class="hl-string">"user"</span>);

        User user = <span class="hl-keyword">new</span> User(...);
        repository.save(user);

        <span class="hl-comment">// Manual flush is required to avoid false positive in test</span>
        sessionFactory.getCurrentSession().flush();
        assertNumUsers(count + <span class="hl-number">1</span>);
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">int</span> countRowsInTable(String tableName) {
        <span class="hl-keyword">return</span> JdbcTestUtils.countRowsInTable(<span class="hl-keyword">this</span>.jdbcTemplate, tableName);
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> assertNumUsers(<span class="hl-keyword">int</span> expected) {
        assertEquals(<span class="hl-string">"Number of rows in the </span><span class="emphasis"><em>'user</em></span><span class="hl-string">' table.", expected, countRowsInTable("user"));
</span>    }
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-rollback-and-commit-behavior" href="#testcontext-tx-rollback-and-commit-behavior"></a>Transaction rollback and commit behavior</h5></div></div></div>

<p>By default, test transactions will be automatically rolled back after completion of the
test; however, transactional commit and rollback behavior can be configured declaratively
via the class-level <code class="literal">@TransactionConfiguration</code> and method-level <code class="literal">@Rollback</code> annotations.
See the corresponding entries in the <a class="link" href="aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;&#27880;&#35299;">annotation
support</a> section for further details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-programmatic-tx-mgt" href="#testcontext-tx-programmatic-tx-mgt"></a>Programmatic transaction management</h5></div></div></div>

<p>As of Spring Framework 4.1, it is possible to interact with test-managed transactions
<span class="emphasis"><em>programmatically</em></span> via the static methods in <code class="literal">TestTransaction</code>. For example,
<code class="literal">TestTransaction</code> may be used within <span class="emphasis"><em>test</em></span> methods, <span class="emphasis"><em>before</em></span> methods, and <span class="emphasis"><em>after</em></span>
methods to start or end the current test-managed transaction or to configure the current
test-managed transaction for rollback or commit. Support for <code class="literal">TestTransaction</code> is
automatically available whenever the <code class="literal">TransactionalTestExecutionListener</code> is enabled.</p>
<p>The following example demonstrates some of the features of <code class="literal">TestTransaction</code>. Consult the
javadocs for <code class="literal">TestTransaction</code> for further details.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = TestConfig.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProgrammaticTransactionManagementTests <span class="hl-keyword">extends</span>
        AbstractTransactionalJUnit4SpringContextTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> transactionalTest() {
        <span class="hl-comment">// assert initial state in test database:</span>
        assertNumUsers(<span class="hl-number">2</span>);

        deleteFromTables(<span class="hl-string">"user"</span>);

        <span class="hl-comment">// changes to the database will be committed!</span>
        TestTransaction.flagForCommit();
        TestTransaction.end();
        assertFalse(TestTransaction.isActive());
        assertNumUsers(<span class="hl-number">0</span>);

        TestTransaction.start();
        <span class="hl-comment">// perform other actions against the database that will</span>
        <span class="hl-comment">// be automatically rolled back after the test completes...</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> assertNumUsers(<span class="hl-keyword">int</span> expected) {
        assertEquals(<span class="hl-string">"Number of rows in the </span><span class="emphasis"><em>'user</em></span><span class="hl-string">' table.", expected, countRowsInTable("user"));
</span>    }
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-before-and-after-tx" href="#testcontext-tx-before-and-after-tx"></a>Executing code outside of a transaction</h5></div></div></div>

<p>Occasionally you need to execute certain code before or after a transactional test method
but outside the transactional context&#8201;&#8212;&#8201;for example, to verify the initial database state
prior to execution of your test or to verify expected transactional commit behavior after
test execution (if the test was configured not to roll back the transaction).
<code class="literal">TransactionalTestExecutionListener</code> supports the <code class="literal">@BeforeTransaction</code> and
<code class="literal">@AfterTransaction</code> annotations exactly for such scenarios. Simply annotate any <code class="literal">public
void</code> method in your test class with one of these annotations, and the
<code class="literal">TransactionalTestExecutionListener</code> ensures that your <span class="emphasis"><em>before transaction method</em></span> or
<span class="emphasis"><em>after transaction method</em></span> is executed at the appropriate time.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Any <span class="emphasis"><em>before methods</em></span> (such as methods annotated with JUnit&#8217;s <code class="literal">@Before</code>) and any <span class="emphasis"><em>after
methods</em></span> (such as methods annotated with JUnit&#8217;s <code class="literal">@After</code>) are executed <span class="emphasis"><em>within</em></span> a
transaction. In addition, methods annotated with <code class="literal">@BeforeTransaction</code> or
<code class="literal">@AfterTransaction</code> are naturally not executed for test methods that are not configured
to run within a transaction.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-mgr-config" href="#testcontext-tx-mgr-config"></a>Configuring a transaction manager</h5></div></div></div>

<p><code class="literal">TransactionalTestExecutionListener</code> expects a <code class="literal">PlatformTransactionManager</code> bean to be
defined in the Spring <code class="literal">ApplicationContext</code> for the test. In case there are multiple
instances of <code class="literal">PlatformTransactionManager</code> within the test&#8217;s <code class="literal">ApplicationContext</code>,
<code class="literal">@TransactionConfiguration</code> supports configuring the bean name of the
<code class="literal">PlatformTransactionManager</code> that should be used to drive transactions. Alternatively, a
<span class="emphasis"><em>qualifier</em></span> may be declared via <code class="literal">@Transactional("myQualifier")</code>, or
<code class="literal">TransactionManagementConfigurer</code> can be implemented by an <code class="literal">@Configuration</code> class.
Consult the javadocs for <code class="literal">TestContextTransactionUtils.retrieveTransactionManager()</code> for
details on the algorithm used to look up a transaction manager in the test&#8217;s
<code class="literal">ApplicationContext</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tx-annotation-demo" href="#testcontext-tx-annotation-demo"></a>Demonstration of all transaction-related annotations</h5></div></div></div>

<p>The following JUnit-based example displays a fictitious integration testing scenario
highlighting all transaction-related annotations. The example is <span class="strong"><strong>not</strong></span> intended to
demonstrate best practices but rather to demonstrate how these annotations can be used.
Consult the <a class="link" href="aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;&#27880;&#35299;">annotation support</a> section for further
information and configuration examples. <a class="link" href="aop-api.html#testcontext-executing-sql-declaratively-tx">Transaction management for <code class="literal">@Sql</code></a> contains an additional example using <code class="literal">@Sql</code> for
declarative SQL script execution with default transaction rollback semantics.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TransactionConfiguration(transactionManager="txMgr", defaultRollback=false)
@Transactional</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> FictitiousTransactionalTest {

    <span class="strong"><strong>@BeforeTransaction</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> verifyInitialDatabaseState() {
        <span class="hl-comment">// logic to verify the initial state before a transaction is started</span>
    }

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setUpTestDataWithinTransaction() {
        <span class="hl-comment">// set up test data within the transaction</span>
    }

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-comment">// overrides the class-level defaultRollback setting</span>
    <span class="strong"><strong>@Rollback(true)</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> modifyDatabaseWithinTransaction() {
        <span class="hl-comment">// logic which uses the test data and modifies database state</span>
    }

    <em><span class="hl-annotation" style="color: gray">@After</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> tearDownWithinTransaction() {
        <span class="hl-comment">// execute "tear down" logic within the transaction</span>
    }

    <span class="strong"><strong>@AfterTransaction</strong></span>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> verifyFinalDatabaseState() {
        <span class="hl-comment">// logic to verify the final state after transaction has rolled back</span>
    }

}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: Avoid false positives when testing ORM code"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left"><a name="testcontext-tx-false-positives" href="#testcontext-tx-false-positives"></a>Avoid false positives when testing ORM code</th></tr><tr><td align="left" valign="top">

<p>When you test application code that manipulates the state of the Hibernate session, make
sure to <span class="emphasis"><em>flush</em></span> the underlying session within test methods that execute that code.
Failing to flush the underlying session can produce <span class="emphasis"><em>false positives</em></span>: your test may
pass, but the same code throws an exception in a live, production environment. In the
following Hibernate-based example test case, one method demonstrates a false positive,
and the other method correctly exposes the results of flushing the session. Note that
this applies to JPA and any other ORM frameworks that maintain an in-memory <span class="emphasis"><em>unit of
work</em></span>.</p>
<pre class="programlisting"><span class="hl-comment">// ...</span>

<em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
<span class="hl-keyword">private</span> SessionFactory sessionFactory;

<em><span class="hl-annotation" style="color: gray">@Test</span></em> <span class="hl-comment">// no expected exception!</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> falsePositive() {
    updateEntityInHibernateSession();
    <span class="hl-comment">// False positive: an exception will be thrown once the session is</span>
    <span class="hl-comment">// finally flushed (i.e., in production code)</span>
}

<em><span class="hl-annotation" style="color: gray">@Test(expected = GenericJDBCException.class)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> updateWithSessionFlush() {
    updateEntityInHibernateSession();
    <span class="hl-comment">// Manual flush is required to avoid false positive in test</span>
    sessionFactory.getCurrentSession().flush();
}

<span class="hl-comment">// ...</span></pre>

</td></tr></table></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-executing-sql" href="#testcontext-executing-sql"></a>Executing SQL scripts</h4></div></div></div>

<p>When writing integration tests against a relational database, it is often beneficial
to execute SQL scripts to modify the database schema or insert test data into tables.
The <code class="literal">spring-jdbc</code> module provides support for <span class="emphasis"><em>initializing</em></span> an embedded or existing
database by executing SQL scripts when the Spring <code class="literal">ApplicationContext</code> is loaded. See
<a class="xref" href="jdbc.html#jdbc-embedded-database-support" title="13.8&nbsp;Embedded database support">Section&nbsp;13.8, &#8220;Embedded database support&#8221;</a> and <a class="xref" href="jdbc.html#jdbc-embedded-database-dao-testing" title="13.8.8&nbsp;Testing data access logic with an embedded database">Section&nbsp;13.8.8, &#8220;Testing data access logic with an embedded database&#8221;</a> for
details.</p>
<p>Although it is very useful to initialize a database for testing <span class="emphasis"><em>once</em></span> when the
<code class="literal">ApplicationContext</code> is loaded, sometimes it is essential to be able to modify the
database <span class="emphasis"><em>during</em></span> integration tests. The following sections explain how to execute SQL
scripts programmatically and declaratively during integration tests.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-executing-sql-programmatically" href="#testcontext-executing-sql-programmatically"></a>Executing SQL scripts programmatically</h5></div></div></div>

<p>Spring provides the following options for executing SQL scripts programmatically within
integration test methods.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">org.springframework.jdbc.datasource.init.ScriptUtils</code>
</li><li class="listitem">
<code class="literal">org.springframework.jdbc.datasource.init.ResourceDatabasePopulator</code>
</li><li class="listitem">
<code class="literal">org.springframework.test.context.junit4.AbstractTransactionalJUnit4SpringContextTests</code>
</li><li class="listitem">
<code class="literal">org.springframework.test.context.testng.AbstractTransactionalTestNGSpringContextTests</code>
</li></ul></div>

<p><code class="literal">ScriptUtils</code> provides a collection of static utility methods for working with SQL scripts
and is mainly intended for internal use within the framework. However, if you require
full control over how SQL scripts are parsed and executed, <code class="literal">ScriptUtils</code> may suit your
needs better than some of the other alternatives described below. Consult the javadocs for
individual methods in <code class="literal">ScriptUtils</code> for further details.</p>
<p><code class="literal">ResourceDatabasePopulator</code> provides a simple object-based API for programmatically
populating, initializing, or cleaning up a database using SQL scripts defined in
external resources. <code class="literal">ResourceDatabasePopulator</code> provides options for configuring the
character encoding, statement separator, comment delimiters, and error handling flags
used when parsing and executing the scripts, and each of the configuration options has
a reasonable default value. Consult the javadocs for details on default values. To
execute the scripts configured in a <code class="literal">ResourceDatabasePopulator</code>, you can invoke either
the <code class="literal">populate(Connection)</code> method to execute the populator against a
<code class="literal">java.sql.Connection</code> or the <code class="literal">execute(DataSource)</code> method to execute the populator
against a <code class="literal">javax.sql.DataSource</code>. The following example specifies SQL scripts for a test
schema and test data, sets the statement separator to <code class="literal">"@@"</code>, and then executes the
scripts against a <code class="literal">DataSource</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> databaseTest {
    ResourceDatabasePopulator populator = <span class="hl-keyword">new</span> ResourceDatabasePopulator();
    populator.addScripts(
        <span class="hl-keyword">new</span> ClassPathResource(<span class="hl-string">"test-schema.sql"</span>),
        <span class="hl-keyword">new</span> ClassPathResource(<span class="hl-string">"test-data.sql"</span>));
    populator.setSeparator(<span class="hl-string">"@@"</span>);
    populator.execute(<span class="hl-keyword">this</span>.dataSource);
    <span class="hl-comment">// execute code that uses the test schema and data</span>
}</pre>

<p>Note that <code class="literal">ResourceDatabasePopulator</code> internally delegates to <code class="literal">ScriptUtils</code> for parsing
and executing SQL scripts. Similarly, the <code class="literal">executeSqlScript(..)</code> methods in
<a class="link" href="aop-api.html#testcontext-support-classes-junit4" title="JUnit support classes"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code></a> and
<a class="link" href="aop-api.html#testcontext-support-classes-testng" title="TestNG support classes"><code class="literal">AbstractTransactionalTestNGSpringContextTests</code></a>
internally use a <code class="literal">ResourceDatabasePopulator</code> for executing SQL scripts. Consult the javadocs
for the various <code class="literal">executeSqlScript(..)</code> methods for further details.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-executing-sql-declaratively" href="#testcontext-executing-sql-declaratively"></a>Executing SQL scripts declaratively with <code class="literal">@Sql</code></h5></div></div></div>

<p>In addition to the aforementioned mechanisms for executing SQL scripts
<span class="emphasis"><em>programmatically</em></span>, SQL scripts can also be configured <span class="emphasis"><em>declaratively</em></span> in the Spring
TestContext Framework. Specifically, the <code class="literal">@Sql</code> annotation can be declared on a test
class or test method to configure the resource paths to SQL scripts that should be
executed against a given database either before or after an integration test method. Note
that method-level declarations override class-level declarations and that support for
<code class="literal">@Sql</code> is provided by the <code class="literal">SqlScriptsTestExecutionListener</code> which is enabled by default.</p>
<p><span class="strong"><strong>Path resource semantics</strong></span></p>
<p>Each path will be interpreted as a Spring <code class="literal">Resource</code>. A plain path&#8201;&#8212;&#8201;for example,
<code class="literal">"schema.sql"</code>&#8201;&#8212;&#8201;will be treated as a classpath resource that is <span class="emphasis"><em>relative</em></span> to the
package in which the test class is defined. A path starting with a slash will be treated
as an <span class="emphasis"><em>absolute</em></span> classpath resource, for example: <code class="literal">"/org/example/schema.sql"</code>. A path
which references a URL (e.g., a path prefixed with <code class="literal">classpath:</code>, <code class="literal">file:</code>, <code class="literal">http:</code>, etc.)
will be loaded using the specified resource protocol.</p>
<p>The following example demonstrates how to use <code class="literal">@Sql</code> at the class level and at the method
level within a JUnit-based integration test class.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@Sql("/test-schema.sql")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DatabaseTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> emptySchemaTest {
        <span class="hl-comment">// execute code that uses the test schema without any test data</span>
    }

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <em><span class="hl-annotation" style="color: gray">@Sql({"/test-schema.sql", "/test-user-data.sql"})</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
        <span class="hl-comment">// execute code that uses the test schema and test data</span>
    }
}</pre>

<p><span class="strong"><strong>Default script detection</strong></span></p>
<p>If no SQL scripts are specified, an attempt will be made to detect a <code class="literal">default</code> script
depending on where <code class="literal">@Sql</code> is declared. If a default cannot be detected, an
<code class="literal">IllegalStateException</code> will be thrown.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<span class="emphasis"><em>class-level declaration</em></span>: if the annotated test class is <code class="literal">com.example.MyTest</code>, the
corresponding default script is <code class="literal">"classpath:com/example/MyTest.sql"</code>.
</li><li class="listitem">
<span class="emphasis"><em>method-level declaration</em></span>: if the annotated test method is named <code class="literal">testMethod()</code> and is
defined in the class <code class="literal">com.example.MyTest</code>, the corresponding default script is
<code class="literal">"classpath:com/example/MyTest.testMethod.sql"</code>.
</li></ul></div>

<p><span class="strong"><strong>Declaring multiple <code class="literal">@Sql</code> sets</strong></span></p>
<p>If multiple sets of SQL scripts need to be configured for a given test class or test
method but with different syntax configuration, different error handling rules, or
different execution phases per set, it is possible to declare multiple instances of
<code class="literal">@Sql</code>. With Java 8, <code class="literal">@Sql</code> can be used as a <span class="emphasis"><em>repeatable</em></span> annotation. Otherwise, the
<code class="literal">@SqlGroup</code> annotation can be used as an explicit container for declaring multiple
instances of <code class="literal">@Sql</code>.</p>
<p>The following example demonstrates the use of <code class="literal">@Sql</code> as a repeatable annotation using
Java 8. In this scenario the <code class="literal">test-schema.sql</code> script uses a different syntax for
single-line comments.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@Sql(scripts = "/test-schema.sql", config = @SqlConfig(commentPrefix = "`"))</span></em>
<em><span class="hl-annotation" style="color: gray">@Sql("/test-user-data.sql")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// execute code that uses the test schema and test data</span>
}</pre>

<p>The following example is identical to the above except that the <code class="literal">@Sql</code> declarations are
grouped together within <code class="literal">@SqlGroup</code> for compatibility with Java 6 and Java 7.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@SqlGroup({
    @Sql(scripts = "/test-schema.sql", config = @SqlConfig(commentPrefix = "`")),
    @Sql("/test-user-data.sql")
)}</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// execute code that uses the test schema and test data</span>
}</pre>

<p><span class="strong"><strong>Script execution phases</strong></span></p>
<p>By default, SQL scripts will be executed <span class="emphasis"><em>before</em></span> the corresponding test method. However,
if a particular set of scripts needs to be executed <span class="emphasis"><em>after</em></span> the test method&#8201;&#8212;&#8201;for
example, to clean up database state&#8201;&#8212;&#8201;the <code class="literal">executionPhase</code> attribute in <code class="literal">@Sql</code> can be
used as seen in the following example. Note that <code class="literal">ISOLATED</code> and <code class="literal">AFTER_TEST_METHOD</code> are
statically imported from <code class="literal">Sql.TransactionMode</code> and <code class="literal">Sql.ExecutionPhase</code> respectively.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@Sql(
    scripts = "create-test-data.sql",
    config = @SqlConfig(transactionMode = ISOLATED)
)</span></em>
<em><span class="hl-annotation" style="color: gray">@Sql(
    scripts = "delete-test-data.sql",
    config = @SqlConfig(transactionMode = ISOLATED),
    executionPhase = AFTER_TEST_METHOD
)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// execute code that needs the test data to be committed</span>
    <span class="hl-comment">// to the database outside of the test's transaction</span>
}</pre>

<p><span class="strong"><strong>Script configuration with <code class="literal">@SqlConfig</code></strong></span></p>
<p>Configuration for script parsing and error handling can be configured via the
<code class="literal">@SqlConfig</code> annotation. When declared as a class-level annotation on an integration test
class, <code class="literal">@SqlConfig</code> serves as <span class="emphasis"><em>global</em></span> configuration for all SQL scripts within the test
class hierarchy. When declared directly via the <code class="literal">config</code> attribute of the <code class="literal">@Sql</code>
annotation, <code class="literal">@SqlConfig</code> serves as <span class="emphasis"><em>local</em></span> configuration for the SQL scripts declared
within the enclosing <code class="literal">@Sql</code> annotation. Every attribute in <code class="literal">@SqlConfig</code> has an implicit
default value which is documented in the javadocs of the corresponding attribute. Due to
the rules defined for annotation attributes in the Java Language Specification, it is
unfortunately not possible to assign a value of <code class="literal">null</code> to an annotation attribute. Thus,
in order to support overrides of inherited global configuration, <code class="literal">@SqlConfig</code> attributes
have an explicit default value of either <code class="literal">""</code> for Strings or <code class="literal">DEFAULT</code> for Enums. This
approach allows local declarations of <code class="literal">@SqlConfig</code> to selectively override individual
attributes from global declarations of <code class="literal">@SqlConfig</code> by providing a value other than <code class="literal">""</code>
or <code class="literal">DEFAULT</code>. Global <code class="literal">@SqlConfig</code> attributes are inherited whenever local <code class="literal">@SqlConfig</code>
attributes do not supply an explicit value other than <code class="literal">""</code> or <code class="literal">DEFAULT</code>. Explicit <span class="emphasis"><em>local</em></span>
configuration therefore overrides <span class="emphasis"><em>global</em></span> configuration.</p>
<p>The configuration options provided by <code class="literal">@Sql</code> and <code class="literal">@SqlConfig</code> are equivalent to those
supported by <code class="literal">ScriptUtils</code> and <code class="literal">ResourceDatabasePopulator</code> but are a superset of those
provided by the <code class="literal">&lt;jdbc:initialize-database/&gt;</code> XML namespace element. Consult the javadocs
of individual attributes in <code class="literal">@Sql</code> and <code class="literal">@SqlConfig</code> for details.</p>
<p><a name="testcontext-executing-sql-declaratively-tx" href="#testcontext-executing-sql-declaratively-tx"></a><span class="strong"><strong>Transaction management for <code class="literal">@Sql</code></strong></span></p>
<p>By default, the <code class="literal">SqlScriptsTestExecutionListener</code> will infer the desired transaction
semantics for scripts configured via <code class="literal">@Sql</code>. Specifically, SQL scripts will be executed
without a transaction, within an existing Spring-managed transaction&#8201;&#8212;&#8201;for example, a
transaction managed by the <code class="literal">TransactionalTestExecutionListener</code> for a test annotated with
<code class="literal">@Transactional</code>&#8201;&#8212;&#8201;or within an isolated transaction, depending on the configured value
of the <code class="literal">transactionMode</code> attribute in <code class="literal">@SqlConfig</code> and the presence of a
<code class="literal">PlatformTransactionManager</code> in the test&#8217;s <code class="literal">ApplicationContext</code>. As a bare minimum
however, a <code class="literal">javax.sql.DataSource</code> must be present in the test&#8217;s <code class="literal">ApplicationContext</code>.</p>
<p>If the algorithms used by <code class="literal">SqlScriptsTestExecutionListener</code> to detect a <code class="literal">DataSource</code> and
<code class="literal">PlatformTransactionManager</code> and infer the transaction semantics do not suit your needs,
you may specify explicit names via the <code class="literal">dataSource</code> and <code class="literal">transactionManager</code> attributes
of <code class="literal">@SqlConfig</code>. Furthermore, the transaction propagation behavior can be controlled via
the <code class="literal">transactionMode</code> attribute of <code class="literal">@SqlConfig</code>&#8201;&#8212;&#8201;for example, if scripts should be
executed in an isolated transaction. Although a thorough discussion of all supported
options for transaction management with <code class="literal">@Sql</code> is beyond the scope of this reference
manual, the javadocs for <code class="literal">@SqlConfig</code> and <code class="literal">SqlScriptsTestExecutionListener</code> provide
detailed information, and the following example demonstrates a typical testing scenario
using JUnit and transactional tests with <code class="literal">@Sql</code>. Note that there is no need to clean up
the database after the <code class="literal">usersTest()</code> method is executed since any changes made to the
database (either within the the test method or within the <code class="literal">/test-data.sql</code> script) will
be automatically rolled back by the <code class="literal">TransactionalTestExecutionListener</code> (see
<a class="link" href="aop-api.html#testcontext-tx" title="Transaction management">transaction management</a> for details).</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = TestDatabaseConfig.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransactionalSqlScriptsTests {

    <span class="hl-keyword">protected</span> JdbcTemplate jdbcTemplate;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setDataSource(DataSource dataSource) {
        <span class="hl-keyword">this</span>.jdbcTemplate = <span class="hl-keyword">new</span> JdbcTemplate(dataSource);
    }

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <em><span class="hl-annotation" style="color: gray">@Sql("/test-data.sql")</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> usersTest() {
        <span class="hl-comment">// verify state in test database:</span>
        assertNumUsers(<span class="hl-number">2</span>);
        <span class="hl-comment">// execute code that uses the test data...</span>
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">int</span> countRowsInTable(String tableName) {
        <span class="hl-keyword">return</span> JdbcTestUtils.countRowsInTable(<span class="hl-keyword">this</span>.jdbcTemplate, tableName);
    }

    <span class="hl-keyword">protected</span> <span class="hl-keyword">void</span> assertNumUsers(<span class="hl-keyword">int</span> expected) {
        assertEquals(<span class="hl-string">"Number of rows in the </span><span class="emphasis"><em>'user</em></span><span class="hl-string">' table.", expected, countRowsInTable("user"));
</span>    }
}</pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-support-classes" href="#testcontext-support-classes"></a>TestContext Framework support classes</h4></div></div></div>

<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-support-classes-junit4" href="#testcontext-support-classes-junit4"></a>JUnit support classes</h5></div></div></div>

<p>The <code class="literal">org.springframework.test.context.junit4</code> package provides the following support
classes for JUnit-based test cases.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">AbstractJUnit4SpringContextTests</code>
</li><li class="listitem">
<code class="literal">AbstractTransactionalJUnit4SpringContextTests</code>
</li></ul></div>

<p><code class="literal">AbstractJUnit4SpringContextTests</code> is an abstract base test class that integrates the
<span class="emphasis"><em>Spring TestContext Framework</em></span> with explicit <code class="literal">ApplicationContext</code> testing support in
a JUnit 4.9+ environment. When you extend <code class="literal">AbstractJUnit4SpringContextTests</code>, you can
access a <code class="literal">protected</code> <code class="literal">applicationContext</code> instance variable that can be used to perform
explicit bean lookups or to test the state of the context as a whole.</p>
<p><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code> is an abstract <span class="emphasis"><em>transactional</em></span> extension
of <code class="literal">AbstractJUnit4SpringContextTests</code> that adds some convenience functionality for JDBC
access. This class expects a <code class="literal">javax.sql.DataSource</code> bean and a <code class="literal">PlatformTransactionManager</code>
bean to be defined in the <code class="literal">ApplicationContext</code>. When you extend
<code class="literal">AbstractTransactionalJUnit4SpringContextTests</code> you can access a <code class="literal">protected</code> <code class="literal">jdbcTemplate</code>
instance variable that can be used to execute SQL statements to query the database. Such
queries can be used to confirm database state both <span class="emphasis"><em>prior to</em></span> and <span class="emphasis"><em>after</em></span> execution of
database-related application code, and Spring ensures that such queries run in the scope of
the same transaction as the application code. When used in conjunction with an ORM tool,
be sure to avoid <a class="link" href="aop-api.html#testcontext-tx-false-positives" title="Avoid false positives when testing ORM code">false positives</a>. As mentioned in
<a class="xref" href="aop-api.html#integration-testing-support-jdbc" title="10.15.3&nbsp;JDBC &#27979;&#35797;&#25903;&#25345;">Section&nbsp;10.15.3, &#8220;JDBC &#27979;&#35797;&#25903;&#25345;&#8221;</a>, <code class="literal">AbstractTransactionalJUnit4SpringContextTests</code>
also provides convenience methods which delegate to methods in <code class="literal">JdbcTestUtils</code> using the
aforementioned <code class="literal">jdbcTemplate</code>. Furthermore, <code class="literal">AbstractTransactionalJUnit4SpringContextTests</code>
provides an <code class="literal">executeSqlScript(..)</code> method for executing SQL scripts against the configured
<code class="literal">DataSource</code>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>These classes are a convenience for extension. If you do not want your test classes to be
tied to a Spring-specific class hierarchy, you can configure your own custom test classes
by using <code class="literal">@RunWith(SpringJUnit4ClassRunner.class)</code>, <code class="literal">@ContextConfiguration</code>,
<code class="literal">@TestExecutionListeners</code>, and so on.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-junit4-runner" href="#testcontext-junit4-runner"></a>Spring JUnit Runner</h5></div></div></div>

<p>The <span class="emphasis"><em>Spring TestContext Framework</em></span> offers full integration with JUnit 4.9+ through a
custom runner (tested on JUnit 4.9&#8201;&#8212;&#8201;4.11). By annotating test classes with
<code class="literal">@RunWith(SpringJUnit4ClassRunner.class)</code>, developers can implement standard JUnit-based
unit and integration tests and simultaneously reap the benefits of the TestContext
framework such as support for loading application contexts, dependency injection of test
instances, transactional test method execution, and so on. The following code listing
displays the minimal requirements for configuring a test class to run with the custom
Spring Runner. <code class="literal">@TestExecutionListeners</code> is configured with an empty list in order to
disable the default listeners, which otherwise would require an ApplicationContext to be
configured through <code class="literal">@ContextConfiguration</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@TestExecutionListeners({})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> SimpleTest {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testMethod() {
        <span class="hl-comment">// execute test logic...</span>
    }
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-support-classes-testng" href="#testcontext-support-classes-testng"></a>TestNG support classes</h5></div></div></div>

<p>The <code class="literal">org.springframework.test.context.testng</code> package provides the following support
classes for TestNG based test cases.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">AbstractTestNGSpringContextTests</code>
</li><li class="listitem">
<code class="literal">AbstractTransactionalTestNGSpringContextTests</code>
</li></ul></div>

<p><code class="literal">AbstractTestNGSpringContextTests</code> is an abstract base test class that integrates the
<span class="emphasis"><em>Spring TestContext Framework</em></span> with explicit <code class="literal">ApplicationContext</code> testing support in
a TestNG environment. When you extend <code class="literal">AbstractTestNGSpringContextTests</code>, you can
access a <code class="literal">protected</code> <code class="literal">applicationContext</code> instance variable that can be used to perform
explicit bean lookups or to test the state of the context as a whole.</p>
<p><code class="literal">AbstractTransactionalTestNGSpringContextTests</code> is an abstract <span class="emphasis"><em>transactional</em></span> extension
of <code class="literal">AbstractTestNGSpringContextTests</code> that adds some convenience functionality for JDBC
access. This class expects a <code class="literal">javax.sql.DataSource</code> bean and a <code class="literal">PlatformTransactionManager</code>
bean to be defined in the <code class="literal">ApplicationContext</code>. When you extend
<code class="literal">AbstractTransactionalTestNGSpringContextTests</code> you can access a <code class="literal">protected</code> <code class="literal">jdbcTemplate</code>
instance variable that can be used to execute SQL statements to query the database. Such
queries can be used to confirm database state both <span class="emphasis"><em>prior to</em></span> and <span class="emphasis"><em>after</em></span> execution of
database-related application code, and Spring ensures that such queries run in the scope of
the same transaction as the application code. When used in conjunction with an ORM tool,
be sure to avoid <a class="link" href="aop-api.html#testcontext-tx-false-positives" title="Avoid false positives when testing ORM code">false positives</a>. As mentioned in
<a class="xref" href="aop-api.html#integration-testing-support-jdbc" title="10.15.3&nbsp;JDBC &#27979;&#35797;&#25903;&#25345;">Section&nbsp;10.15.3, &#8220;JDBC &#27979;&#35797;&#25903;&#25345;&#8221;</a>, <code class="literal">AbstractTransactionalTestNGSpringContextTests</code>
also provides convenience methods which delegate to methods in <code class="literal">JdbcTestUtils</code> using the
aforementioned <code class="literal">jdbcTemplate</code>. Furthermore, <code class="literal">AbstractTransactionalTestNGSpringContextTests</code>
provides an <code class="literal">executeSqlScript(..)</code> method for executing SQL scripts against the configured
<code class="literal">DataSource</code>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>These classes are a convenience for extension. If you do not want your test classes to be
tied to a Spring-specific class hierarchy, you can configure your own custom test classes
by using <code class="literal">@ContextConfiguration</code>, <code class="literal">@TestExecutionListeners</code>, and so on, and by manually
instrumenting your test class with a <code class="literal">TestContextManager</code>. See the source code of
<code class="literal">AbstractTestNGSpringContextTests</code> for an example of how to instrument your test class.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="spring-mvc-test-framework" href="#spring-mvc-test-framework"></a>10.15.6&nbsp;Spring MVC Test Framework</h3></div></div></div>

<div class="sidebar"><div class="titlepage"><div><div><p class="title"><b>Standalone project</b></p></div></div></div>

<p>Before inclusion in Spring Framework 3.2, the Spring MVC Test framework had already
existed as a separate project on GitHub where it grew and evolved through actual use,
feedback, and the contribution of many.</p>
<p>The standalone <a class="ulink" href="https://github.com/spring-projects/spring-test-mvc" target="_top">spring-test-mvc project</a>
is still available on GitHub and can be used in conjunction with Spring Framework 3.1.x.
Applications upgrading to 3.2 or later should replace the <code class="literal">spring-test-mvc</code> dependency with a
dependency on <code class="literal">spring-test</code>.</p>
<p>The <code class="literal">spring-test</code> module uses a different package <code class="literal">org.springframework.test.web</code> but
otherwise is nearly identical with two exceptions. One is support for features new in
3.2 (e.g. asynchronous web requests). The other relates to the options for creating a
<code class="literal">MockMvc</code> instance. In Spring Framework 3.2 and later, this can only be done through the
TestContext framework, which provides caching benefits for the loaded configuration.</p>
</div>

<p>The <span class="emphasis"><em>Spring MVC Test framework</em></span> provides first class JUnit support for testing client
and server-side Spring MVC code through a fluent API. Typically it loads the actual
Spring configuration through the <span class="emphasis"><em>TestContext framework</em></span> and always uses the
<code class="literal">DispatcherServlet</code> to process requests thus approximating full integration tests
without requiring a running Servlet container.</p>
<p>Client-side tests are <code class="literal">RestTemplate</code>-based and allow tests for code that relies on the
<code class="literal">RestTemplate</code> without requiring a running server to respond to the requests.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-mvc-test-server" href="#spring-mvc-test-server"></a>Server-Side Tests</h4></div></div></div>

<p>Before Spring Framework 3.2, the most likely way to test a Spring MVC controller was to
write a unit test that instantiates the controller, injects it with mock or stub
dependencies, and then calls its methods directly, using a <code class="literal">MockHttpServletRequest</code> and
<code class="literal">MockHttpServletResponse</code> where necessary.</p>
<p>Although this is pretty easy to do, controllers have many annotations, and much remains
untested. Request mappings, data binding, type conversion, and validation are just a few
examples of what isn&#8217;t tested. Furthermore, there are other types of annotated methods
such as <code class="literal">@InitBinder</code>, <code class="literal">@ModelAttribute</code>, and <code class="literal">@ExceptionHandler</code> that get invoked as
part of request processing.</p>
<p>The idea behind Spring MVC Test is to be able to re-write those controller tests by
performing actual requests and generating responses, as they would be at runtime, along
the way invoking controllers through the Spring MVC <code class="literal">DispatcherServlet</code>. Controllers can
still be injected with mock dependencies, so tests can remain focused on the web layer.</p>
<p>Spring MVC Test builds on the familiar "mock" implementations of the Servlet API
available in the <code class="literal">spring-test</code> module. This allows performing requests and generating
responses without the need for running in a Servlet container. For the most part
everything should work as it does at runtime with the exception of JSP rendering, which
is not available outside a Servlet container. Furthermore, if you are familiar with how
the <code class="literal">MockHttpServletResponse</code> works, you&#8217;ll know that forwards and redirects are not
actually executed. Instead "forwarded" and "redirected" URLs are saved and can be
asserted in tests. This means if you are using JSPs, you can verify the JSP page to
which the request was forwarded.</p>
<p>All other means of rendering including <code class="literal">@ResponseBody</code> methods and <code class="literal">View</code> types (besides
JSPs) such as Freemarker, Velocity, Thymeleaf, and others for rendering HTML, JSON, XML,
and so on should work as expected, and the response will contain the generated content.</p>
<p>Below is an example of a test requesting account information in JSON format:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
<span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("test-servlet-context.xml")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExampleTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        <span class="hl-keyword">this</span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="hl-keyword">this</span>.wac).build();
    }

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getAccount() <span class="hl-keyword">throws</span> Exception {
        <span class="hl-keyword">this</span>.mockMvc.perform(get(<span class="hl-string">"/accounts/1"</span>).accept(MediaType.parseMediaType(<span class="hl-string">"application/json;charset=UTF-8"</span>)))
            .andExpect(status().isOk())
            .andExpect(content().contentType(<span class="hl-string">"application/json"</span>))
            .andExpect(jsonPath(<span class="hl-string">"$.name"</span>).value(<span class="hl-string">"Lee"</span>));
    }

}</pre>

<p>The test relies on the <code class="literal">WebApplicationContext</code> support of the <span class="emphasis"><em>TestContext framework</em></span>.
It loads Spring configuration from an XML configuration file located in the same package
as the test class (also supports JavaConfig) and injects the created
<code class="literal">WebApplicationContext</code> into the test so a <code class="literal">MockMvc</code> instance can be created with it.</p>
<p>The <code class="literal">MockMvc</code> is then used to perform a request to <code class="literal">"/accounts/1"</code> and verify the
resulting response status is 200, the response content type is <code class="literal">"application/json"</code>, and
response content has a JSON property called "name" with the value "Lee". JSON content is
inspected with the help of Jayway&#8217;s <a class="ulink" href="https://github.com/jayway/JsonPath" target="_top">JsonPath
project</a>. There are lots of other options for verifying the result of the performed
request and those will be discussed later.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-static-imports" href="#spring-mvc-test-server-static-imports"></a>Static Imports</h5></div></div></div>

<p>The fluent API in the example above requires a few static imports such as
<code class="literal">MockMvcRequestBuilders.*</code>, <code class="literal">MockMvcResultMatchers.*</code>, and <code class="literal">MockMvcBuilders.*</code>. An easy
way to find these classes is to search for types matching <span class="emphasis"><em>"MockMvc*"</em></span>. If using
Eclipse, be sure to add them as "favorite static members" in the Eclipse preferences
under<span class="emphasis"><em>Java &#8594; Editor &#8594; Content Assist &#8594; Favorites</em></span>. That will allow use of content
assist after typing the first character of the static method name. Other IDEs (e.g.
IntelliJ) may not require any additional configuration. Just check the support for code
completion on static members.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-setup-options" href="#spring-mvc-test-server-setup-options"></a>Setup Options</h5></div></div></div>

<p>The goal of server-side test setup is to create an instance of <code class="literal">MockMvc</code> that can be
used to perform requests. There are two main options.</p>
<p>The first option is to point to Spring MVC configuration through the <span class="emphasis"><em>TestContext
framework</em></span>, which loads the Spring configuration and injects a <code class="literal">WebApplicationContext</code>
into the test to use to create a <code class="literal">MockMvc</code>:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("my-servlet-context.xml")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        <span class="hl-keyword">this</span>.mockMvc = MockMvcBuilders.webAppContextSetup(<span class="hl-keyword">this</span>.wac).build();
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>The second option is to simply register a controller instance without loading any Spring
configuration. Instead basic Spring MVC configuration suitable for testing annotated
controllers is automatically created. The created configuration is comparable to that of
the MVC JavaConfig (and the MVC namespace) and can be customized to a degree through
builder-style methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebTests {

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        <span class="hl-keyword">this</span>.mockMvc = MockMvcBuilders.standaloneSetup(<span class="hl-keyword">new</span> AccountController()).build();
    }

    <span class="hl-comment">// ...</span>

}</pre>

<p>Which option should you use?</p>
<p>The <span class="emphasis"><em>"webAppContextSetup"</em></span> loads the actual Spring MVC configuration resulting in a
more complete integration test. Since the <span class="emphasis"><em>TestContext framework</em></span> caches the loaded
Spring configuration, it helps to keep tests running fast even as more tests get added.
Furthermore, you can inject mock services into controllers through Spring configuration,
in order to remain focused on testing the web layer. Here is an example of declaring a
mock service with Mockito:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountService"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.mockito.Mockito"</span> <span class="hl-attribute">factory-method</span>=<span class="hl-value">"mock"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">value</span>=<span class="hl-value">"org.example.AccountService"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Then you can inject the mock service into the test in order set up and verify
expectations:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("test-servlet-context.xml")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> AccountTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> AccountService accountService;

    <span class="hl-comment">// ...</span>

}</pre>

<p>The <span class="emphasis"><em>"standaloneSetup"</em></span> on the other hand is a little closer to a unit test. It tests
one controller at a time, the controller can be injected with mock dependencies
manually, and it doesn&#8217;t involve loading Spring configuration. Such tests are more
focused in style and make it easier to see which controller is being tested, whether any
specific Spring MVC configuration is required to work, and so on. The "standaloneSetup"
is also a very convenient way to write ad-hoc tests to verify some behavior or to debug
an issue.</p>
<p>Just like with integration vs unit testing, there is no right or wrong answer. Using the
"standaloneSetup" does imply the need for some additional "webAppContextSetup" tests to
verify the Spring MVC configuration. Alternatively, you can decide write all tests with
"webAppContextSetup" and always test against actual Spring MVC configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-performing-requests" href="#spring-mvc-test-server-performing-requests"></a>Performing Requests</h5></div></div></div>

<p>To perform requests, use the appropriate HTTP method and additional builder-style
methods corresponding to properties of <code class="literal">MockHttpServletRequest</code>. For example:</p>
<pre class="programlisting">mockMvc.perform(post(<span class="hl-string">"/hotels/{id}"</span>, <span class="hl-number">42</span>).accept(MediaType.APPLICATION_JSON));</pre>

<p>In addition to all the HTTP methods, you can also perform file upload requests, which
internally creates an instance of <code class="literal">MockMultipartHttpServletRequest</code>:</p>
<pre class="programlisting">mockMvc.perform(fileUpload(<span class="hl-string">"/doc"</span>).file(<span class="hl-string">"a1"</span>, <span class="hl-string">"ABC"</span>.getBytes(<span class="hl-string">"UTF-8"</span>)));</pre>

<p>Query string parameters can be specified in the URI template:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/hotels?foo={foo}"</span>, <span class="hl-string">"bar"</span>));</pre>

<p>Or by adding Servlet request parameters:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/hotels"</span>).param(<span class="hl-string">"foo"</span>, <span class="hl-string">"bar"</span>));</pre>

<p>If application code relies on Servlet request parameters, and doesn&#8217;t check the query
string, as is most often the case, then it doesn&#8217;t matter how parameters are added. Keep
in mind though that parameters provided in the URI template will be decoded while
parameters provided through the <code class="literal">param(...)</code> method are expected to be decoded.</p>
<p>In most cases it&#8217;s preferable to leave out the context path and the Servlet path from
the request URI. If you must test with the full request URI, be sure to set the
<code class="literal">contextPath</code> and <code class="literal">servletPath</code> accordingly so that request mappings will work:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/app/main/hotels/{id}"</span>).contextPath(<span class="hl-string">"/app"</span>).servletPath(<span class="hl-string">"/main"</span>))</pre>

<p>Looking at the above example, it would be cumbersome to set the contextPath and
servletPath with every performed request. That&#8217;s why you can define default request
properties when building the <code class="literal">MockMvc</code>:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebTests {

    <span class="hl-keyword">private</span> MockMvc mockMvc;

    <em><span class="hl-annotation" style="color: gray">@Before</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> setup() {
        mockMvc = standaloneSetup(<span class="hl-keyword">new</span> AccountController())
            .defaultRequest(get(<span class="hl-string">"/"</span>)
            .contextPath(<span class="hl-string">"/app"</span>).servletPath(<span class="hl-string">"/main"</span>)
            .accept(MediaType.APPLICATION_JSON).build();
    }</pre>

<p>The above properties will apply to every request performed through the <code class="literal">MockMvc</code>. If the
same property is also specified on a given request, it will override the default value.
That is why, the HTTP method and URI don&#8217;t matter, when setting default request
properties, since they must be specified on every request.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-defining-expectations" href="#spring-mvc-test-server-defining-expectations"></a>Defining Expectations</h5></div></div></div>

<p>Expectations can be defined by appending one or more <code class="literal">.andExpect(..)</code> after call to
perform the request:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/accounts/1"</span>)).andExpect(status().isOk());</pre>

<p><code class="literal">MockMvcResultMatchers.*</code> defines a number of static members, some of which return types
with additional methods, for asserting the result of the performed request. The
assertions fall in two general categories.</p>
<p>The first category of assertions verify properties of the response, i.e the response
status, headers, and content. Those are the most important things to test for.</p>
<p>The second category of assertions go beyond the response, and allow inspecting Spring
MVC specific constructs such as which controller method processed the request, whether
an exception was raised and handled, what the content of the model is, what view was
selected, what flash attributes were added, and so on. It is also possible to verify
Servlet specific constructs such as request and session attributes. The following test
asserts that binding/validation failed:</p>
<pre class="programlisting">mockMvc.perform(post(<span class="hl-string">"/persons"</span>))
    .andExpect(status().isOk())
    .andExpect(model().attributeHasErrors(<span class="hl-string">"person"</span>));</pre>

<p>Many times when writing tests, it&#8217;s useful to dump the result of the performed request.
This can be done as follows, where <code class="literal">print()</code> is a static import from
<code class="literal">MockMvcResultHandlers</code>:</p>
<pre class="programlisting">mockMvc.perform(post(<span class="hl-string">"/persons"</span>))
    .andDo(print())
    .andExpect(status().isOk())
    .andExpect(model().attributeHasErrors(<span class="hl-string">"person"</span>));</pre>

<p>As long as request processing causes an unhandled exception, the <code class="literal">print()</code> method will
print all the available result data to <code class="literal">System.out</code>.</p>
<p>In some cases, you may want to get direct access to the result and verify something that
cannot be verified otherwise. This can be done by appending <code class="literal">.andReturn()</code> at the end
after all expectations:</p>
<pre class="programlisting">MvcResult mvcResult = mockMvc.perform(post(<span class="hl-string">"/persons"</span>)).andExpect(status().isOk()).andReturn();
<span class="hl-comment">// ...</span></pre>

<p>When all tests repeat the same expectations, you can define the common expectations once
when building the <code class="literal">MockMvc</code>:</p>
<pre class="programlisting">standaloneSetup(<span class="hl-keyword">new</span> SimpleController())
    .alwaysExpect(status().isOk())
    .alwaysExpect(content().contentType(<span class="hl-string">"application/json;charset=UTF-8"</span>))
    .build()</pre>

<p>Note that the expectation is <span class="emphasis"><em>always</em></span> applied and cannot be overridden without
creating a separate <code class="literal">MockMvc</code> instance.</p>
<p>When JSON response content contains hypermedia links created with
<a class="ulink" href="https://github.com/spring-projects/spring-hateoas" target="_top">Spring HATEOAS</a>, the resulting links can
be verified:</p>
<pre class="programlisting">mockMvc.perform(get(<span class="hl-string">"/people"</span>).accept(MediaType.APPLICATION_JSON))
    .andExpect(jsonPath(<span class="hl-string">"$.links[?(@.rel == </span><span class="emphasis"><em>'self</em></span><span class="hl-string">')].href").value("http://localhost:8080/people"));</span></pre>

<p>When XML response content contains hypermedia links created with
<a class="ulink" href="https://github.com/spring-projects/spring-hateoas" target="_top">Spring HATEOAS</a>, the resulting links can
be verified:</p>
<pre class="programlisting">Map&lt;String, String&gt; ns = Collections.singletonMap(<span class="hl-string">"ns"</span>, <span class="hl-string">"http://www.w3.org/2005/Atom"</span>);
mockMvc.perform(get(<span class="hl-string">"/handle"</span>).accept(MediaType.APPLICATION_XML))
    .andExpect(xpath(<span class="hl-string">"/person/ns:link[@rel=</span><span class="emphasis"><em>'self</em></span><span class="hl-string">']/@href", ns).string("http://localhost:8080/people"));</span></pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-filters" href="#spring-mvc-test-server-filters"></a>Filter Registrations</h5></div></div></div>

<p>When setting up a <code class="literal">MockMvc</code>, you can register one or more <code class="literal">Filter</code> instances:</p>
<pre class="programlisting">mockMvc = standaloneSetup(<span class="hl-keyword">new</span> PersonController()).addFilters(<span class="hl-keyword">new</span> CharacterEncodingFilter()).build();</pre>

<p>Registered filters will be invoked through <code class="literal">MockFilterChain</code> from <code class="literal">spring-test</code> and the
last filter will delegates to the <code class="literal">DispatcherServlet</code>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-server-resources" href="#spring-mvc-test-server-resources"></a>Further Server-Side Test Examples</h5></div></div></div>

<p>The framework&#8217;s own tests include
<a class="ulink" href="https://github.com/spring-projects/spring-framework/tree/master/spring-test/src/test/java/org/springframework/test/web/servlet/samples" target="_top">many
sample tests</a> intended to demonstrate how to use Spring MVC Test. Browse these examples
for further ideas. Also the
<a class="ulink" href="https://github.com/spring-projects/spring-mvc-showcase" target="_top">spring-mvc-showcase</a> has full test
coverage based on Spring MVC Test.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="spring-mvc-test-client" href="#spring-mvc-test-client"></a>Client-Side REST Tests</h4></div></div></div>

<p>Client-side tests are for code using the <code class="literal">RestTemplate</code>. The goal is to define expected
requests and provide "stub" responses:</p>
<pre class="programlisting">RestTemplate restTemplate = <span class="hl-keyword">new</span> RestTemplate();

MockRestServiceServer mockServer = MockRestServiceServer.createServer(restTemplate);
mockServer.expect(requestTo(<span class="hl-string">"/greeting"</span>)).andRespond(withSuccess(<span class="hl-string">"Hello world"</span>, MediaType.TEXT_PLAIN));

<span class="hl-comment">// use RestTemplate ...</span>

mockServer.verify();</pre>

<p>In the above example, <code class="literal">MockRestServiceServer</code>&#8201;&#8212;&#8201;the central class for client-side REST
tests&#8201;&#8212;&#8201;configures the <code class="literal">RestTemplate</code> with a custom <code class="literal">ClientHttpRequestFactory</code> that
asserts actual requests against expectations and returns "stub" responses. In this case
we expect a single request to "/greeting" and want to return a 200 response with
"text/plain" content. We could define as many additional requests and stub responses as
necessary.</p>
<p>Once expected requests and stub responses have been defined, the <code class="literal">RestTemplate</code> can be
used in client-side code as usual. At the end of the tests <code class="literal">mockServer.verify()</code> can be
used to verify that all expected requests were performed.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-client-static-imports" href="#spring-mvc-test-client-static-imports"></a>Static Imports</h5></div></div></div>

<p>Just like with server-side tests, the fluent API for client-side tests requires a few
static imports. Those are easy to find by searching <span class="emphasis"><em>"MockRest*"</em></span>. Eclipse users
should add <code class="literal">"MockRestRequestMatchers.*"</code> and <code class="literal">"MockRestResponseCreators.*"</code> as "favorite
static members" in the Eclipse preferences under <span class="emphasis"><em>Java &#8594; Editor &#8594; Content Assist &#8594;
Favorites</em></span>. That allows using content assist after typing the first character of the
static method name. Other IDEs (e.g. IntelliJ) may not require any additional
configuration. Just check the support for code completion on static members.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="spring-mvc-test-client-resources" href="#spring-mvc-test-client-resources"></a>Further Examples of Client-side REST Tests</h5></div></div></div>

<p>Spring MVC Test&#8217;s own tests include
<a class="ulink" href="https://github.com/spring-projects/spring-framework/tree/master/spring-test/src/test/java/org/springframework/test/web/client/samples" target="_top">example
tests</a> of client-side REST tests.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="testing-examples-petclinic" href="#testing-examples-petclinic"></a>10.15.7&nbsp;PetClinic Example</h3></div></div></div>

<p>The PetClinic application, available on
<a class="ulink" href="https://github.com/spring-projects/spring-petclinic" target="_top">GitHub</a>, illustrates several features
of the <span class="emphasis"><em>Spring TestContext Framework</em></span> in a JUnit environment. Most test functionality
is included in the <code class="literal">AbstractClinicTests</code>, for which a partial listing is shown below:</p>
<pre class="programlisting"><span class="hl-keyword">import</span> <span class="hl-keyword">static</span> org.junit.Assert.assertEquals;
<span class="hl-comment">// import ...</span>

<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractClinicTests <span class="strong"><strong>extends AbstractTransactionalJUnit4SpringContextTests</strong></span> {

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">protected</span> Clinic clinic;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> getVets() {
        Collection&lt;Vet&gt; vets = <span class="hl-keyword">this</span>.clinic.getVets();
        assertEquals(<span class="hl-string">"JDBC query must show the same number of vets"</span>,
            <span class="strong"><strong>super.countRowsInTable("VETS")</strong></span>, vets.size());
        Vet v1 = EntityUtils.getById(vets, Vet.<span class="hl-keyword">class</span>, <span class="hl-number">2</span>);
        assertEquals(<span class="hl-string">"Leary"</span>, v1.getLastName());
        assertEquals(<span class="hl-number">1</span>, v1.getNrOfSpecialties());
        assertEquals(<span class="hl-string">"radiology"</span>, (v1.getSpecialties().get(<span class="hl-number">0</span>)).getName());
        <span class="hl-comment">// ...</span>
    }

    <span class="hl-comment">// ...</span>
}</pre>

<p>Notes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
This test case extends the <code class="literal">AbstractTransactionalJUnit4SpringContextTests</code> class, from
which it inherits configuration for Dependency Injection (through the
<code class="literal">DependencyInjectionTestExecutionListener</code>) and transactional behavior (through the
<code class="literal">TransactionalTestExecutionListener</code>).
</li><li class="listitem">
The <code class="literal">clinic</code> instance variable&#8201;&#8212;&#8201;the application object being tested&#8201;&#8212;&#8201;is set by
Dependency Injection through <code class="literal">@Autowired</code> semantics.
</li><li class="listitem">
The <code class="literal">getVets()</code> method illustrates how you can use the inherited <code class="literal">countRowsInTable()</code>
method to easily verify the number of rows in a given table, thus verifying correct
behavior of the application code being tested. This allows for stronger tests and
lessens dependency on the exact test data. For example, you can add additional rows in
the database without breaking tests.
</li><li class="listitem">
Like many integration tests that use a database, most of the tests in
<code class="literal">AbstractClinicTests</code> depend on a minimum amount of data already in the database before
the test cases run. Alternatively, you might choose to populate the database within the
test fixture set up of your test cases&#8201;&#8212;&#8201;again, within the same transaction as the
tests.
</li></ul></div>

<p>The PetClinic application supports three data access technologies: JDBC, Hibernate, and
JPA. By declaring <code class="literal">@ContextConfiguration</code> without any specific resource locations, the
<code class="literal">AbstractClinicTests</code> class will have its application context loaded from the default
location, <code class="literal">AbstractClinicTests-context.xml</code>, which declares a common <code class="literal">DataSource</code>.
Subclasses specify additional context locations that must declare a
<code class="literal">PlatformTransactionManager</code> and a concrete implementation of <code class="literal">Clinic</code>.</p>
<p>For example, the Hibernate implementation of the PetClinic tests contains the following
implementation. For this example, <code class="literal">HibernateClinicTests</code> does not contain a single line
of code: we only need to declare <code class="literal">@ContextConfiguration</code>, and the tests are inherited
from <code class="literal">AbstractClinicTests</code>. Because <code class="literal">@ContextConfiguration</code> is declared without any
specific resource locations, the <span class="emphasis"><em>Spring TestContext Framework</em></span> loads an application
context from all the beans defined in <code class="literal">AbstractClinicTests-context.xml</code> (i.e., the
inherited locations) and <code class="literal">HibernateClinicTests-context.xml</code>, with
<code class="literal">HibernateClinicTests-context.xml</code> possibly overriding beans defined in
<code class="literal">AbstractClinicTests-context.xml</code>.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> HibernateClinicTests <span class="hl-keyword">extends</span> AbstractClinicTests { }</pre>

<p>In a large-scale application, the Spring configuration is often split across multiple
files. Consequently, configuration locations are typically specified in a common base
class for all application-specific integration tests. Such a base class may also add
useful instance variables&#8201;&#8212;&#8201;populated by Dependency Injection, naturally&#8201;&#8212;&#8201;such as a
<code class="literal">SessionFactory</code> in the case of an application using Hibernate.</p>
<p>As far as possible, you should have exactly the same Spring configuration files in your
integration tests as in the deployed environment. One likely point of difference
concerns database connection pooling and transaction infrastructure. If you are
deploying to a full-blown application server, you will probably use its connection pool
(available through JNDI) and JTA implementation. Thus in production you will use a
<code class="literal">JndiObjectFactoryBean</code> or <code class="literal">&lt;jee:jndi-lookup&gt;</code> for the <code class="literal">DataSource</code> and
<code class="literal">JtaTransactionManager</code>. JNDI and JTA will not be available in out-of-container
integration tests, so you should use a combination like the Commons DBCP
<code class="literal">BasicDataSource</code> and <code class="literal">DataSourceTransactionManager</code> or <code class="literal">HibernateTransactionManager</code>
for them. You can factor out this variant behavior into a single XML file, having the
choice between application server and a <span class="emphasis"><em>local</em></span> configuration separated from all other
configuration, which will not vary between the test and production environments. In
addition, it is advisable to use properties files for connection settings. See the
PetClinic application for an example.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-resources" href="#testing-resources"></a>10.16&nbsp;Further Resources</h2></div></div></div>

<p>Consult the following resources for more information about testing:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<a class="ulink" href="http://www.junit.org/" target="_top">JUnit</a>: "<span class="emphasis"><em>A programmer-oriented testing framework for Java</em></span>".
Used by the Spring Framework in its test suite.
</li><li class="listitem">
<a class="ulink" href="http://testng.org/" target="_top">TestNG</a>: A testing framework inspired by JUnit with added support
for annotations, test groups, data-driven testing, distributed testing, etc.
</li><li class="listitem">
<a class="ulink" href="http://www.mockobjects.com/" target="_top">MockObjects.com</a>: Web site dedicated to mock objects, a
technique for improving the design of code within test-driven development.
</li><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/Mock_Object" target="_top">"Mock Objects"</a>: Article in Wikipedia.
</li><li class="listitem">
<a class="ulink" href="http://www.easymock.org/" target="_top">EasyMock</a>: Java library " <span class="emphasis"><em>that provides Mock Objects for
interfaces (and objects through the class extension) by generating them on the fly
using Java&#8217;s proxy mechanism.</em></span> " Used by the Spring Framework in its test suite.
</li><li class="listitem">
<a class="ulink" href="http://www.jmock.org/" target="_top">JMock</a>: Library that supports test-driven development of Java
code with mock objects.
</li><li class="listitem">
<a class="ulink" href="http://mockito.org/" target="_top">Mockito</a>: Java mock library based on the
<a class="ulink" href="http://xunitpatterns.com/Test%20Spy.html" target="_top">test spy</a> pattern.
</li><li class="listitem">
<a class="ulink" href="http://dbunit.sourceforge.net/" target="_top">DbUnit</a>: JUnit extension (also usable with Ant and
Maven) targeted for database-driven projects that, among other things, puts your
database into a known state between test runs.
</li><li class="listitem">
<a class="ulink" href="http://grinder.sourceforge.net/" target="_top">The Grinder</a>: Java load testing framework.
</li></ul></div>

</div>
</div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="aop.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="spring-core.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="spring-data-tier.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">9.&nbsp;Aspect Oriented Programming with Spring&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Part&nbsp;IV.&nbsp;&#25968;&#25454;&#35775;&#38382;</td></tr></table></div></body></html>